// abc2svg - ABC to SVG translator
// @source: https://github.com/moinejf/abc2svg.git
// Copyright (C) 2014-2017 Jean-Francois Moine - LGPL3+
var abc2svg={version:"1.14.3",vdate:"2017-09-29"};
function Abc(R){function T(a){if(!a)return a;var d=new a.constructor,b;for(b in a)a.hasOwnProperty(b)&&(d[b]=a[b]);return d}function Hg(a,d,b,c){var e,f,g;if(R.errbld){switch(a){case 0:a="warn";break;case 1:a="error";break;default:a="fatal"}R.errbld(a,d,b,c)}else{if(void 0!=c&&0<=c){for(e=g=0;;){f=v.file.indexOf("\n",e);if(0>f||f>c)break;g++;e=f+1}e=c-e}c="";b&&(c=b,g&&(c+=":"+(g+1)+":"+(e+1)),c+=" ");switch(a){case 0:c+="Warning: ";break;case 1:c+="Error: ";break;default:c+="Internal bug: "}R.errmsg(c+
d,g,e)}}function X(a,d,b,c,e,f,g){var l;R.textrans&&(l=R.textrans[b])&&(b=l);3<arguments.length&&(b=b.replace(/\$./g,function(a){switch(a){case "$1":return c;case "$2":return e;case "$3":return f;default:return g}}));d&&d.ctx?Hg(a,b,d.ctx.fname,d.istart):Hg(a,b)}function hb(){this.index=0;hb.prototype["char"]=function(){return this.buffer[this.index]};hb.prototype.next_char=function(){return this.buffer[++this.index]};hb.prototype.get_int=function(){for(var a=0,d=this.buffer[this.index];"0"<=d&&"9">=
d;)a=10*a+Number(d),d=this.next_char();return a}}function y(a,d,b,c,e,f){X(a,{ctx:v.ctx,istart:v.istart+v.line.index},d,b,c,e,f)}function wa(a,d,b,c){a=r[a];var e=b/Ca*128|0;b=(b+c)/Ca*128|0;0>e&&(e=0);128<=b&&(b=127,e>b&&(e=b));if(d)for(d=a.top[e++];e<=b;)d<a.top[e]&&(d=a.top[e]),e++;else for(d=a.bot[e++];e<=b;)d>a.bot[e]&&(d=a.bot[e]),e++;return d}function ga(a,d,b,c,e){a=r[a];var f=b/Ca*128|0;b=(b+c)/Ca*128|0;0>f&&(f=0);128<=b&&(b=127,f>b&&(f=b));if(d)for(;f<=b;)a.top[f]<e&&(a.top[f]=e),f++;else for(;f<=
b;)a.bot[f]>e&&(a.bot[f]=e),f++}function Wf(a,d){switch(d){case 1:return!0;case 2:return!1}return a.multi&&0!=a.multi?0<a.multi:a.p_v.have_ly?1!=a.pos.voc:!1}function Ig(a){if(!a.ldst){var d,b,c,e,f,g=a.s,l=g.st,q=a.start.s,n=q.x;a.prev&&(n=a.prev.x+10,c=a.prev.y);a.st=l;if(4!=a.dd.func)switch(a.dd.glyph){case "8va":case "15ma":b=1;break;default:b=0<=g.multi}a.defl.noen?(e=a.x-n,20>e&&(n=a.x-20-3,e=20)):(e=g.x-n-6,8==g.type&&(e-=6),20>e&&(n-=.5*(20-e),e=20));d=a.dd;c||(c=wa(l,b,n,e));b?(f=r[q.st].topbar+
2,c<f&&(c=f)):(c-=d.h,f=r[q.st].botbar-2,c>f&&(c=f));a.lden=!1;a.has_val=!0;a.val=e;a.x=n;a.y=c;b&&(c+=d.h);ga(l,b,n,e,c);b?q.ymx=g.ymx=c:q.ymn=g.ymn=c}}function Jg(a){if(!a.ldst)if(a.start)Ig(a);else{var d,b,c=a.s,e=a.dd,f=c.x,g=e.wl+e.wr,l=r[c.st].topbar+2,q=r[c.st].botbar-2;c.nhd&&(f+=c.notes[0<=c.stem?0:c.nhd].shhd);d=-1;if(4==e.func)d=0;else if(c.pos)switch(c.pos.orn){case 1:d=1;break;case 2:d=0}switch(e.glyph){case "accent":case "roll":!d||0>d&&(0>c.multi||!c.multi&&0<c.stem)?(d=wa(c.st,!1,
c.x-e.wl,g),d>q&&(d=q),d-=e.h,ga(c.st,!1,c.x,0,d),b=!0,c.ymn=d):(d=wa(c.st,!0,c.x,0),d<l&&(d=l),ga(c.st,!0,c.x-e.wl,g,d+e.h),c.ymx=d+e.h);break;case "brth":case "lphr":case "mphr":case "sphr":d=l+1;"brth"==e.glyph&&d<c.ymx&&(d=c.ymx);for(c=c.ts_next;c&&!c.shrink;c=c.ts_next);f+=.4*((c?c.x:Ca)-f);break;default:0==e.name.indexOf("invert")&&(b=!0),"invertedfermata"!=e.name&&(0<d||0>d&&0<=c.multi)?(d=wa(c.st,!0,c.x-e.wl,g),d<l&&(d=l),ga(c.st,!0,c.x-e.wl,g,d+e.h),c.ymx=d+e.h):(d=wa(c.st,!1,c.x-e.wl,g),
d>q&&(d=q),d-=e.h,ga(c.st,!1,c.x-e.wl,g,d),"fermata"==e.name&&(b=!0),c.ymn=d)}b&&(d+=e.h,a.inv=!0);a.x=f;a.y=d}}function Kg(a,d){var b,c,e,f;if(b=d.match(/(\d+)\s+(.+?)\s+([0-9.]+)\s+([0-9.]+)\s+([0-9.]+)/)){e=Number(b[1]);f=parseFloat(b[3]);var g=parseFloat(b[4]),l=parseFloat(b[5]);if(isNaN(e))X(1,null,"%%deco: bad C function value '$1'",b[1]);else if((0>e||10<e)&&(32>e||41<e))X(1,null,"%%deco: bad C function index '$1'",e);else if(0>f||0>g||0>l)X(1,null,"%%deco: cannot have a negative value '$1'",
d);else if(50<f||80<g||80<l)X(1,null,"%%deco: abnormal h/wl/wr value '$1'",d);else{c=nd[a];c||(c={name:a},nd[a]=c);c.func=0==c.name.indexOf("head-")?9:e;c.glyph=b[2];c.h=f;c.wl=g;c.wr=l;if(b=d.replace(b[0],"").trim())'"'==b[0]&&(b=b.slice(1,-1)),c.str=b;6==c.func&&void 0==c.str&&(c.str=c.name);f=c.name.slice(-1);if("("==f||")"==f&&0>c.name.indexOf("("))if(e=c.name.slice(0,-1)+("("==f?")":"("),b=nd[e])"("==f?(c.dd_en=b,b.dd_st=c):(c.dd_st=b,b.dd_en=c);else if(b=kf(e),!b)return;return c}}else X(1,null,
"Invalid decoration '$1'",a)}function lf(a,d,b){var c,e,f,g,l=a.length;for(c=0;c<l;c++){e=a[c];f=nd[e];if(!f&&(f=kf(e),!f))continue;switch(f.func){case 0:if(0==d.type&&"dot"==f.name){d.bar_dotted=!0;break}case 1:case 2:if(!d.notes){X(1,d,"!$1! must be on a note or a rest",f.name);continue}break;case 8:if(8!=d.type){X(1,d,"!$1! must be on a note",f.name);continue}g=d.notes[d.nhd];g.a_dcn||(g.a_dcn=[]);g.a_dcn.push(f.name);continue;case 9:if(!d.notes){X(1,d,"!$1! must be on a note or rest",f.name);
continue}for(e=0;e<=d.nhd;e++)g=d.notes[e],g.a_dcn||(g.a_dcn=[]),g.a_dcn.push(f.name);continue;case 10:if(d.notes)for(e=0;e<=d.nhd;e++)d.notes[e].color=f.name;else d.color=f.name;continue;case 32:d.invis=!0;continue;case 33:if(0!=d.type){X(1,d,"!beamon! must be on a bar");continue}d.beam_on=!0;continue;case 34:if(8!=d.type||!b||8!=b.type){X(1,d,"!$1! must be on the last of a couple of notes",f.name);continue}d.trem2=!0;d.beam_end=!0;b.trem2=!0;b.beam_st=!0;d.ntrem=b.ntrem=Number(f.name[4]);d.nflags--;
b.nflags--;0<d.nflags?(d.nflags+=d.ntrem,b.nflags+=d.ntrem):(-2>=d.nflags&&(d.stemless=!0,b.stemless=!0),d.nflags=d.ntrem,b.nflags=d.ntrem);for(e=0;e<=d.nhd;e++)d.notes[e].dur*=2;for(e=0;e<=b.nhd;e++)b.notes[e].dur*=2;continue;case 35:if(8!=d.type){X(1,d,"!xstem! must be on a note");continue}d.xstem=!0;d.nflags=0;continue;case 36:if(8!=d.type){X(1,d,"!$1! must be on a note",f.name);continue}"1"==f.name[6]?d.beam_br1=!0:d.beam_br2=!0;continue;case 37:d.rbstop=1;continue;case 38:if(8!=d.type){X(1,d,
"!$1! must be on a note",f.name);continue}d.trem1=!0;d.ntrem=f.name.length;d.nflags=0<d.nflags?d.nflags+d.ntrem:d.ntrem;continue;case 39:if(8!=d.type){X(1,d,"!$1! must be on a note",f.name);continue}d.feathered_beam="a"==f.name[5]?1:-1;continue;case 40:d.stemless=!0;continue;case 41:d.rbstop=2;continue}d.a_dd||(d.a_dd=[]);d.a_dd.push(f)}}function kf(a){if(we&&we[a])return Kg(a,we[a]);if(Lg[a])return Kg(a,Lg[a]);k.decoerr&&X(1,null,"Unknown decoration '$1'",a)}function mf(a){var d,b,c=0,e=a.a_dd,f=
e.length;for(b=0;b<f;b++)switch(d=e[b],d.func){case 1:7>c&&(c=7);break;case 2:14>c&&(c=14)}0!=c&&a.prev&&0==a.prev.type&&(c-=3);return c}function mj(){function a(a){var b,c=a.x-a.wl,d=xa.length;for(a=0;a<d;a++)b=xa[a],b.ix=a,b.s.x=b.x=c,b.defl.nost=!0}function d(a){var b;if(a.a_dd){var c,d,e=a.a_dd.length;for(c=0;c<e;c++){b=a.a_dd[c];switch(b.func){default:d=0;break;case 3:case 4:case 5:if(Xf[b.name])if(d=b.name.slice(0,-1)+a.st.toString(),Bb[d]){if("("==b.name[b.name.length-1]){Bb[d]++;continue}Bb[d]--;
if(a.v+1!=Bb[d]>>8||!Bb[d])continue;Bb[d]&=255}else"("==b.name[b.name.length-1]&&(Bb[d]=1+(a.v+1<<8));d=a.pos.orn;break;case 6:d=a.pos.vol;break;case 7:d=a.pos.dyn}if(4!=d&&(d={s:a,dd:b,st:a.st,ix:xa.length,defl:{},x:a.x,y:a.y},xa.push(d),b.dd_en?d.ldst=!0:b.dd_st&&(d.lden=!0,d.defl.nost=!0),nj[b.func]))Ah[b.func](d)}}if(a.notes)for(b=0;b<a.notes.length;b++)if(a.notes[b].a_dcn){var n;d=a;for(var m=b,h=d.notes[m],p=h.a_dcn.length,e=0;e<p;e++){n=h.a_dcn[e];c=nd[n];if(!c&&(c=kf(n),!c))continue;switch(c.func){case 2:case 5:case 7:X(1,
null,"Cannot have !$1! on a head",c.name);continue;case 9:h.invis=!0;break;case 10:h.color=c.name;continue;case 32:h.invis=!0;continue}n={s:d,dd:c,st:d.st,m:m,ix:0,defl:{},x:d.x,y:3*(h.pit-18)};xa.push(n);c.dd_en?n.ldst=!0:c.dd_st&&(n.lden=!0,n.defl.nost=!0)}}}var b,c;for(b=Q;b;b=b.ts_next){switch(b.type){case 1:case 5:case 6:continue}break}for(0!=xa.length&&a(b);b;b=b.ts_next){switch(b.type){case 0:case 7:case 8:case 10:case 11:break;case 4:for(c=b.extra;c;c=c.next)d(c);default:continue}d(b)}(function(){var a,
b,c,d,q,n,m,h,p=xa.length;for(a=0;a<p;a++)if(c=xa[a],c.ldst){q=c.dd;n=q.dd_en;h=c.s;m=h.v;for(b=a+1;b<p&&(d=xa[b],d.start||d.dd!=n||d.s.v!=m);b++);if(b==p)for(m=h.st,b=a+1;b<p&&(d=xa[b],d.start||d.dd!=n||d.s.st!=m);b++);b==p&&(d={s:c.s,st:c.st,dd:n,ix:xa.length-1,x:Ca-6,y:c.s.y,lden:!0,defl:{noen:!0}},d.x<h.x+10&&(d.x=h.x+10),void 0!=c.m&&(d.m=c.m),xa.push(d));d.start=c;d.defl.nost=c.defl.nost;"trill("==q.name&&0<a&&"trill"==xa[a-1].dd.name&&(d.prev=xa[a-1])}for(a=0;a<p;a++)d=xa[a],d.lden&&!d.start&&
(h=d.s,c={s:bi(h),st:d.st,dd:d.dd.dd_st,ix:xa.length-1,y:h.y,ldst:!0},c.x=c.s.x,void 0!=d.m&&(c.m=d.m),xa.push(c),d.start=c)})()}function Yf(a,d,b,c,e){var f=od(a,c);a=f[0];var g=f[1],f=f[2];z.started&&(A.push("</g>\n"),z.started=!1);Z('<g transform="translate(X,Y) scale(F)">\n',d+4,b+2,e);switch(a){case 2:d="HD";break;case 1:d="Hd";break;default:d="hd"}ia(-fc,Da,d);d=4;if(g){b=9;0<f&&(b+=4);switch(a){case 4:b+=3;break;case 3:case 2:b+=2;break;case 1:b+=1}d=b*g;for(b-=fc;0<=--g;)ia(b,Da,"dot"),b+=
3.5}1536>c&&(0>=f?Vc(-fc,Da,21):(Vc(-fc,Da,21,!1,f),6>d&&(d=6)));A.push("\n</g>\n");return(d+15)*e}function Zf(a){var d=0;Na("tempo");a.tempo_str1&&(d=lb(a.tempo_str1));a.tempo_ca&&(d+=lb(a.tempo_ca));a.tempo_notes&&(d+=10*a.tempo_notes.length+6+uc(" ")*D.curfont.swfac*6+10);a.tempo_str2&&(d+=lb(a.tempo_str2));return d}function $f(a,d,b){var c,e=.6*D.curfont.size/15;Na("tempo");a.tempo_str1&&(ja(d,b,a.tempo_str1),d+=lb(a.tempo_str1)+3);if(a.tempo_notes){for(c=0;c<a.tempo_notes.length;c++)d+=Yf(a,
d,b,a.tempo_notes[c],e);ja(d,b,"=");d+=lb("= ");a.tempo_ca&&(ja(d,b,a.tempo_ca),d+=lb(a.tempo_ca));a.tempo?(ja(d,b,a.tempo.toString()),c=uc("0")*D.curfont.swfac,d+=c+5,10<=a.tempo&&(d+=c,100<=a.tempo&&(d+=c))):d+=Yf(a,d,b,a.new_beat,e)}a.tempo_str2&&ja(d,b,a.tempo_str2);a.del=!0}function oj(a,d,b,c){function e(a){return 6*Math.round((a+12)/6)-12-a}var f=a?3.5:5;a=a?1.8:3.2;if(0<d){d=c-(b-1)*f-a;if(26<d)return 0;b=c}else{b=c+(b-1)*f+a;if(-2>b)return 0;d=c}c=e(b-.25);d=e(d+.25);return c*c>d*d?d:c}function ag(a){var d,
b,c=T(a);c.invis=!0;delete c.text;delete c.a_gch;delete c.a_ly;delete c.a_dd;c.notes=T(a.notes);for(d=0;d<=c.nhd;d++)b=c.notes[d]=T(a.notes[d]),delete b.a_dcn;return c}function Mg(a,d){var b,c,e,f,g,l,q,n,m,h,p,u,t,w,v,y;d.beam_st||(b=ag(d),b.prev=d.prev,b.prev?b.prev.next=b:b.p_v.sym=b,d.prev=b,b.next=d,d.ts_prev.ts_next=b,b.ts_prev=d.ts_prev,d.ts_prev=b,b.ts_next=d,b.x-=12,b.x>d.prev.x+12&&(b.x=d.prev.x+12),b.beam_st=!0,delete b.beam_end,b.tmp=!0,delete b.slur_start,delete b.slur_end,d=b);e=f=0;
q=n=!1;g=d.st;l=d.v;p=d.grace?Id:3.5;for(c=d;8!=c.type||(c.nflags>f&&(f=c.nflags),e++,c.st!=g&&(q=!0),c.stem!=d.stem&&(n=!0),u||c.invis||c.stemless&&!c.trem2||(u=!0),!c.beam_end);c=c.next)if(!c.next){for(;8!=c.type;c=c.prev);b=ag(c);b.next=c.next;b.next&&(b.next.prev=b);c.next=b;b.prev=c;b.ts_next=c.ts_next;b.ts_next&&(b.ts_next.ts_prev=b);c.ts_next=b;b.ts_prev=c;delete b.beam_st;b.beam_end=!0;b.tmp=!0;delete b.slur_start;delete b.slur_end;b.x+=12;b.x<Ca-12&&(b.x=Ca-12);c=b;e++;break}if(!u)return!1;
a.s2=c;if(0==r[g].y){if(q)return!1}else if(!q)return a.s1=d,a.a=(d.ys-c.ys)/(d.xs-c.xs),a.b=d.ys-d.xs*a.a+r[g].y,a.nflags=f,!0;w=t=u=v=y=0;for(b=d;8!=b.type||(1==(h=b.p_v.scale)&&(h=r[b.st].staffscale),m=0<=b.stem?p+b.notes[0].shhd:-p+b.notes[b.nhd].shhd,m*=h,m+=b.x,b.xs=m,h=b.ys+r[b.st].y,w+=m,t+=h,u+=m*m,v+=m*h,y+=h*h,b!=c);b=b.next);p=(v*e-w*t)/(u*e-w*w);u=(t-p*w)/e;3<=e&&(b=y-p*v-u*t,0<b&&.5<b/(e-2)&&(p*=.6));p=0<=p?.8*p/(.8+p):.8*p/(.8-p);b=p*(c.xs-d.xs)/(20*(e-1));.0036>b*b&&(p=0);u=(t-p*w)/
e;k.flatbeams&&(u=(d.grace?35:-11)+r[g].y,p=0);e=0;b=d;if(n)m=.5*((d.grace?3.5:5)*(f-1)+3.2),m=d.stem!=c.stem&&d.nflags<c.nflags?m*c.stem:m*d.stem,u+=m;else if(d.grace)for(;m=p*b.xs+u-r[b.st].y,t=13,t=0<b.stem?t-(m-3*(b.notes[b.nhd].pit-18)):t+(m-3*(b.notes[0].pit-18)),t+=3*(b.nflags-1),t>e&&(e=t),b!=c;b=b.next);else{for(w=3.2+5*(f-1);b.ts_prev&&8==b.ts_prev.type&&b.ts_prev.time==b.time&&b.ts_prev.x>d.xs;)b=b.ts_prev;for(;b&&b.time<=c.time;b=b.ts_next)if(!(8!=b.type||b.invis||b.st!=g&&b.v!=l)){m=
b.v==l?b.xs:b.x;m=p*m+u-r[b.st].y;if(b.v==l)t=pj[0==b.nhd?0:1][b.nflags],0<b.stem?(26<b.notes[b.nhd].pit&&(t-=2,28<b.notes[b.nhd].pit&&(t-=2)),t-=m-3*(b.notes[b.nhd].pit-18)):(18>b.notes[0].pit&&(t-=2,16>b.notes[0].pit&&(t-=2)),t-=3*(b.notes[0].pit-18)-m),t+=3.2+5*(b.nflags-1);else{if(0<d.stem)if(0<b.stem){if(b.ymn>m+4||b.ymx<m-w-2)continue;t=b.v>l?b.ymx-m:b.ymn+8-m}else t=b.ymx-m;else if(0>b.stem){if(b.ymx<m-4||b.ymn>m-w-2)continue;t=b.v<l?m-b.ymn:m-b.ymx+8}else t=m-b.ymn;t+=2+w}t>e&&(e=t)}}0<e&&
(u+=d.stem*e);if(!q&&!n)for(b=d.next;;b=b.next){switch(b.type){case 10:if(l=b.ts_next,!l||l.st!=g||8!=l.type&&10!=l.type)break;case 0:if(b.invis)break;case 1:h=p*b.x+u;0<d.stem?(h=b.ymx-h+3.2+5*(f-1)+2,0<h&&(u+=h)):(h=b.ymn-h-3.2-5*(f-1)-2,0>h&&(u+=h));break;case 4:for(l=b.extra;l;l=l.next)h=p*l.x+u,0<d.stem?(h=l.ymx-h+3.2+5*(f-1)+2,0<h&&(u+=h)):(h=l.ymn-h-3.2-5*(f-1)-2,0>h&&(u+=h))}if(b==c)break}0==p&&(u+=oj(d.grace,d.stem,f,u-r[g].y));for(b=d;;b=b.next){switch(b.type){case 8:b.ys=p*b.xs+u-r[b.st].y;
0<b.stem?(b.ymx=b.ys+2.5,b.ts_prev&&0<b.ts_prev.stem&&b.ts_prev.st==b.st&&b.ts_prev.ymn<b.ymx&&b.ts_prev.x==b.x&&0==b.notes[0].shhd&&(b.ts_prev.x-=5,b.ts_prev.xs-=5)):b.ymn=b.ys-2.5;break;case 10:h=p*b.x+u-r[b.st].y;l=3.2+5*(f-1)+(0!=b.head?4:9);if(0<d.stem){if(h-=l,0==d.multi&&12<h&&(h=12),b.y<=h)break}else if(h+=l,0==d.multi&&12>h&&(h=12),b.y>=h)break;0!=b.head&&(h=6*((h+3+12)/6|0)-12);b.y=h}if(b==c)break}if(0==r[g].y)return!1;a.s1=d;a.a=p;a.b=u;a.nflags=f;return!0}function ci(a){function d(a,b,
c,d,e,f){var g=e.s1,l=g.nflags;g.ntrem&&(l-=g.ntrem);g.trem2&&f>l&&(768<=g.dur?(a=g.x+6,b=e.s2.x-6):384>g.dur&&(a+=5,b-=6));c=e.a*a+e.b-c;b=(b-a)/z.scale;e=e.a*b*z.scale;xe(a,c,!0);A.push("l"+b.toFixed(2)+" "+(-e).toFixed(2)+"v"+d.toFixed(2)+"l"+(-b).toFixed(2)+" "+e.toFixed(2)+'"/>\n')}var b,c,e,f,g,l,q,n,m,h,p,k,t=a.s1,w=a.s2;Tb(t,"beam");t.grace?(g=3.5,l=3.2,f=.29,q=1.8):(g=5,l=8,f=.34,q=3.2);e=t.stem;t.stem!=w.stem&&t.nflags<w.nflags&&(e=w.stem);0>e&&(q=-q);d(t.xs-f,w.xs+f,0,q,a,1);n=0;for(b=
t;8==b.type&&b.stem!=e&&(b.ys=a.a*b.xs+a.b-r[b.st].y+g*(b.nflags-1)*b.stem-q),b!=w;b=b.next);t.feathered_beam&&(n=g/(w.xs-t.xs),0<t.feathered_beam?(n=-n,g=n*t.xs):g=n*w.xs,n*=e);f=0;for(c=2;c<=a.nflags;c++)for(f+=g,0!=n&&(a.a+=n),b=t;;b=b.next){if(!(8!=b.type||b.nflags<c))if(b.trem1&&c>b.nflags-b.ntrem)k=768<=b.dur?b.x:b.xs,d(k-5,k+5,(f+2.5)*e,q,a,c);else{for(h=b;b!=w;){m=b.next;if(8==m.type||10==m.type)if(m.trem1){if(m.nflags-m.ntrem<c)break}else if(m.nflags<c)break;if(m.beam_br1||m.beam_br2&&2<
c)break;b=m}for(p=b;8!=p.type;)p=p.prev;k=h.xs;if(h==p)if(h==t)k+=l;else if(h==w)k-=l;else if(h.beam_br1||h.beam_br2&&2<c)k+=l;else{for(m=h.next;8!=m.type;)m=m.next;if(m.beam_br1||m.beam_br2&&2<c)k-=l;else{for(h=h.prev;8!=h.type;)h=h.prev;k=h.nflags<m.nflags||h.nflags==m.nflags&&h.dots<m.dots?k+l:k-l}}d(k,p.xs,f*e,q,a,c)}if(b==w)break}t.tmp?gc(t):w.tmp&&gc(w);Ub(t,"beam")}function bg(a){function d(a,b,c){for(var d,e;!B.st_print[b];){if(B.staves[b].flags&c)return;b++}for(d=e=b;;){B.st_print[d]&&(e=
d);if(B.staves[d].flags&c)break;d++}b=r[b].y+r[b].topbar*r[b].staffscale;e=r[e].y+r[e].botbar*r[e].staffscale;c&514?(c=e,b-=e,ce("brace"),a+=fc-6,c=Da-c,b/=24,A.push('<use transform="translate('+a.toFixed(2)+","+c.toFixed(2)+") scale(2.5,"+b.toFixed(2)+')" xlink:href="#brace"/>\n')):(a+=fc-5,c=Da-b-3,b=b-e+2,A.push('<path class="fill"\n\td="m'+a.toFixed(2)+" "+c.toFixed(2)+"\n\tc10.5 1 12 -4.5 12 -3.5c0 1 -3.5 5.5 -8.5 5.5\n\tv"+b.toFixed(2)+'\n\tc5 0 8.5 4.5 8.5 5.5c0 1 -1.5 -4.5 -12 -3.5"/>\n'))}
var b,c,e=B.nstaff,f=0;for(b=0;;b++){B.staves[b].flags&5&&f++;if(B.st_print[b])break;B.staves[b].flags&10&&f--;if(b==e)break}for(c=e;c>b&&!B.st_print[c];c--);if(b!=c||0!=f)for(c=r[c].y+r[c].botbar*r[c].staffscale,b=r[b].y+r[b].topbar*r[b].staffscale-c,xe(a,c),A.push("v"+(-b).toFixed(2)+'"/>\n'),b=0;b<=e;b++)B.staves[b].flags&1&&d(a,b,2),B.staves[b].flags&4&&d(a,b,8),B.staves[b].flags&256&&d(a-6,b,512),B.staves[b].flags&1024&&d(a-6,b,2048)}function Bh(a,d,b,c,e){if(c)if(c==e)b=-1==b?-2:2;else if(2*
c!=e){ia(a,d,"acc"+b+"_"+c+"_"+e);return}ia(a,d,"acc"+b)}function di(a,d,b,c,e){c=r[c];var f=c.y,g=6*(c.stafflines.length-1);for(d=6*Math.ceil(d/6);d<c.botline;d+=6)ia(a,f+d,e);for(b-=b%6;b>g;b-=6)ia(a,f+b,e)}function qj(a){switch(a){case "[":case "[]":return"";case "|:":case "|::":case "|:::":return"["+a;case ":|":case "::|":case ":::|":return a+"]";case "::":return k.dblrepbar;case "||:":return"[|:"}return a}function rj(a,d,b){var c,e,f=a.st,g=a.x;if(a.bar_mrep)if(e=r[f].y+12,de(a),1==a.bar_mrep){for(c=
a.prev;10!=c.type;c=c.prev);ia(c.x,e,"mrep")}else ia(g,e,"mrep2"),a.v==B.top_voice&&(Na("annotation"),ja(g,e+r[f].topbar-9,a.bar_mrep.toString(),"c"));0!=f&&a.ts_prev&&0!=a.ts_prev.type&&(b=r[f].topbar*r[f].staffscale);if(e=qj(a.bar_type))for(c=e.length;0<=--c;){switch(e[c]){case "|":hc(-1);var l=d,q=b;A.push('<path class="stroke" stroke-width="1" '+(a.bar_dotted?'stroke-dasharray="5,5" ':"")+'d="m'+(g+fc).toFixed(2)+" "+(Da-l).toFixed(2)+"v"+(-q).toFixed(2)+'"/>\n');break;default:g-=3;hc(-1);var l=
g,q=d,n=b,l=l+(fc+1.5),q=Da-q;A.push('<path class="stroke" stroke-width="3" d="m'+l.toFixed(2)+" "+q.toFixed(2)+"v"+(-n).toFixed(2)+'"/>\n');break;case ":":g-=2,hc(f),ia(g+1,r[f].y,"rdots")}g-=3}}function Ch(a,d){var b,c,e,f,g,l=Array(a.nhd+1);if(a.dots){for(g=0;g<=a.nhd;g++)c=3*(a.notes[g].pit-18),0==c%6&&(c=a.dot_low?c-3:c+3),l[g]=c;for(g=0;g<a.nhd;g++)if(!(l[g+1]>l[g])){for(c=g;0<c&&!(l[c]>l[c-1]+6);)c--;if(3*(a.notes[c].pit-18)-l[c]<l[g+1]-3*(a.notes[g+1].pit-18))for(;c<=g;)l[c++]-=6;else l[g+
1]=l[g]+6}}e=a.notes[0>a.stem?a.nhd:0];g=a.x+e.shhd;c=r[a.st].y;if(a.grace)f="ghl";else switch(a.head){default:f="hl";break;case 2:case 3:f="hl1";break;case 4:f="hl2"}di(g,3*(a.notes[0].pit-18),3*(a.notes[a.nhd].pit-18),a.st,f);e=r[a.st].y+3*(e.pit-18);a.stemless?a.xstem&&(b=a.ts_prev,f=(0<b.stem?b.y:b.ys)-a.y,f+=r[b.st].y-c,f/=a.p_v.scale,Vc(g,e,f)):(f=a.ys-a.y,b=a.nflags,a.ntrem&&(b-=a.ntrem),!d||0>=b?(0<a.nflags&&(f=0<=a.stem?f-1:f+1),Vc(g,e,f,a.grace)):Vc(g,e,f,a.grace,b,k.straightflags));if(d&&
a.trem1){e=a.ntrem||0;f=3*(a.notes[0<a.stem?a.nhd:0].pit-18);0==a.head||1==a.head?(g+=(a.grace?Id:3.5)*a.stem,f=0<a.stem?f+(6+5.4*e):f-11.4):f=0<a.stem?f+(5+5.4*e):f-10.4;f/=a.p_v.scale;for(Z('<path class="fill" d="mX Y\n\t',g-4.5,c+f);;){A.push("l9 -3v3l-9 3z");if(0>=--e)break;A.push("m0 5.4")}A.push('"/>\n')}g=a.x;for(c=0;c<=a.nhd;c++){var q,n,m;n=void 0;var h;e=g;b=a;q=c;var p=l,u=!1,t=b.notes[q],w=r[b.st].y;f=3*(t.pit-18);m=t.shhd*z.scale;var v=e+m,y=f+w,x=od(b,t.dur);h=x[0];x=x[1];0==f%6&&m!=
(0<b.stem?b.notes[0].shhd:b.notes[b.nhd].shhd)&&(m=0,30<=f?(m=f,m%6&&(m-=3)):-6>=f&&(m=f,m%6&&(m+=3)),m&&ia(v,m+w,"hl"));if(!t.invis)if(t.head)n=t.head;else if(b.grace)n="ghd",v-=4.5*z.scale;else if(t.map&&t.map[0])h=-b.nflags,0>h&&(h=0),(n=t.map[0][h])||(n=t.map[0][t.map[0].length-1]),h=n.indexOf("/"),0<=h&&(n=0<=b.stem?n.slice(0,h):n.slice(h+1));else if(2==b.type)n="custos";else switch(h){case 2:n="HD";break;case 3:if(4!=b.head){n="HDD";break}case 4:n=6144>t.dur?"breve":"longa";ic||!b.next||0!=
b.next.type||b.next.next||(x=0);break;case 1:n="Hd";break;default:n="hd"}t.color?u=pd(t.color):t.map&&t.map[2]&&(u=pd(t.map[2]));n&&(Ng(v,y,n)||ia(v,y,n));if(x)for(n=e+(7.7+b.xmx)*z.scale,void 0==p[q]&&(p[q]=3*(b.notes[q].pit-18),0==(b.notes[q].pit&1)&&(p[q]+=3)),q=p[q]+w;0<=--x;)ia(n,q,"dot"),n+=3.5;t.acc&&(e-=t.shac*z.scale,b.grace?(cg(e,f+w,0,.75),Bh(0,0,t.acc,t.micro_n,t.micro_d),dg()):Bh(e,f+w,t.acc,t.micro_n,t.micro_d));0!=u&&pd(u)}}function ei(a){var d=a;for(a=a.next;a;a=a.next){if(a.rbstop)return a;
d=a}return d}function bi(a){for(;a.prev;)if(a=a.prev,a.rbstart)return a;for(a=a.p_v.sym;1!=a.type;)a=a.ts_prev;a.next&&5==a.next.type&&(a=a.next);return a.next&&6==a.next.type?a.next:a}function fi(a,d,b,c,e,f,g){var l,q,h=.3;q=c-d;0>q&&(q=-q);l=b-a;40<l&&.7>q/l&&(h=.3+.002*(l-40),.7<h&&(h=.7));var m=.5*(a+b);l=.5*(d+c);var k,p;k=a+.45*(m+h*(a-m)-a);p=d+.45*(l+h*(d-l)+f-d);m=b+.45*(m+h*(b-m)-b);h=c+.45*(l+h*(c-l)+f-c);l=.03*(b-a);q=2*e;f=.2+.001*(b-a);.6<f&&(f=.6);f*=e;e=z.v?z.scale:1;g?A.push('<path class="stroke" stroke-dasharray="5,5" d="M'):
A.push('<path class="fill" d="M');vc(a," ",d);A.push("c"+((k-a)/z.scale).toFixed(2)+" "+((d-p)/e).toFixed(2)+" "+((m-a)/z.scale).toFixed(2)+" "+((d-h)/e).toFixed(2)+" "+((b-a)/z.scale).toFixed(2)+" "+((d-c)/e).toFixed(2));g||A.push("\n\tv"+(-f).toFixed(2)+"c"+((m-l-b)/z.scale).toFixed(2)+" "+((c+f-h-q)/e).toFixed(2)+" "+((k+l-b)/z.scale).toFixed(2)+" "+((c+f-p-q)/e).toFixed(2)+" "+((a-b)/z.scale).toFixed(2)+" "+((c+f-d)/e).toFixed(2));A.push('"/>\n')}function Og(a,d,b,c,e){for(var f=a,g,l,q,h,m,vb,
p,u,t;f.v!=d.v;)f=f.ts_next;switch(e&7){case 1:t=1;break;case 2:t=-1;break;default:a:{for(t=f;;){if(t.multi){t=t.multi;break a}if(t==d)break;t=t.next}t=0}if(!t)a:{var w;if(f.grace&&0<f.stem)t=-1;else{for(t=f;;t=t.next){if(8==t.type){if(!t.stemless){if(0>t.stem){t=1;break a}w=!0}22>t.notes[0].pit&&(q=!0)}if(t==d)break}t=w||q?-1:1}}}h=1;w=f.st;q=!1;if(f!=d)for(g=f.next;;){if(8==g.type||10==g.type)h++,g.st!=w&&(q=!0,g.st<w&&(w=g.st));if(g==d)break;g=g.next}q&&X(2,f,"*** multi-staves slurs not treated yet");
q=a.x;a.notes&&a.notes[0].shhd&&(q+=a.notes[0].shhd);if(a!=d)a=d.x,d.notes&&(a+=d.notes[0].shhd);else{for(g=d.ts_next;g&&12!=g.type;g=g.ts_next);a=g?g.x:Ca}0<=b?b=3*(f.notes[b].pit-18)+5*t:(b=0<t?f.ymx+2:f.ymn-2,8==f.type&&(0<t?0<f.stem&&(q+=5,f.beam_end&&-1<=f.nflags&&!f.in_tuplet&&(0<f.nflags?(q+=2,b=f.ys-3):b=f.ys-6)):0>f.stem&&(--q,d.grace?b=f.y-8:f.beam_end&&-1<=f.nflags&&(!f.in_tuplet||f.ys<b+3)&&(0<f.nflags?(q+=2,b=f.ys+3):b=f.ys+6))));0<=c?c=3*(d.notes[c].pit-18)+5*t:(c=0<t?d.ymx+2:d.ymn-
2,8==d.type&&(0<t?0<d.stem&&(a+=1,d.beam_st&&-1<=d.nflags&&!d.in_tuplet&&(c=d.ys-6)):0>d.stem&&(a-=5,d.beam_st&&-1<=d.nflags&&!d.in_tuplet&&(c=d.ys+6))));8!=f.type&&(b=c+1.2*t,q=f.x+.5*f.wr,q>a-12&&(q=a-12));8!=d.type&&(c=8==f.type?b+1.2*t:b,f!=d&&(a=d.x-.3*d.wl));3<=h&&(0!=f.next.type&&f.next.x<q+48&&(0<t?(p=f.next.ymx-2,b<p&&(b=p)):(p=f.next.ymn+2,b>p&&(b=p))),d.prev&&0!=d.prev.type&&d.prev.x>a-48&&(0<t?(p=d.prev.ymx-2,c<p&&(c=p)):(p=d.prev.ymn+2,c>p&&(c=p))));vb=(c-b)/(a-q);if(.5<vb||-.5>vb)vb=
.5<vb?.5:-.5,0<vb*t?b=c-vb*(a-q):c=b+vb*(a-q);p=c-b;8<p?p=8:-8>p&&(p=-8);g=p;0>g&&(g=-g);u=.5*g;g=.3*p;0<p*t?(a-=u,c-=g):(q+=u,b+=g);f.grace&&(q=f.x-.5*Id);d.grace&&(a=d.x+1.5*Id);u=0;vb=(c-b)/(a-q);if(f!=d&&f.v==d.v){m=b-vb*q;for(g=f.next;g!=d;g=g.next)if(g.st==w)switch(g.type){case 8:case 10:0<t?(p=3*(g.notes[g.nhd].pit-18)+6,p<g.ymx&&(p=g.ymx),p-=vb*g.x+m,p>u&&(u=p)):(p=3*(g.notes[0].pit-18)-6,p>g.ymn&&(p=g.ymn),p-=vb*g.x+m,p<u&&(u=p));break;case 4:for(l=g.extra;l;l=l.next)0<t?(p=3*(l.notes[l.nhd].pit-
18)+6,p<l.ymx&&(p=l.ymx),p-=vb*l.x+m,p>u&&(u=p)):(p=3*(l.notes[0].pit-18)-6,p>l.ymn&&(p=l.ymn),p-=vb*l.x+m,p<u&&(u=p))}b+=.45*u;c+=.45*u;u*=.65}h=3<h?(.08*(a-q)+12)*t:(.03*(a-q)+8)*t;0<t?(h<3*u&&(h=3*u),40<h&&(h=40)):(h>3*u&&(h=3*u),-40>h&&(h=-40));p=c-b;0>p&&(p=-p);0<t?h<.8*p&&(h=.8*p):h>-.8*p&&(h=-.8*p);h*=k.slurheight;fi(q,b,a,c,t,h,e&8);vb=(c-b)/(a-q);m=b-vb*q+.4*h;if(f.v==d.v)for(g=f;g!=d;g=g.next)g.st==w&&(p=vb*g.x+m,g.ymx<p?g.ymx=p:g.ymn>p&&(g.ymn=p),g.next==d?(u=a,d.sl1&&(u-=5)):u=g.next.x,
g!=f&&(q=g.x),u-=q,ga(w,0<t,q,u,p));return(0<t?1:2)|e&8}function Dh(a,d){for(var b,c,e,f,g,l,h,n=a;;){if(!n||n==d){if(!e||!(n=e.next)||n==d)break;e=null}if(4==n.type)e=n,n=n.extra;else if(8!=n.type&&10!=n.type&&11!=n.type||!n.slur_start&&!n.sl1)n=n.next;else{c=null;b=n.next;for(g=!1;;)if(b)if(4==b.type)f=b,b=b.extra;else{if(0==b.type&&(":"==b.bar_type[0]||"|]"==b.bar_type||"[|"==b.bar_type||b.text&&"1"!=b.text[0])){c=b;break}if(8==b.type||10==b.type||11==b.type){if(b.slur_end||b.sl2){c=b;break}if(b.slur_start||
b.sl1){if(f){for(c=b;c.next;c=c.next);if(c.next=f.next)f.next.prev=c;c=null}Dh(b,d);f&&f.next&&(f.next.prev.next=null,f.next.prev=f)}if(b==d)break}b=b.next}else if(f)b=f.next,f=null;else{if(!e||g)break;b=e.next;g=!0}if(!b)c=ei(n);else if(!c){n=b;if(n==d)break;continue}if(e){for(b=n;b.next;b=b.next);if(b.next=e.next)e.next.prev=b;e.slur_start=3}f&&(f.prev.next=f.extra,f.extra.prev=f.prev,f.slur_start=3);if(n.slur_start)l=n.slur_start&15,n.slur_start>>=4,b=-1;else{for(b=0;b<=n.nhd&&!n.notes[b].sl1;b++);
l=n.notes[b].sl1&15;n.notes[b].sl1>>=4;n.sl1--}g=-1;h=0;if(8!=c.type&&10!=c.type&&11!=c.type||!c.slur_end&&!c.sl2)0==c.type&&(":"==c.bar_type[0]||"|]"==c.bar_type||"[|"==c.bar_type||c.text&&"1"!=c.text[0])||(h=1);else if(c.slur_end)c.slur_end--;else{for(g=0;g<=c.nhd&&!c.notes[g].sl2;g++);c.notes[g].sl2--;c.sl2--}l=Og(n,c,b,g,l);h&&(c.p_v.slur_start||(c.p_v.slur_start=0),c.p_v.slur_start<<=4,c.p_v.slur_start+=l);e&&e.next&&(e.next.prev.next=null,e.next.prev=e);f&&(f.prev.next=f,f.extra.prev=null);
if(!n.slur_start&&!n.sl1){if(n==d)break;n=n.next}}}}function Eh(a,d){var b,c,e,f,g,l,h,n,m,k,p,u,t,w;f=a.st;for(b=a;b;b=b.next)if(8!=b.type&&10!=b.type){if(4==b.type)for(e=b.extra;e;e=e.next)if(e.slur_start||e.sl1)l=!0}else{if(b.slur_start||b.slur_end||b.sl1||b.sl2)l=!0;b.st<f&&(f=b.st);if(0==d){if(b.tp1&&Eh(b,1),b.te0)break}else if(b.te1)break}if(b){if(l){Dh(a,b);if(a.slur_start||a.sl1)return;for(c=a.next;c!=b;c=c.next)if(c.slur_start||c.slur_end||c.sl1||c.sl2)return;if(b.slur_end||b.sl2)return}0==
d?(l=a.tp0,a.tp0=0,w=a.tq0):(l=a.tp1,a.tp1=0,w=a.tq1);if(1!=a.tf[0]){(e=a.tf[3])||(e=0<a.stem?1:2);if(a==b)g=!0;else if(1==a.tf[1])g=!0,Og(a,b,-1,-1,e);else if(2==a.tf[0]||8!=a.type||8!=b.type)g=!1;else{g=!0;for(c=a;;c=c.next){if(8!=c.type&&10!=c.type){if(4==c.type||11==c.type)continue;g=!1;break}if(c==b)break;if(c.beam_end){g=!1;break}}if(g&&!a.beam_st&&!a.beam_br1&&!a.beam_br2)for(c=a.prev;c;c=c.prev)if(8==c.type||10==c.type){c.nflags>=a.nflags&&(g=!1);break}if(g&&!b.beam_end)for(c=b.next;c;c=c.next)if(8==
c.type||10==c.type){!c.beam_br1&&!c.beam_br2&&c.nflags>=b.nflags&&(g=!1);break}}if(g){if(1!=a.tf[2]){k=(b.x+a.x)/2;u=a==b?0:(b.ys-a.ys)/(b.x-a.x);g=a.ys-u*a.x;t=u*k+g;1==e?(p=wa(f,1,k-4,8),p>t&&(g+=p-t),g+=2):(p=wa(f,0,k-4,8),p<t&&(g+=p-t),g-=10);for(c=a;!(c.x>=k);c=c.next);0<a.stem*b.stem&&(k=0<a.stem?k+1.5:k-1.5);p=u*k+g;0==a.tf[2]?Jd(k,p,l):Jd(k,p,l+":"+w);1==e?(p+=10,c.ymx<p&&(c.ymx=p),ga(f,!0,k-3,6,p)):(c.ymn>p&&(c.ymn=p),ga(f,!1,k-3,6,p))}}else{0!=a.tf[1]&&X(2,a,"'what' value of %%tuplets not yet coded");
(e=a.tf[3])||(e=0<=a.multi?1:2);if(1==e){g=a.x-4;n=24;if(a.st==f){c=a;if(8!=c.type)for(c=c.next;c!=b&&8!=c.type;c=c.next);p=wa(f,1,c.x-4,8);p>n&&(n=p);0<a.stem&&(g+=3)}m=24;if(b.st==f){c=b;if(8!=c.type)for(c=c.prev;c!=a&&8!=c.type;c=c.prev);p=wa(f,1,c.x-4,8);p>m&&(m=p)}b.dur>b.prev.dur?h=b.next?b.next.x-b.next.wl-5:Ca-6:(h=b.x+4,c=0<=b.stem?0:b.nhd,0<b.notes[c].shhd&&(h+=b.notes[c].shhd),b.st==f&&0<b.stem&&(h+=3.5));k=.5*(g+h);p=.5*(n+m);u=(m-n)/(h-g);c=3*(b.notes[b.nhd].pit-a.notes[a.nhd].pit)/(h-
g);0<c?0>u?u=0:u>c&&(u=c):0<u?u=0:u<c&&(u=c);u*u<.1*.1&&(u=0);m=0;for(c=a;c.dur&&c.st==f&&(t=p+(c.x-k)*u,n=wa(f,1,c.x-4,8),n-t>m&&(m=n-t)),c!=b;c=c.next);p+=m+2;n=p+u*(g-k);m=p+u*(h-k);gi(g,n+4,h-g,m-n,!0);p+=8;for(c=a;;c=c.next)if(c.st==f){t=p+(c.x-k)*u;c.ymx<t&&(c.ymx=t);if(c==b)break;ga(f,!0,c.x,c.next.x-c.x,t)}else if(c==b)break}else{g=a.x-7;b.dur>b.prev.dur?h=b.next?b.next.x-b.next.wl-8:Ca-6:(h=b.x+2,0<b.notes[b.nhd].shhd&&(h+=b.notes[b.nhd].shhd));0<=a.stem&&(g+=2,h+=2);if(a.st==f){c=a;if(8!=
c.type)for(c=c.next;c!=b&&8!=c.type;c=c.next);n=wa(f,0,c.x-4,8)}else n=0;if(b.st==f){c=b;if(8!=c.type)for(c=c.prev;c!=a&&8!=c.type;c=c.prev);m=wa(f,0,c.x-4,8)}else m=0;k=.5*(g+h);p=.5*(n+m);u=(m-n)/(h-g);c=3*(b.notes[0].pit-a.notes[0].pit)/(h-g);0<c?0>u?u=0:u>c&&(u=c):0<u?u=0:u<c&&(u=c);u*u<.1*.1&&(u=0);m=0;for(c=a;c.dur&&c.st==f&&(t=p+(c.x-k)*u,n=wa(f,0,c.x-4,8),n-t<m&&(m=n-t)),c!=b;c=c.next);p+=m-10;n=p+u*(g-k);m=p+u*(h-k);gi(g,n+4,h-g,m-n);p-=2;for(c=a;;c=c.next){if(c.st==f){if(c==b)break;t=p+
(c.x-k)*u;c.ymn>t&&(c.ymn=t);ga(f,!1,c.x,c.next.x-c.x,t)}if(c==b)break}}1!=a.tf[2]&&(t=.5*(n+m),0==a.tf[2]?Jd(k,t,l,!0):Jd(k,t,l+":"+w,!0),1==e?ga(f,!0,k-3,6,t+9):ga(f,!1,k-3,6,t))}}}else X(1,a,"No end of tuplet in this music line"),0==d?a.tp0=0:a.tp1=0}function ye(a,d,b,c,e){var f,g,l,h,n,m,k,p,u;for(f=0;f<b.length;f++){l=b[f];n=a.notes[l].pit;h=c[f];m=2!=e?d.notes[h].pit:n;g=1==(a.notes[l].ti1&7)?1:-1;p=a.x;u=a.notes[l].shhd;0<g?l<a.nhd&&n+1==a.notes[l+1].pit&&a.notes[l+1].shhd>u&&(u=a.notes[l+
1].shhd):0<l&&n==a.notes[l-1].pit+1&&a.notes[l-1].shhd>u&&(u=a.notes[l-1].shhd);p+=.6*u;k=d.x;2!=e&&(u=d.notes[h].shhd,0<g?h<d.nhd&&m+1==d.notes[h+1].pit&&d.notes[h+1].shhd<u&&(u=d.notes[h+1].shhd):0<h&&m==d.notes[h-1].pit+1&&d.notes[h-1].shhd<u&&(u=d.notes[h-1].shhd),k+=.6*u);h=a.st;switch(e){case 0:n==m||n&1||(n=m);break;case 3:g=-g;case 1:p=a.x;p>k-20&&(p=k-20);n=m;h=d.st;break;default:if(a!=d)k-=d.wl,0==d.type&&(k+=5);else{m=a.time+a.dur;for(k=a.ts_next;k&&!(k.time>m);k=k.ts_next);k=k?k.x:Ca}k<
p+16&&(k=p+16)}20<k-p?(p+=3.5,k-=3.5):(p+=1.5,k-=1.5);m=3*(n-18);1!=e&&3!=e&&0<g&&(n&1||!a.dots||(m=3*(n-18)+6));n=(.04*(k-p)+10)*g;fi(p,r[h].y+m,k,r[h].y+m,g,n,a.notes[l].ti1&8)}}function Kd(a,d,b){var c,e,f,g,l=[],h=[],n=[],m=a.nhd,k=a.time+a.dur;if(2==b){for(c=0;c<=m;c++)a.notes[c].ti1&&n.push(c);ye(a,d||a,n,n,b)}else{for(c=0;c<=m;c++)if(a.notes[c].ti1){e=-1;g=a.notes[c].apit;for(f=d.nhd;0<=f;f--){switch(d.notes[f].apit-g){case 1:case -1:a.notes[c].acc!=d.notes[f].acc&&(e=f);default:continue;case 0:e=
f}break}0<=e?(l.push(c),h.push(e)):n.push(c)}ye(a,d,l,h,b);if(n.length){for(d=a.ts_next;d&&d.time<k;)d=d.ts_next;for(;d&&d.time==k;){if(8==d.type&&d.st==a.st){l.length=0;h.length=0;for(c=n.length;0<=--c;)for(e=n[c],g=a.notes[e].apit,f=d.nhd;0<=f;f--)if(d.notes[f].apit==g){l.push(e);h.push(f);n[c]=n.pop();break}if(0<l.length&&(ye(a,d,l,h,1==b?1:0),0==n.length))return}d=d.ts_next}0!=n.length&&X(1,a,"Bad tie")}}}function sj(a){var d,b,c;b=a.time+a.dur;c=a.st;for(d=a.ts_next;d;d=d.ts_next)if(d.st==c)if(d.time==
b){if(8==d.type)return d}else if(d.time>b)return a}function tj(a){function d(a,b,c){if(4==a.type)for(a=a.extra;a;a=a.next)a.ti1&&Kd(a,b,c);else Kd(a,b,c)}var b,c,e,f,g,l;for(b=a.sym;b;b=b.next){switch(b.type){case 1:case 5:case 6:continue}break}l=a.s_rtie;for(c=b;c&&!c.dur&&4!=c.type;c=c.next)0==c.type&&c.text&&("1"==c.text[0]?l=a.s_tie:a.s_tie=l);if(c){a.s_tie&&(a.s_tie.x=b.x+b.wr,b=a.s_tie,a.s_tie=null,b.st=c.st,b.ts_next=c.ts_next,b.time=c.time-b.dur,Kd(b,c,1));for(;;){for(b=c;b&&!b.ti1;b=b.next)if(l&&
0==b.type&&b.text)if("1"==b.text[0])l=null;else if("|"!=b.bar_type){for(c=b.next;c&&8!=c.type;c=c.next);if(!c){b=null;break}e=T(l);e.x=b.x;e.next=c;e.st=c.st;e.time=c.time-e.dur;Kd(e,c,1)}if(!b)break;g=b.time+b.dur;for(c=b.next;c&&!c.dur;c=c.next)if(c.text){if("1"!=c.text[0])break;l=b}if(c){if(8!=c.type&&0!=c.type){X(1,b,"Bad tie");continue}c.time!=g&&(c=sj(b))}else{for(c=b.ts_next;c;c=c.ts_next)if(c.st==b.st&&!(c.time<g)){if(c.time>g){c=null;break}if(c.dur)break}if(!c){d(b,null,2);a.s_tie=b;break}}for(e=
b.ts_next;e;e=e.ts_next)if(e.st==b.st){if(e.time>g)break;1==e.type&&(f=!0)}f||b.st!=c.st?(f=!1,g=.4*(c.x-b.x),e=c.x,c.x-=g,c.x>b.x+32&&(c.x=b.x+32),d(b,c,2),c.x=e,e=b.x,b.x+=g,b.x<c.x-24&&(b.x=c.x-24),Kd(b,c,3),b.x=e):d(b,c,8==c.type?0:2)}a.s_rtie=l}}function uj(a){var d,b,c,e,f,g=[];for(c=B.nstaff;0<=c&&!B.st_print[c];c--);if(!(0>c)){for(b=0;b<x.length;b++)if(d=x[b],d.sym&&(c=B.voices[b].st,B.st_print[c])){if(d.new_name){e=2;break}d.snm&&(e=1)}if(e){for(b=0;b<x.length;b++)if(d=x[b],d.sym&&(c=B.voices[b].st,
B.st_print[c]&&(d.new_name&&delete d.new_name,d=2==e?d.nm:d.snm))){if(B.staves[c].flags&512)for(;!(B.staves[c].flags&256);)c--;else if(B.staves[c].flags&2)for(;!(B.staves[c].flags&1);)c--;g[c]=g[c]?g[c]+("\\n"+d):d}if(0!=g.length)for(Na("voice"),a=.5*-a,c=0;c<g.length;c++)if(g[c]){e=g[c].split("\\n");f=r[c].y+.5*r[c].topbar*r[c].staffscale+9*(e.length-1)-.3*D.curfont.size;b=c;if(B.staves[c].flags&256)for(;!(B.staves[b].flags&512);)b++;else if(B.staves[c].flags&1)for(;!(B.staves[b].flags&2);)b++;b!=
c&&(f-=.5*(r[c].y-r[b].y));for(b=0;b<e.length;b++)d=e[b],ja(a,f,d,"c"),f-=18}}}}function vj(){var a,d,b,c,e,f,g,l,h;for(d=0;d<x.length;d++)h=x[d],1!=h.scale&&(h.scale_str='transform="scale('+h.scale.toFixed(2)+')"');for(d=0;d<=M&&!D.st_print[d];d++);c=0;if(d>M)d--,h=r[d];else for(h=r[d],a=0;128>a;a++)l=h.top[a],c<l&&(c=l);a=c;l=d;var n,m,v=0,p=0,u=r[l].topbar+12,t=0,w=1,y=0;for(g=Q;g;g=g.ts_next)14!=g.type||g.del||(e||(e=g),n=Zf(g),m=wa(l,!0,g.x-5,n)+2,m>u&&(u=m),y>=g.x-5&&!(t&w>>1)&&(t|=w),w<<=1,
y=g.x-5+n);if(e)for(Na("tempo"),p=D.curfont.size+2+2,m=2-p,f=m-p,0!=t&&(p*=2),c<u+p&&(v=u+p-c),g=e;g;g=g.ts_next)if(14==g.type&&!g.del){if(R.anno_start||R.anno_stop)g.wl=5,g.wr=40,g.ymn=t&1?f:m,g.ymx=g.ymn+14,Tb(g);$f(g,g.x-5,t&1?f:m);Ub(g);t>>=1}u=r[l].topbar+14;for(g=Q;g;g=g.ts_next)9==g.type&&(b||(b=g,Na("parts"),f=D.curfont.size+2+2),n=lb(g.text),m=wa(l,!0,g.x-10,n+3)+5,u<m&&(u=m));if(b)for(c<u+f+p&&(v=u+f+p-c),g=b;g;g=g.ts_next)if(9==g.type){g.x-=10;if(R.anno_start||R.anno_stop)n=lb(g.text),
g.wl=0,g.wr=n,g.ymn=-p-f,g.ymx=g.ymn+f,Tb(g);k.partsbox?Pg(g.x,2-p-f,g.text):ja(g.x,2-p-f,g.text);Ub(g)}c=a+v;if(!D.st_print[d])return c;c*=h.staffscale;e=.5*k.staffsep+h.topbar*h.staffscale;c<e&&(c=e);c<h.ann_top&&(c=h.ann_top);h.y=-c;b=d;f=B.staves[b];for(d++;d<=M;d++)if(h=r[d],D.st_print[d]){e=f.sep||k.sysstaffsep;g=f.maxsep||k.maxsysstaffsep;f=0;if(h.staffscale==r[b].staffscale){for(a=0;128>a;a++)l=h.top[a]-r[b].bot[a],f<l&&(f=l);f*=h.staffscale}else for(a=0;128>a;a++)l=h.top[a]*h.staffscale-
r[b].bot[a]*r[b].staffscale,f<l&&(f=l);e+=h.topbar*h.staffscale;f<e&&(f=e);g+=h.topbar*h.staffscale;f>g&&(f=g);c+=f;h.y=-c;b=d;f=B.staves[b]}for(a=e=0;128>a;a++)l=r[b].bot[a],e>l&&(e=l);e>h.ann_bot&&(e=h.ann_bot);e*=r[b].staffscale;for(d=0;d<=M;d++)h=r[d],f=h.y,1!=h.staffscale&&(h.scale_str='transform="translate(0,'+(Da-f).toFixed(2)+") scale("+h.staffscale.toFixed(2)+')"');if(0==e){for(d=M;0<=d&&!D.st_print[d];d--);if(0>d)return c}f=-e;e=.5*k.staffsep;f<e&&(f=e);g=.5*k.maxstaffsep;f>g&&(f=g);c+=
f;c>k.maxstaffsep&&(c=k.maxstaffsep);return c}function wj(a){function d(){var a,b,c,d=0;for(a=0;a<=B.nstaff;a++)0>h[a]?n[a]=m[a]=0:(b=r[a].staffscale,c=r[a].topbar*b,b*=r[a].botbar,0==d&&(d=r[a].y+c),n[a]=r[a].y+b,m[a]=d-n[a],d=B.staves[a].flags&64?0:n[a])}function b(a,b,c){var d,e=r[a].y,f=r[a].stafflines,g=f.length;for(d=0;d<g;d++){if("."!=f[d]){hc(a);a=(c-b)/z.scale;xe(b,e);A.push("h"+a.toFixed(2));e=0;for(d++;d<g;d++)e-=6,"."!=f[d]&&(A.push("m-"+a.toFixed(2)+" "+e+"h"+a.toFixed(2)),e=0);A.push('"/>\n');
break}e+=6}}var c,e,f,g,l,h=[],n=[],m=[];uj(a);for(c=0;c<=M;c++)h[c]=B.st_print[c]?0:-1;d();bg(0);for(a=Q;a;a=a.ts_next){if(l&&a.time!=l){for(c=l=0;c<=M;c++)B.st_print[c]||(h[c]=-1);d()}switch(a.type){case 12:g=!1;for(c=a.ts_next;c&&c.time==a.time;c=c.ts_next){switch(c.type){case 0:case 1:case 5:case 6:g=c.x;continue}break}c||(g=Ca);B=a.sy;for(c=0;c<=M;c++)e=h[c],0>e?B.st_print[c]&&(h[c]=0==a.ts_next.type?a.x:a.x-a.wl-2):B.st_print[c]||(g?(f=g,l=a.time):(f=a.x-a.wl-2,h[c]=-1),b(c,e,f));d();continue;
case 0:c=a.st;if(a.second||a.invis||0>h[c])break;Tb(a);rj(a,n[c],m[c]);Ub(a);break;case 13:if(0==B.voices[a.v].range&&14<a.xmx){for(g=f=0;g<x.length;g++)0<B.voices[g].range&&f++;for(c=a.ts_next;c&&13==c.type;c=c.ts_next)f--;0==f&&bg(a.x)}if(c=a.prev){f=c.x;0!=c.type&&(f+=c.wr);c=a.st;e=h[c];if(0<=e){if(e>=f)continue;b(c,e,f)}h[c]=a.x}}}for(c=0;c<=M;c++)if(!l||B.st_print[c])e=h[c],0>e||e>=Ca||b(c,e,Ca)}function eg(a){return!a||!a.match(/^(0|n|f)/i)}function fg(a){a=parseInt(a);isNaN(a)&&(y(1,"Bad integer value"),
a=1);return a}function ab(a,d){var b,c,e,f,g;if("-"==a[a.length-2]){c=a[a.length-1];if("1">c||"9"<c)return;a="u"+c+"font"}(c=k[a])&&(b=wc[c])&&(e=b.name+"."+b.size);f=d.split(/\s+/);c=f[0];"*"==c&&b?c=b.name:(c=c.replace("Times-Roman","serif"),c=c.replace("Times","serif"),c=c.replace("Helvetica","sans-serif"),c=c.replace("Courier","monospace"));1<f.length?(g=f[f.length-1],"*"==g&&b&&(g=b.size)):b&&(g=b.size);g&&(f=c+"."+g,f!=e&&(b=wc[f],b||((b=hi[c])||(b=1.1),b={name:c,size:Number(g),swfac:g*b},wc[f]=
b),k[a]=f))}function Wc(a){var d=parseFloat(a);switch(a.slice(-2)){case "CM":case "cm":d*=28.35;break;case "IN":case "in":d*=72}return d}function ii(a){var d=parseFloat(a);switch(a.slice(-2)){case "CM":case "cm":d*=37.8;break;case "IN":case "in":d*=96}return d}function ji(a,d){void 0==qd[d]?y(1,xc,a):(a=a.slice(0,3),"ste"==a&&(a="stm"),h&&(h.pos=T(h.pos)),yc(a,d,"pos"))}function yc(a,d,b){h?b?h[b][a]=qd[d]:h[a]=d:(a=[a+"=",d],L.V||(L.V={}),L.V["*"]?Array.prototype.push.apply(L.V["*"],a):L.V["*"]=
a)}function Qg(a,d,b){var c,e;if(b)ki[a]=!0;else if(ki[a])return;if(a.match(/.+font$/)||a.match(/.+font-[\d]$/))switch(" box"==d.slice(-4)&&(e=!0,d=d.slice(0,-4)),ab(a,d),a){case "gchordfont":k.gchordbox=e;break;case "measurefont":k.measurebox=e;break;case "partsfont":k.partsbox=e}else switch(a){case "aligncomposer":case "barsperstaff":case "infoline":case "measurefirst":case "measurenb":case "rbmax":case "rbmin":case "shiftunison":case "staffnonote":k[a]=fg(d);break;case "microscale":c=fg(d);if(isNaN(c)||
4>c||256<c||c%1){y(1,xc,"%%"+a);break}yc("uscale",c);break;case "bgcolor":case "dblrepbar":case "titleformat":k[a]=d;break;case "breaklimit":case "lineskipfac":case "maxshrink":case "pagescale":case "parskipfac":case "scale":case "slurheight":case "stemheight":case "stretchlast":c=parseFloat(d);if(isNaN(c)){y(1,xc,"%%"+a);break}"scale"==a?c/=.75:"pagescale"==a&&(a="scale");k[a]=c;break;case "bstemdown":case "breakoneoln":case "cancelkey":case "custos":case "decoerr":case "dynalign":case "flatbeams":case "gchordbox":case "graceslurs":case "graceword":case "hyphencont":case "keywarn":case "linewarn":case "measurebox":case "partsbox":case "rbdbstop":case "singleline":case "squarebreve":case "straightflags":case "stretchstaff":case "timewarn":case "titlecaps":case "titleleft":case "titletrim":k[a]=
eg(d);break;case "composerspace":case "indent":case "infospace":case "maxstaffsep":case "maxsysstaffsep":case "musicspace":case "partsspace":case "staffsep":case "subtitlespace":case "sysstaffsep":case "textspace":case "titlespace":case "topspace":case "vocalspace":case "wordsspace":k[a]=Wc(d);break;case "leftmargin":case "pagewidth":case "rightmargin":case "print-leftmargin":k[a]=ii(d);break;case "concert-score":k.sound="concert";break;case "contbarnb":k.contbarnb=fg(d);break;case "writefields":d=
d.split(/\s+/);if(eg(d[1]))for(a=0;a<d[0].length;a++)c=d[0][a],0>k.writefields.indexOf(c)&&(k.writefields+=c);else for(a=0;a<d[0].length;a++)c=d[0][a],0<=k.writefields.indexOf(c)&&(k.writefields=k.writefields.replace(c,""));break;case "dynamic":case "gchord":case "gstemdir":case "ornament":case "stemdir":case "vocal":case "volume":ji(a,d);break;case "font":a=d.split(/\s+/);if(!(1>=a.length))if(d=parseFloat(a[a.length-1]),isNaN(d)||0>=a)y(1,"Bad scale value in %%font");else for(c in hi[a[0]]=d,wc)wc.hasOwnProperty(c)&&
(b=wc[c],b.name==a[0]&&(b.swfac=b.size*d));break;case "fullsvg":if(0!=v.state){y(1,"Cannot have %%fullsvg inside a tune");break}k[a]=d;break;case "gracespace":k[a]=d.split(/\s+/);break;case "tuplets":k[a]=d.split(/\s+/);(d=k[a][3])&&qd[d]&&(k[a][3]=qd[d]);break;case "infoname":a:{c=d;a=k.infoname.split("\n");d=c[0];for(b=0;b<a.length;b++)if(a[b][0]==d){1==c.length?a.splice(b,1):a[b]=c;k.infoname=a.join("\n");break a}k.infoname+="\n"+c}break;case "notespacingfactor":c=parseFloat(d);if(isNaN(c)||1>
c||2<c){y(1,xc,"%%"+a);break}d=5;for(a=jc[d];0<=--d;)a/=c,jc[d]=a;d=5;for(a=jc[d];++d<jc.length;)a*=c,jc[d]=a;break;case "play":k.sound="play";break;case "pos":a=d.split(/\s+/);ji(a[0],a[1]);break;case "sounding-score":k.sound="sounding";break;case "staffwidth":d=ii(d);if(100>d){y(1,"%%staffwidth too small");break}d=k.pagewidth-d-k.leftmargin;2>d?y(1,"%%staffwidth too big"):k.rightmargin=d;break;case "textoption":k[a]=gg[d];break;case "combinevoices":case "voicecombine":d=parseInt(d);if(isNaN(d)){y(1,
xc,"%%"+a);break}if(h&&"combinevoices"==a){for(c=0;c<x.length;c++)x[c].combine=d;break}yc("combine",d);break;case "voicemap":yc("map",d);break;case "voicescale":d=parseFloat(d);if(isNaN(d)||.6>d||1.5<d){y(1,xc,"%%"+a);break}yc("scale",d);break;default:0==v.state&&(k[a]=d)}}function li(a){var d=a.split("."),b=d[1],c=a.indexOf("Italic"),e=100,f=a.indexOf("Oblique"),g=a.indexOf("Bold");a=d[0];d="font:";0<g&&(d+="bold ",e=g);if(0<c||0<f)0<c&&(d+="italic ",c<e&&(e=c)),0<f&&(d+="oblique ",f<e&&(e=f));100!=
e&&("-"==a[e-1]&&e--,a=a.slice(0,e));return d+b+"px "+a}function mi(a){hg[a.fid]||(hg[a.fid]=!0,ze+="\n.f"+a.fid+k.fullsvg+" {"+li(a.name+"."+a.size)+"}")}function Xc(a){a+="font";var d=wc[k[a]];d||(y(1,"Unknown font $1",a),d=D.curfont);d.fid||(d.fid=xj++);mi(d);return d}function zc(a){var d,b,c="",e;for(d=0;;){e=a.indexOf("\\",d);if(0>e)break;c+=a.slice(d,e);d=a[++e];if(!d)return c+"\\";switch(d){case "0":case "2":if("0"==a[e+1])switch(a[e+2]){case "1":c+="\u266f";d=e+3;continue;case "2":c+="\u266d";
d=e+3;continue;case "3":c+="\u266e";d=e+3;continue;case "4":c+="&#x1d12a;";d=e+3;continue;case "5":c+="&#x1d12b;";d=e+3;continue}case "1":case "3":if("0"<=a[e+1]&&"7">=a[e+1]&&"0"<=a[e+2]&&"7">=a[e+2]){d=parseInt(a.slice(e,e+3),8);c+=String.fromCharCode(d);d=e+3;continue}break;case "u":b=[];d=parseInt(a.slice(e+1,e+5),16);b.push(d);55296<=d&&57343>=d?(d=parseInt(a.slice(e+7,e+11),16),b.push(d),d=e+11):d=e+5;c+=String.fromCharCode.apply(null,b);continue;case "t":c+=" ";d=e+1;continue;default:if(b=
yj[a.slice(e,e+2)]){c+=b;d=e+2;continue}}c+="\\"+d;d=e+1}return c+a.slice(d)}function zj(a){var d,b;R.read_file?2<Ae?y(1,"Too many include levels"):(Ae++,(d=R.read_file(a))?(".js"==a.slice(-3)?eval(d):(b=T(v),ni(a,d),v=b),Ae--):y(1,"Cannot read file '$1'",a)):y(1,"No read_file support")}function ni(a,d){function b(){var a,b=d.indexOf("K:",g);if(0>b)return!1;b=d.indexOf("\n",b);if(v.select.test(d.slice(g,b)))return!0;a=/\n\w*\n/;a.lastIndex=b;l=a.exec(d)?a.lastIndex:R;return!1}function c(a,b){var c,
d,e;b&&0<=a.indexOf("\\")&&(a=zc(a));e=a.length;for(c=0;c<e;c++){d=a[c];switch(d){case "\\":c++;continue;case "%":return a.slice(0,c).replace(/\s+$/,"");case '"':break;default:continue}for(c+=1;;){c=a.indexOf('"',c);if(0>c)break;if("\\"!=a[c-1])break}if(0>c)break}a=a.replace(/\s+$/,"");return a.replace(/\\%/g,"%")}function e(){oi();L.W&&Aj(L.W);var a,b,c,d,e,f,g=k.infoname.split("\n"),h=g.length;for(a=0;a<h;a++)if(c=g[a][0],!(0>k.writefields.indexOf(c))&&(c=L[c])){d||(d=!0,Na("history"),la(k.textspace),
e=D.curfont.size*k.lineskipfac);b=g[a].slice(2);'"'==b[0]&&(b=b.slice(1,-1));la(e);ja(0,0,b);f=lb(b);c=c.split("\n");ja(f,0,c[0]);for(b=1;b<c.length;b++)la(e),ja(f,0,c[b]);la(.3*e);Cb()}Cb();Yc();v.state=0;k=w;rd();L=x;wb=B;oa=A;kc=z;Zc=E;$c=M;pi()}var f,g,l,h,n,m,r,p,u,t,w,x,B,A,z,E,M,I,Q="\n",R=d.length;v.file=d;v.ctx={fname:a};for(g=g=0;g<R;g=v.eol+1){l=d.indexOf("\n",g);0>l&&(l=R);for(v.eol=l;;){l--;switch(d[l]){case " ":case "\t":continue}break}l++;if(r){if(l!=g)continue;r=!1}if(l==g)1==v.state?
(v.istart=g,y(1,"Empty line in tune header - ignored")):2<=v.state&&e();else{v.istart=v.bol=g;v.iend=l;v.line.index=0;m=d[g];n=d[g+1];if("%"==m){if(0>v.prefix.indexOf(n))continue;"a"==d[g+2]&&"b"==d[g+3]&&"c"==d[g+4]&&" "==d[g+5]?(g+=6,m=d[g],n=d[g+1]):I=!0}else"I"==m&&":"==n&&(I=!0);if(I){I=!1;for(g+=2;;){switch(d[g]){case " ":case "\t":g++;continue}break}if((h=d.slice(g,l))&&"%"!=h[0]){t=h.split(/\s+/,2);t[0]||t.shift();switch(t[0]){case "abcm2ps":case "ss-pref":v.prefix=t[1];continue;case "abc-include":n=
t[1].match(/.*\.(.*)/);if(!n)continue;switch(n[1]){case "abc":case "js":zj(t[1])}continue}if(u=t[0].match(/begin(.*)/))h="\n"+m+n+"end"+u[1],f=d.indexOf(h,l),0>f?(y(1,"No $1 after %%$2",h.slice(1),u[0]),v.eol=R):(Bj(u[1],t[1],d.slice(l+1,f).replace(new RegExp("^"+m+n,"gm"),"")),v.eol=d.indexOf("\n",f+6),0>v.eol&&(v.eol=R));else{switch(t[0]){case "select":if(0!=v.state){y(1,"%%select ignored");continue}m=c(h.slice(7).trim(),!1);'"'==m[0]&&(m=m.slice(1,-1));m=m.replace(/\(/g,"\\(");m=m.replace(/\)/g,
"\\)");v.select=new RegExp(m,"m");continue;case "tune":y(1,"%%tune not treated yet");continue;case "voice":if(0!=v.state){y(1,"%%voice ignored");continue}m=c(h.slice(6).trim(),!1);if(!m){v.cur_tune_opts?v.cur_tune_opts.voice_opts=null:v.voice_opts=null;continue}if("end"==m)continue;v.cur_tune_opts?(v.cur_tune_opts.voice_opts||(v.cur_tune_opts.voice_opts={}),u=v.cur_tune_opts.voice_opts):(v.voice_opts||(v.voice_opts={}),u=v.voice_opts);for(u[m]=[];;){g=++l;if("%"!=d[g])break;l=d.indexOf("\n",l);if(d[g+
1]==n){g+=2;h=0>l?d.slice(g):d.slice(g,l);t=h.match(/\S+/);switch(t[0]){default:u[m].push(c(h.trim(),!0));continue;case "score":case "staves":case "tune":case "voice":g-=2}break}}v.eol=g-1;continue}Be(c(h.trim(),!0))}}}else if(":"!=n)p=void 0,2>v.state||(v.line.buffer=d.slice(g,l),qi());else{h=c(d.slice(g+2,l).trim(),!0);if("+"==m){if(!p){y(1,"+: without previous info field");continue}Q=" ";m=p}switch(m){case "X":if(0!=v.state){y(1,nf,m);continue}if(v.select&&!b()){r=!0;continue}w=T(k);k.pos=T(k.pos);
x=T(L);if(L.V)for(f in x.V={},L.V)L.V.hasOwnProperty(f)&&(x.V[f]=T(L.V[f]));B=T(wb);A=T(oa);z=kc;E=T(Zc);M=new Int8Array(128);for(f=0;128>f;f++)M[f]=$c[f];L.X=h;v.state=1;continue;case "T":switch(v.state){case 0:continue;case 1:L.T=void 0==L.T?h:L.T+("\n"+h);continue}t=mb("title");t.text=h;continue;case "K":switch(v.state){case 0:continue;case 1:L.K=h}Ld(m,h);continue;case "W":if(0==v.state||0>k.writefields.indexOf(m))break;L.W=void 0==L.W?h:L.W+(Q+h);break;case "m":if(2<=v.state){y(1,nf,m);continue}if((!k.sound||
"play"!=k.sound)&&0>k.writefields.indexOf(m))break;t=h.match(/(.*?)[= ]+(.*)/);if(!t||!t[2]){y(1,xc,"m:");continue}Zc[t[1]]=t[2];$c[t[1].charCodeAt(0)]=1;break;case "s":if(3!=v.state||0>k.writefields.indexOf(m))break;Cj(h," "==Q);break;case "w":if(3!=v.state||0>k.writefields.indexOf(m))break;Dj(h," "==Q);if("\\"==h.slice(-1)){Q=" ";p=m;continue}break;case "|":if(2>v.state)continue;v.line.buffer=d.slice(g,l);qi();continue;default:if(0<="ABCDFGHOSZ".indexOf(m)){if(2<=v.state){y(1,nf,m);continue}L[m]=
L[m]?L[m]+(Q+h):h}else{Ld(m,h);continue}}Q="\n";p=m}}}Ae||(2<=v.state&&e(),Yc(),v.state=0)}function ri(a){var d,b,c,e,f,g=a.stem;e=a.nhd;if(0!=e){f=.78*si[a.head];a.grace&&(f*=.5);0<=g?(d=1,b=e+1,e=a.notes[0].pit):(f=-f,d=e-1,b=-1,e=a.notes[e].pit);for(var h=!1,k=0;d!=b;d+=g){c=a.notes[d].pit-e;e=a.notes[d].pit;if(0==c){if(h){c=a.notes[d].shhd=a.notes[d-g].shhd+f;k<c&&(k=c);continue}if(d+g!=b&&e+g==a.notes[d+g].pit){a.notes[d].shhd=-f;k<-f&&(k=-f);continue}}0>c&&(c=-c);if(3<c||2<=c&&4!=a.head)h=!1;
else if(h=!h)a.notes[d].shhd=f,k<f&&(k=f)}a.xmx=k}}function ti(a,d){var b,c,e,f,g,h,k=a.length;for(b=k-1;0<=--b;)if((e=a[b].shhd)&&!(0<e))for(e=d-e,g=a[b].pit,c=k;0<=--c;)if(a[c].acc){f=a[c].pit;if(f<g-3)break;!(f>g+3)&&a[c].shac<e&&(a[c].shac=e)}for(b=k;0<=--b;)if(h=a[b].acc){e=a[b].shac;e||(e=a[b].shhd,e=0>e?d-e:d);g=a[b].pit;for(c=k;--c>b;)a[c].acc&&(f=a[c].pit,!(f>=g+4&&(f>g+4||0>h||0>a[c].acc))&&e>a[c].shac-6&&(f=a[c].shac+7,f>e&&(e=f)));a[b].shac=e}}function gc(a){a.next&&(a.next.prev=a.prev);
a.prev?a.prev.next=a.next:a.p_v.sym=a.next;a.ts_next&&(a.seqst&&(a.ts_next.seqst=!0,a.ts_next.shrink<a.shrink&&(a.ts_next.shrink=a.shrink),a.ts_next.space<a.space&&(a.ts_next.space=a.space)),a.ts_next.ts_prev=a.ts_prev);a.ts_prev&&(a.ts_prev.ts_next=a.ts_next);Q==a&&(Q=a.ts_next);ic==a&&(ic=a.ts_next)}function Rg(a){var d,b=a.ts_next;if(!b||8!=b.type&&10!=b.type||b.v==a.v||b.st!=a.st||b.time!=a.time||b.dur!=a.dur||0>=a.combine&&b.type!=a.type||a.a_gch&&b.a_gch)return!1;if(10==a.type)return a.type==
b.type&&a.invis&&!b.invis?!1:!0;if(b.a_ly||b.sl1||b.sl2||b.slur_start||b.slur_end||b.beam_st!=a.beam_st||b.beam_end!=a.beam_end)return!1;d=b.nhd;return 1>=a.combine&&a.notes[0].pit<=b.notes[d].pit+1?!1:!0}function Fh(a){for(var d;;){d=a.ts_next;if(a.type!=d.type)10!=d.type&&(d=a,a=d.ts_next);else if(10==a.type)a.invis&&!d.invis&&delete a.invis;else{var b,c,e=a;e.notes=e.notes.concat(d.notes);e.nhd=c=e.notes.length-1;Gh(e);if(3<=e.combine){for(b=c;0<b;b--)e.notes[b].pit==e.notes[b-1].pit&&e.notes[b].acc==
e.notes[b-1].acc&&e.notes.splice(b,1);e.nhd=c=e.notes.length-1}e.ymx=3*(e.notes[c].pit-18)+4;e.ymn=3*(e.notes[0].pit-18)-4;e.yav=(e.ymx+e.ymn)/2;b=e.notes[0].ti1;3==(b&15)&&(e.notes[0].ti1=2|b&-9);b=e.notes[c].ti1;3==(b&15)&&(e.notes[c].ti1=1|b&-9)}d.text&&(a.text=d.text);d.a_gch&&(a.a_gch=d.a_gch);d.a_dd&&(a.a_dd=a.a_dd?a.a_dd.concat(d.a_dd):d.a_dd);gc(d);if(a.in_tuplet||!Rg(a))break}}function ui(a,d,b){var c=a.p_v,e=a.st;0==a.type&&a.prev&&0==a.prev.type&&(a=a.prev);c.last_sym=a.prev;c.last_sym||
(c.sym=null);c.time=a.time;c=Md(c,1);c.next=a;a.prev=c;c.clef_type=d;c.clef_line=b;c.st=e;c.clef_small=!0;delete c.second;c.notes=[];c.notes[0]={pit:a.notes[0].pit};for(c.nhd=0;!a.seqst;)a=a.ts_prev;1!=a.ts_prev.type&&(c.seqst=!0);c.ts_prev=a.ts_prev;c.ts_prev.ts_next=c;c.ts_next=a;return a.ts_prev=c}function vi(a,d,b){var c,e,f,g=0,h=0,k=0,n=0;for(f=0;f<a.a_gch.length;f++)switch(c=a.a_gch[f],c.type){default:e=-c.x;e>g&&(g=e);c=c.w+2-e;c>h&&(h=c);break;case "<":c=c.w+d;c>k&&(k=c);break;case ">":c=
c.w+a.wr,c>n&&(n=c)}if(d=a.prev){if(d.a_gch)for(d=a.ts_prev;;d=d.ts_prev){if(d==a.prev){b<g&&(b=g);break}d.seqst&&(g-=d.shrink)}0!=k&&b<k&&(b=k)}if(d=a.next){if(d.a_gch)for(d=a.ts_next;;d=d.ts_next){if(d==a.next){a.wr<h&&(a.wr=h);break}d.seqst&&(h-=8)}0!=n&&a.wr<n&&(a.wr=k)}return b}function of(a){var d,b,c,e;switch(a.type){case 8:case 10:a.wr=e=Ej[a.head];0<a.xmx&&(a.wr+=a.xmx+4);if(d=a.prev)switch(d.type){case 0:case 1:case 5:case 6:e+=3}for(b=0;b<=a.nhd;b++)c=a.notes[b].shhd,0>c&&e<-c+5&&(e=-c+
5),a.notes[b].acc&&(c=a.notes[b].shac+(a.notes[b].micro?6.5:4.5),e<c&&(e=c));if(d)switch(d.type){case 0:case 1:case 5:case 6:e-=3}a.a_dd&&(e+=mf(a));a.beam_st&&a.beam_end&&0<a.stem&&0<a.nflags&&a.wr<a.xmx+9&&(a.wr=a.xmx+9);if(0<a.dots){switch(a.head){case 4:case 3:case 2:a.xmx+=2;break;case 1:a.xmx+=1}a.wr<a.xmx+12&&(a.wr=a.xmx+12);2<=a.dots&&(a.wr+=3.5*(a.dots-1))}a.trem2&&a.beam_end&&20>e&&(e=20);b=e;if(d)switch(d.type){case 8:0<d.stem&&0>a.stem&&7>b&&(b=7);(27<a.y&&27<d.y||-3>a.y&&-3>d.y)&&6>b&&
(b=6);d.ti1&&14>b&&(b=14);break;case 1:if(d.second||d.clef_small)break;b+=8;break;case 5:b+=4}a.a_gch&&(b=vi(a,e,b));a.a_ly&&(b=wi(a,b));a.wl=d&&4==d.type?e-4.5:b;return;case 11:c=a.width/2;a.wr=c;a.a_gch&&(c=vi(a,c,c));a.a_dd&&(c+=mf(a));a.wl=c;return;case 0:if(a.norepbra)break;if(a.invis)a.wl=a.wr=0;else{e=a.bar_type;switch(e){case "|":d=8;break;case "|:":case ":|":d=16;break;case "::":d=24;break;default:if(e)for(d=5+3*e.length,b=0;b<e.length;b++)switch(e[b]){case "[":case "]":d+=3;break;case ":":d+=
2}}a.wl=d;a.wr=a.next&&6!=a.next.type?8:5;a.prev&&4==a.prev.type&&(a.wl-=8)}a.a_dd&&(a.wl+=mf(a));a.text&&4>a.text.length&&a.next&&a.next.a_gch&&(Na("repeat"),a.wr+=lb(a.text)+2);return;case 1:a.wl=a.wr=a.clef_small?9:12;return;case 5:var f;a.wl=3;f=4;if(a.k_a_acc){e=c=a.k_a_acc.length;var g=a.k_a_acc[0].acc;for(b=1;b<c;b++)d=a.k_a_acc[b],d.pit>a.k_a_acc[b-1].pit+6||d.pit<a.k_a_acc[b-1].pit-6?e--:d.acc!=g&&(f+=3),g=d.acc}else e=a.k_sf,c=a.k_old_sf&&(k.cancelkey||0==e)?a.k_old_sf:0,0<=e*c?(0>e&&(e=
-e),0>c&&(c=-c),c>e&&(e=c)):(e-=c,0>e&&(e=-e),f+=3);a.wr=5.5*e+f;return;case 6:for(b=d=0;b<a.a_meter.length;b++)e=a.a_meter[b],d="C|"==e.top?d+6.5:!e.bot||e.top.length>e.bot.length?d+6.5*e.top.length:d+6.5*e.bot.length;a.wl=d;a.wr=d+7;return;case 7:a.wl=6;a.wr=66;return;case 4:var h,q;d=Number(k.gracespace[0]);e=Number(k.gracespace[1]);c=Number(k.gracespace[2]);f=0;g=a.extra;for(g.beam_st=!0;;g=g.next){ri(g);ti(g.notes,7);q=0;for(h=g.nhd;0<=h;h--)g.notes[h].shac>q&&(q=g.notes[h].shac);f+=q;g.x=f;
0>=g.nflags&&(g.beam_st=!0,g.beam_end=!0);h=g.next;if(!h){g.beam_end=!0;break}0>=h.nflags&&(g.beam_end=!0);g.beam_end&&(h.beam_st=!0,f+=e/4);0>=g.nflags&&(f+=e/4);g.y>h.y+8&&(f-=1.5);f+=e}f+=d+c;(h=a.next)&&8==h.type&&(g.y>=3*(h.notes[h.nhd].pit-18)?--f:g.beam_st&&g.y<3*(h.notes[0].pit-18)-7&&(f+=2));a.wl=f;a.wr=0;a.a_ly&&wi(a,b);return;case 13:a.wl=a.xmx;a.next&&1==a.next.type?(a.wr=2,delete a.next.clef_small):a.wr=8;return;case 16:case 9:case 17:case 12:case 14:break;default:X(2,a,"set_width - Cannot set width for symbol $1",
a.type)}a.wl=a.wr=0}function Nd(a){var d,b,c,e=a.ts_prev.time,f=a.time-e;if(0==f){switch(a.type){case 7:return a.wl}return 0}if(7==a.ts_prev.type)return 71;768<=pf&&(f=1536<=pf?f/4:f/2);d=384<=f?768>f?5:1536>f?6:3072>f?7:6144>f?8:9:192<=f?4:96<=f?3:48<=f?2:24<=f?1:0;b=f-(12<<d);c=jc[d];0!=b&&(0>b?c=jc[0]*f/12:(9<=d&&(d=8),c+=(jc[d+1]-jc[d])*b/f));for(;!a.dur;){switch(a.type){case 0:return.9*c-7;case 1:return c-a.wl;case 16:case 9:case 17:case 12:case 14:a=a.ts_next;if(!a)return 0;continue}break}a.beam_st||
(c*=.9);if(8==a.type&&-1<=a.nflags&&0<a.stem){b=!0;for(d=a.ts_prev;d&&d.time==e;d=d.ts_prev)if(8==d.type&&(-1>d.nflags||0<d.stem)){b=!1;break}if(b){for(d=a.ts_next;d&&d.time==a.time;d=d.ts_next)if(8==d.type&&(-1>d.nflags||0>d.stem)){b=!1;break}b&&(c*=.9)}}return c}function Hh(a){for(var d,b=Q,c=0,e=[];;){var f=c,g=b;do of(b),d=(e[b.st]||0)+b.wl,d>f&&(f=d),b=b.ts_next;while(b!=a&&!b.seqst);g.shrink=f-c;g.space=g.ts_prev?Nd(g):0;0==g.shrink&&0==g.space&&1==g.type&&(delete g.seqst,g.time=g.ts_prev.time);
if(b==a)break;c=f;b=g;do{if(!e[b.st]||e[b.st]<c+b.wr)e[b.st]=c+b.wr;b=b.ts_next}while(!b.seqst)}if(!a){c=0;for(b=g;;b=b.ts_next){if(0==b.type)return;b.wr>c&&(c=b.wr);if(!b.ts_next)break}b.wr>c&&(c=b.wr);g={type:0,bar_type:"|",ctx:b.ctx,istart:b.istart,iend:b.iend,v:b.v,p_v:b.p_v,st:b.st,dur:0,seqst:!0,invis:!0};g.prev=g.ts_prev=b;b.ts_next=b.next=g;g.time=b.time+b.dur;g.shrink=c;b.eoln=!1;g.space=Nd(g)}}function Sg(a){a.type=10;delete a.in_tuplet;delete a.sl1;delete a.sl2;delete a.a_dd;delete a.a_gch;
a.slur_start=a.slur_end=0}function Ih(a){function d(a){if(k.custos&&1==x.length)a:{for(var b,c,d=a;8!=d.type;)if(d=d.next,!d)break a;b=a.p_v;b.last_sym=a.prev;b.time=a.time;b=Md(b,2);b.next=a;a.prev=b;b.ts_prev=a.ts_prev;b.ts_prev.ts_next=b;b.ts_next=a;a.ts_prev=b;b.seqst=!0;b.wl=8;b.wr=4;b.shrink=a.shrink;12>b.shrink&&(b.shrink=12);b.space=d.space;b.nhd=d.nhd;b.notes=[];for(c=0;c<a.notes.length;c++)b.notes[c]={pit:d.notes[c].pit,shhd:0,dur:384};b.stemless=!0}a.nl=!0}function b(a){for(a=a.ts_next;a;a=
a.ts_next)if(a.seqst){d(a);break}return a}var c;if(a.eoln&&!k.keywarn&&!k.timewarn)return b(a);switch(a.type){case 1:case 0:case 12:break;case 5:if(k.keywarn&&!a.k_none)break;return b(a);case 6:if(k.timewarn)break;return b(a);case 4:if(a=a.next,!a)return a;default:return b(a)}for(;a;a=a.ts_prev)if(a.seqst){switch(a.type){case 5:case 1:case 6:continue}break}for(c=0;;a=a.ts_next){if(!a)return a;if(a.seqst){if(0>c)break;switch(a.type){case 12:for(;a.ts_next&&1==a.ts_next.type;)a=a.ts_next;if(!a.ts_next||
0!=a.ts_next.type)continue;a=a.ts_next;case 0:if(c)break;c=1;continue;case 13:a.stbrk_forced?c=-1:gc(a);continue;case 6:if(!k.timewarn)break;continue;case 1:if(c)break;continue;case 5:if(!k.keywarn||a.k_none)break;continue;default:if(!c||a.prev&&4==a.prev.type)continue}break}}d(a);return a}function xi(){var a,d,b=x.length;for(a=0;a<b&&(d=x[a],!d.clef);a++);of(d.clef);of(d.key);if(!k.singleline)return d.clef.wl+d.clef.wr+d.key.wl+d.key.wr;of(d.meter);return d.clef.wl+d.clef.wr+d.key.wl+d.key.wr+d.meter.wl+
d.meter.wr}function yi(a,d){var b,c,e,f=0,g=1-k.maxshrink;for(b=a;b!=d;b=b.ts_next)b.seqst&&(b.x=f,c=b.shrink,f=(e=b.space)<c?f+c:f+(c*k.maxshrink+e*g));return f}function ig(a){switch(a.type){case 1:if(a.second||a.invis){a.ymx=a.ymn=12;break}a.y=6*(a.clef_line-1);switch(a.clef_type){default:a.ymx=a.y+28;a.ymn=a.y-14;break;case "c":a.ymx=a.y+13;a.ymn=a.y-11;break;case "b":a.ymx=a.y+7,a.ymn=a.y-12}a.clef_small&&(a.ymx-=2,a.ymn+=2);26>a.ymx&&(a.ymx=26);-1<a.ymn&&(a.ymn=-1);a.clef_octave&&(0<a.clef_octave?
a.ymx+=12:a.ymn-=12);break;case 5:a.ymx=2<a.k_sf?34:0<a.k_sf?30:26;a.ymn=-2;break;default:a.ymx=26,a.ymn=-2}}function Jh(a,d,b){var c,e,f,g;f=12;e=20;for(c=d;c&&(12!=c.type||c==d);c=c.ts_next)if(c.st==a)if(8!=c.type){if(1==c.type){if("a"!=c.clef_type)break;gc(c)}}else c.notes[0].pit<e?e=c.notes[0].pit:c.notes[c.nhd].pit>f&&(f=c.notes[c.nhd].pit);if(19<=e||13<=e&&"b"!=b)return"t";if(13>=f||19>=f&&"t"!=b)return"b";"a"==b&&(b=16<=(f+e)/2?"t":"b");f=b;var h=c,k=null;for(c=d;c!=h&&(12!=c.type||c==d);c=
c.ts_next)if(c.st==a&&8==c.type){g=c.time;if("t"==f){if(12<c.notes[0].pit||20<c.notes[c.nhd].pit){20<c.notes[0].pit&&(k=c);continue}if((e=c.ts_prev)&&e.time==g&&e.st==a&&8==e.type&&19<=e.notes[0].pit)continue;if((e=c.ts_next)&&e.st==a&&e.time==g&&8==e.type&&19<=e.notes[0].pit)continue}else{if(12>c.notes[0].pit||20>c.notes[c.nhd].pit){12>c.notes[c.nhd].pit&&(k=c);continue}if((e=c.ts_prev)&&e.time==g&&e.st==a&&8==e.type&&13>=e.notes[0].pit)continue;if((e=c.ts_next)&&e.st==a&&e.time==g&&8==e.type&&13>=
e.notes[0].pit)continue}if(k){g=c;for(e=c.ts_prev;e!=k;e=e.ts_prev)if(e.st==a){if(0==e.type&&e.v==c.v){g=e;break}8==e.type&&e.beam_st&&!e.p_v.second&&(g=e)}g.time==k.time?k=c:(k=c,f="t"==f?"b":"t",e=ui(g,f,"t"==f?2:4),e.clef_auto=!0)}else f=b="t"==f?"b":"t",k=c}return b}function zi(a){var d,b,c,e,f,g=1536,h=Array(M);for(b=0;b<=M;b++)d=r[b].clef,h[b]=Ai[d.clef_type]+2*d.clef_line,k.sound?d.clef_octave&&!d.clef_oct_transp&&(h[b]+=d.clef_octave):d.clef_oct_transp&&(h[b]-=d.clef_octave);for(d=Q;d!=a;d=
d.ts_next)switch(b=d.st,d.type){case 1:h[b]=Ai[d.clef_type]+2*d.clef_line;k.sound?d.clef_octave&&!d.clef_oct_transp&&(h[b]+=d.clef_octave):d.clef_oct_transp&&(h[b]-=d.clef_octave);ig(d);break;case 4:for(b=d.extra;b;b=b.next){c=h[b.st];if(0!=c&&!d.p_v.key.k_drum)for(e=0;e<=b.nhd;e++)f=b.notes[e],f.pit+=c;b.ymn=3*(b.notes[0].pit-18)-2;b.ymx=3*(b.notes[b.nhd].pit-18)+2}ig(d);break;case 5:d.k_y_clef=h[b];default:ig(d);break;case 7:if(d.invis)break;d.y=12;d.ymx=39;d.ymn=-2;break;case 10:if(1==x.length){d.y=
12;d.ymx=24;d.ymn=0;break}case 8:c=h[b];if(0!=c&&!d.p_v.key.k_drum)for(e=d.nhd;0<=e;e--)d.notes[e].pit+=c;8==d.type?(d.ymx=3*(d.notes[d.nhd].pit-18)+4,d.ymn=3*(d.notes[0].pit-18)-4,d.yav=(d.ymx+d.ymn)/2):(d.y=6*((d.notes[0].pit-18)/2|0),d.ymx=d.y+Bi[5-d.nflags][0],d.ymn=d.y-Bi[5-d.nflags][1]);d.dur<g&&(g=d.dur)}pf=g}function Ce(a,d,b){var c={type:a,ctx:b.ctx,v:d.v,p_v:d,st:d.st,time:b.time,next:d.last_sym.next};c.next&&(c.next.prev=c);d.last_sym.next=c;c.prev=d.last_sym;d.last_sym=c;c.ts_next=b;c.ts_prev=
b.ts_prev;c.ts_prev.ts_next=c;c.ts_prev.type!=a&&(c.seqst=!0);b.ts_prev=c;b.type==a&&c.v!=b.v&&(delete b.seqst,b.shrink=0);return c}function Fj(){var a,d,b,c,e,f=x.length;for(e=0;e<f;e++)if(!(0>B.voices[e].range)){a=x[e];a.second=B.voices[e].second;for(b=B.voices[e].st;b<M&&!B.st_print[b];)b++;a.st=b}for(c=Q;1==c.type;)e=c.v,0<=B.voices[e].range&&!B.voices[e].second&&(delete c.clef_small,a=c.p_v,a.last_sym=a.sym=c),c=c.ts_next;for(e=0;e<f;e++)a=x[e],a.sym&&1==a.sym.type||0>B.voices[e].range||B.voices[e].second&&
!a.bar_start||(b=B.voices[e].st,r[b]&&r[b].clef&&(d=T(r[b].clef),d.v=e,d.p_v=a,d.st=b,d.time=c.time,d.prev=null,d.next=a.sym,d.next&&(d.next.prev=d),a.sym=d,a.last_sym=d,d.ts_next=c,d.ts_prev=c.ts_prev,d.ts_prev?(d.ts_prev.ts_next=d,delete d.seqst):(Q=d,d.seqst=!0),c.ts_prev=d,1==c.type&&delete c.seqst,delete d.clef_small,d.second=B.voices[e].second,B.st_print[b]||(d.invis=!0)));for(e=0;e<f;e++)if(!(0>B.voices[e].range||B.voices[e].second)&&B.st_print[B.voices[e].st])if(a=x[e],c.v==e&&5==c.type)a.last_sym=
c,c.k_old_sf=c.k_sf,c=c.ts_next;else if(b=a.key,b.k_sf||b.k_a_acc)d=Ce(5,a,c),d.k_sf=b.k_sf,d.k_old_sf=b.k_sf,d.k_none=b.k_none,d.k_a_acc=b.k_a_acc,d.istart=b.istart,d.iend=b.iend,b.k_bagpipe&&(d.k_bagpipe=b.k_bagpipe,"p"==d.k_bagpipe&&(d.k_old_sf=3));if(De&1){for(e=0;e<f;e++)a=x[e],b=a.meter,0>B.voices[e].range||B.voices[e].second||!B.st_print[B.voices[e].st]||0==b.a_meter.length||(c.v==e&&6==c.type?(a.last_sym=c,c=c.ts_next):(d=Ce(6,a,c),d.istart=b.istart,d.iend=b.iend,d.wmeasure=b.wmeasure,d.a_meter=
b.a_meter));De&=-2}for(e=0;e<f;e++)if(a=x[e],b=a.bar_start)a.bar_start=null,0>B.voices[e].range||!B.st_print[B.voices[e].st]||(c.v==e&&0==c.type?(a.last_sym=c,c=c.ts_next):(d=Ce(0,a,c),d.istart=b.istart,d.iend=b.iend,d.bar_type=b.bar_type,b.invis&&(d.invis=!0),b.norepbra&&(d.norepbra=!0),d.text=b.text,d.a_gch=b.a_gch,b.rbstart&&(d.rbstart=b.rbstart)));zi(c);for(d=c;d;d=d.ts_next)if(d.seqst){for(d=d.ts_next;d&&!d.seqst;d=d.ts_next);break}Hh(d)}function Ci(){var a,d,b,c,e,f=x.length,g=0;for(a=0;a<f;a++)if(d=
x[a],!(0>B.voices[a].range)&&(b=d.new_name?d.nm:d.snm))for(e||(e=Xc("voice"),D.curfont=D.deffont=e),d=0;;){c=b.indexOf("\\n",d);d=0>c?lb(b.slice(d)):lb(b.slice(d,c));d>g&&(g=d);if(0>c)break;d=c+1}e&&(g+=4*uc(" ")*e.swfac);for(a=d=0;a<=B.nstaff;a++){if(B.staves[a].flags&1280){d=16;break}B.staves[a].flags&5&&(d=8)}g+=d;De&2&&(g+=k.indent);return g}function Gj(a,d){var b,c,e,f,g,h,k,n,m;if(a.shiftunison&&3<=a.shiftunison||1536<=(e=a.dur)||1536<=(f=d.dur)||a.stemless&&d.stemless||a.dots!=d.dots&&(a.shiftunison&&
a.shiftunison&1||0!=a.dots*d.dots)||0<a.stem*d.stem)return!1;b=c=0;if(a.notes[0].pit>d.notes[0].pit){if(0>a.stem)return!1;for(;d.notes[c].pit!=a.notes[0].pit;)if(++c>d.nhd)return!1}else if(a.notes[0].pit<d.notes[0].pit){if(0>d.stem)return!1;for(;d.notes[0].pit!=a.notes[b].pit;)if(++b>a.nhd)return!1}if(d.notes[c].acc!=a.notes[b].acc)return!1;g=b;k=c;n=a.notes[b].shhd;m=d.notes[c].shhd;do{b++;c++;if(b>a.nhd)break;if(c>d.nhd)break;if(d.notes[c].acc!=a.notes[b].acc)return!1;n<a.notes[b].shhd&&(n=a.notes[b].shhd);
m<d.notes[c].shhd&&(m=d.notes[c].shhd)}while(d.notes[c].pit==a.notes[b].pit);if(b<=a.nhd){if(c<=d.nhd||0<d.stem)return!1}else if(c<=d.nhd&&0<a.stem)return!1;h=b;b=c;c=0;if(e!=f)if(e<f&&(e=f,f=a.dur),768>e)0<d.dots?c=2:0<a.dots&&(c=1);else if(384>f){if(a.shiftunison&&a.shiftunison&2)return!1;c=768<=d.dur?2:1}else return!1;0==c&&(c=a.p_v.scale<d.p_v.scale?2:1);if(1==c){for(c=k;c<b;c++)d.notes[c].invis=!0,delete d.notes[c].acc;for(c=0;c<=d.nhd;c++)d.notes[c].shhd+=n}else{for(b=g;b<h;b++)a.notes[b].invis=
!0,delete a.notes[b].acc;for(b=0;b<=a.nhd;b++)a.notes[b].shhd+=m}return!0}function Kh(a){var d,b,c,e=Tg[a.head],f=e,g=[];for(b=0;b<bb;b++)g.push(-100);if(-2<a.nflags)for(0<a.stem?(f=-f,b=2*a.notes[0].pit,d=2*(Math.ceil((a.ymx-2)/3)+18)):(b=2*(Math.ceil((a.ymn+2)/3)+18),d=2*a.notes[a.nhd].pit),0>b&&(b=0),d>=bb&&(d=bb-1);b<=d;)g[b++]=f;c=a.notes[0<a.stem?0:a.nhd].shhd;for(d=0;d<=a.nhd;d++)f=-a.notes[d].shhd+e+c,b=2*a.notes[d].pit,0>b?b=0:b>=bb-1&&(b=bb-2),f>g[b]&&(g[b]=f),4!=a.head&&--f,f>g[b-1]&&(g[b-
1]=f),f>g[b+1]&&(g[b+1]=f);return g}function Lh(a){var d,b,c,e=Tg[a.head],f=e,g=0<a.nflags&&a.beam_st&&a.beam_end,h=[];for(b=0;b<bb;b++)h.push(-100);if(-2<a.nflags)for(0>a.stem?(f=-f,b=2*(Math.ceil((a.ymn+2)/3)+18),d=2*a.notes[a.nhd].pit,c=b+4):(b=2*a.notes[0].pit,d=2*(Math.ceil((a.ymx-2)/3)+18)),0>b&&(b=0),d>bb&&(d=bb);b<d;)h[b++]=f;if(g)if(0<a.stem)for(b=0==a.xmx?2*a.notes[a.nhd].pit:2*a.notes[0].pit,b+=4,0>b&&(b=0);b<bb&&b<=d-4;b++)h[b]=11;else for(b=c,0>b&&(b=0);b<bb&&b<=2*a.notes[0].pit-4;b++)h[b]=
3.5;c=a.notes[0<a.stem?0:a.nhd].shhd;for(d=0;d<=a.nhd;d++)f=a.notes[d].shhd+e-c,b=2*a.notes[d].pit,0>b?b=0:b>=bb-1&&(b=bb-2),f>h[b]&&(h[b]=f),4!=a.head&&--f,f>h[b-1]&&(h[b-1]=f),f>h[b+1]&&(h[b+1]=f);return h}function Hj(a){for(var d,b,c=a.p_v;1==a.type||5==a.type||6==a.type;)if(6==a.type&&a.time>c.sym.time&&(De|=1),a=a.prev,!a)return;if(0==a.type&&(void 0!=a.text&&(c.bar_start=T(a),c.bar_start.bar_type="[",delete a.text,delete a.a_gch),d=a.bar_type,":"!=d&&":"==d.slice(-1)))if(c.bar_start||(c.bar_start=
T(a)),":"!=d[0])"||:"==d?(c.bar_start.bar_type="|:",a.bar_type="||"):(c.bar_start.bar_type=d,a.prev&&0==a.prev.type?gc(a):a.bar_type="|");else if("::"==d)c.bar_start.bar_type="|:",a.bar_type=":|";else if("||:"==d)c.bar_start.bar_type="|:",a.bar_type="||";else{for(b=0;":"==d[b];)b++;if(b<d.length){a.bar_type=d.slice(0,b)+"|";for(b=d.length-1;":"==d[b];)b--;c.bar_start.bar_type="|"+d.slice(b+1)}else b=d.length/2|0,a.bar_type=d.slice(0,b)+"|",c.bar_start.bar_type="|"+d.slice(b)}}function Ij(a){for(var d=
Q;d&&!d.nl;d=d.ts_next)d.st==a&&1!=d.type&&(d.st++,d.invis=!0)}function Jj(){function a(a){var b=r[a],c=q.staves[a];b||(b=r[a]={});b.y=0;b.stafflines=c.stafflines;b.staffscale=c.staffscale;b.ann_top=b.ann_bot=0}function d(){var a,b,c,d=q.staves.length;for(a=0;a<d;a++)if(q.staves[a].flags&257){c=0;for(b=a;a<d;){c|=g[a]?1:2;if(q.staves[a].flags&514)break;a++}if(3==c)for(;b<=a;)g[b]=!0,h[b++]=!0}}var b,c,e,f,g=[],h=[],q=B;M=e=q.nstaff;for(c=0;c<=e;c++)a(c);for(b=Q;b&&!b.nl;b=b.ts_next)if(12==b.type){d();
q.st_print=new Uint8Array(g);q=b.sy;e=q.nstaff;if(M<e){for(c=M+1;c<=e;c++)a(c);M=e}g=[]}else if(c=b.st,!g[c])switch(b.type){case 1:c>M&&(r[b.st].clef=b,gc(b));break;case 4:h[c]=g[c]=!0;break;case 8:case 10:case 11:case 7:1<k.staffnonote?h[c]=g[c]=!0:b.invis||0==k.staffnonote&&8!=b.type||(h[c]=g[c]=!0)}ic=b;d();q.st_print=new Uint8Array(g);(function(){var a,b,c,d;for(a=0;a<=M;a++)if(b=r[a],h[a]){d=b.stafflines.length;b.topbar=6*(d-1);for(c=0;c<d-1&&"."==b.stafflines[c];c++);b.botline=b.botbar=6*c;
c>=d-2&&(b.botbar-=6,b.topbar+=6)}else b.botbar=b.topbar=0})();for(c=0;c<M;c++)h[c]||Ij(c);h[M]||(r[M].topbar=0);Fj();D.st_print=new Uint8Array(h);if(ic){b=ic;b.nl=!1;b=b.ts_prev;b.ts_next=null;f=x.length;for(e=0;e<f;e++){c=x[e];if(c.sym&&c.sym.time<=ic.time){for(b=ic.ts_prev;b;b=b.ts_prev)if(b.v==e){c.s_next=b.next;b.next=null;Hj(b);break}if(b)continue}c.s_next=c.sym;c.sym=null}if(0!=ic.ts_prev.type){for(c=ic.ts_prev;!c.seqst;)c=c.ts_prev;b=Q;Q=c;e=c.shrink;f=c.space;Hh();c.shrink=e;c.space=f;Q=
b}}}function rd(){fc=(k.leftmargin-k["print-leftmargin"])/k.scale}function Di(a){function d(){a&&(a=!1,100>k.pagewidth-k.leftmargin-k.rightmargin&&(X(0,void 0,"Bad staff width"),k.pagewidth=k.leftmargin+k.rightmargin+200),rd())}for(var b=Q,c=b.time;b;b=b.ts_next){if(b.time!=c){d();return}switch(b.type){case 8:case 10:case 7:d();return;default:continue;case 12:B=b.sy;break;case 16:switch(b.subtype){case "center":d();ad(b.text,"c");break;case "leftmargin":case "rightmargin":case "pagescale":case "pagewidth":case "scale":case "staffwidth":Qg(b.subtype,
b.param);a=!0;break;case "ml":jg();R.img_out(b.text);break;case "newpage":Cb();Yc();lc.newpage=!0;break;case "sep":d();la(b.sk1);A.push('<path class="stroke"\n\td="M');vc(b.x," ",0);A.push("h"+b.l.toFixed(2)+'"/>\n');la(b.sk2);Cb();break;case "text":d();ad(b.text,b.opt);break;case "title":d();Ee(b.text,!0);break;case "vskip":la(b.sk);Cb();break;default:X(2,b,"Block $1 not treated",b.subtype)}}gc(b);b.p_v.s_next==b&&(b.p_v.s_next=b.next)}Q=null}function sd(a){a.ctx=v.ctx;a.istart=v.istart;a.iend=v.iend}
function Ei(a){var d={type:1,clef_line:2,clef_type:"t",v:h.v,p_v:h,time:h.time,dur:0},b=1;sd(d);switch(a[0]){case '"':b=a.indexOf('"');d.clef_name=a.slice(1,b);b++;break;case "a":if("u"==a[1]){d.clef_type="a";d.clef_auto=!0;b=4;break}b=4;case "C":d.clef_type="c";d.clef_line=3;break;case "b":b=4;case "F":d.clef_type="b";d.clef_line=4;break;case "n":b=4;d.invis=!0;break;case "t":if("e"==a[1]){d.clef_type="c";d.clef_line=4;break}b=6;case "G":break;case "p":b=4;case "P":d.clef_type="p";d.clef_line=3;
break;default:y(1,"Unknown clef '$1'",a);return}"1"<=a[b]&&"9">=a[b]&&(d.clef_line=Number(a[b]),b++);if("8"!=a[b+1])return d;switch(a[b]){case "^":d.clef_oct_transp=!0;case "+":d.clef_octave=7;break;case "_":d.clef_oct_transp=!0;case "-":d.clef_octave=-7}return d}function td(a,d){var b,c,e,f,g=[];if("0"==a[0])return 0;if(0<="123456789-+".indexOf(a[0])){c=3*parseInt(a);if(isNaN(c)||-108>c||108<c){y(1,"Bad transpose value");return}switch(a.slice(-1)){default:return c;case "#":c++;break;case "b":c+=
2}return 0<c?c:c-3}if("instr"==d)if(e=a.indexOf("/"),k.sound)a=0>e?"c"+a:a.replace(/.*\//,"c");else{if(0>e)return 0;a=a.replace("/","")}e=new hb;e.buffer=a;for(b=0;2>b;b++){f=mc(e);if(!f){y(1,"Bad transpose value");return}f.pit+=124;c=12*(f.pit/7|0)+Kj[f.pit%7];f.acc&&3!=f.acc&&(c+=f.acc);g[b]=c}k.sound&&(g[0]=252);c=3*(g[1]-g[0]);if(f)switch(f.acc){default:return c;case 2:case 1:c++;break;case -1:case -2:c+=2}return 0<c?c:c-3}function Fi(a){var d;d=a.match(/(.*?)[= ]+(.*)/);a=d[1];var b=d[2];if(!b||
"!"!=b[0]&&'"'!=b[0])y(1,'Lack of starting ! or " in U: / %%user');else if(b.slice(-1)!=b[0])y(1,"Lack of ending $1 in U:/%%user",c2);else if("\\"==a[0]&&("t"==a[1]?a="\t":a[1]||(a=" ")),d=a.charCodeAt(0),128<=d)y(1,Fe);else{switch(wb[d][0]){case "0":case "d":case "i":case " ":break;case '"':case "!":if(1<wb[d].length)break;default:y(1,"Bad user character '$1'",a);return}switch(b){case "!beambreak!":b=" ";break;case "!ignore!":b="i";break;case "!nil!":case "!none!":b="d"}wb[d]=b}}function Gi(a){var d;
if(a){if(a.match(/^[|.]+$/))return a;a=parseInt(a);switch(a){case 0:return"...";case 1:return"..|";case 2:return".||";case 3:return".|||"}if(!(isNaN(a)||0>a||16<a)){for(d="|";0<--a;)d+="|";return d}}}function mb(a){a={type:16,subtype:a,dur:0};2==v.state&&nb();var d=h;h=x[E.top_voice];h.last_sym&&(h.last_sym.eoln=!0);ya(a);h=d;return a}function Ge(a){var d,b,c,e;h.init||(h.init=!0,L.V&&(L.V["*"]&&(a=L.V["*"].concat(a)),L.V[h.id]&&(a=L.V[h.id].concat(a))));if(0==a.length)return 0;for(;;){b=a.shift();
if(!b)break;switch(b){case "clef=":d=a.shift();break;case "combine=":case "map=":case "octave=":case "scale=":case "uscale=":b=b.slice(0,-1);h[b]=a.shift();break;case "cue=":h.scale="on"==a.shift()?.7:1;break;case "instrument=":h.transp=td(a.shift(),"instr");break;case "name=":case "nm=":h.nm=a.shift();h.new_name=!0;break;case "stem=":b="stm=";case "dyn=":case "gch=":case "gst=":case "orn=":case "stm=":case "voc=":case "vol=":e=qd[a.shift()];if(void 0==e){y(1,xc,b);break}b=b.slice(0,-1);c||(c={});
c[b]=e;break;case "score=":if(k.sound)break;b=a.shift();0>b.indexOf("/")&&(b+="/c");h.transp=td(b);break;case "shift=":h.shift=td(a.shift());break;case "sound=":case "transpose=":if(!k.sound)break;h.transp=td(a.shift());break;case "subname=":case "sname=":case "snm=":h.snm=a.shift();break;case "stafflines=":b=Gi(a.shift());void 0==b?y(1,"Bad stafflines= value"):h.stafflines=b;break;default:switch(b.slice(0,4)){case "treb":case "bass":case "alto":case "teno":case "perc":d=b;break;default:0<="GFC".indexOf(b[0])?
d=b:"="==b.slice(-1)&&a.shift()}}}if(c)for(b in h.pos=T(h.pos),c)c.hasOwnProperty(b)&&(h.pos[b]=c[b]);d&&(d=Ei(d))&&Hi(d)}function Ii(a,d){0!=d.length&&(L.V||(L.V={}),L.V[a]?Array.prototype.push.apply(L.V[a],d):L.V[a]=d)}function Lj(a){var d={type:6,dur:0,a_meter:[]},b={},c,e,f,g=0,l;sd(d);if(0==a.indexOf("none"))g=4,c=1;else for(c=0;g<a.length&&"="!=a[g];){switch(a[g]){case "C":b.top=a[g++];"|"==a[g]&&(b.top+=a[g++]);f=e=4;break;case "c":case "o":e="c"==a[g]?4:3;f=4;b.top=a[g++];"."==a[g]&&(b.top+=
a[g++]);break;case "(":"("==a[g+1]&&(l=!0,b.top=a[g++],d.a_meter.push(b),b={});for(e=g+1;e<a.length&&")"!=a[e]&&"/"!=a[e];)e++;if(")"==a[e]&&"/"==a[e+1]){g++;continue}case ")":l="("==a[g];b.top=a[g++];d.a_meter.push(b);b={};continue;default:if("0">=a[g]||"9"<a[g]){y(1,"Bad char '$1' in M:",a[g]);return}f=2;for(b.top=a[g++];;){for(;"0"<=a[g]&&"9">=a[g];)b.top+=a[g++];if(")"==a[g]){if("/"!=a[g+1])break;g++}if("/"==a[g]){g++;if("0">=a[g]||"9"<a[g]){y(1,"Bad char '$1' in M:",a[g]);return}for(b.bot=a[g++];"0"<=
a[g]&&"9">=a[g];)b.bot+=a[g++];break}if(" "!=a[g]&&"+"!=a[g])break;if(g>=a.length||"("==a[g+1])break;b.top+=a[g++]}e=parseInt(b.top)}l||(b.bot&&(f=parseInt(b.bot)),c+=1536*e/f);d.a_meter.push(b);for(b={};" "==a[g];)g++;"+"==a[g]&&(b.top=a[g++],d.a_meter.push(b),b={})}if("="==a[g]){c=a.substring(++g);if(!c.match(/^(\d|\/)+$/)){y(1,"Bad duration '$1' in M:",c);return}c=1536*eval(c)}d.wmeasure=c;if(3!=v.state){if(L.M=a,oa.meter=d,1<=v.state)for(oa.ulen||(oa.ulen=1>=c||1152<=c?192:96),a=0;a<x.length;a++)x[a].meter=
d,x[a].wmeasure=c}else h.wmeasure=c,qf()?(h.meter=d,De=0<=k.writefields.indexOf("M")?3:2):ya(d)}function Ld(a,d){var b,c,e;switch(a){case "I":Be(d);break;case "L":2==v.state&&nb();if(b=d.match(/^(\d+)\/(\d+)(=(\d+)\/(\d+))?$/)){c=Number(b[2]);if(!c||0!=(c&c-1))break;c=Number(b[1])/c*1536;if(b[3]){e=Number(b[5]);if(!e||0!=(e&e-1))break;e=Number(b[4])/e*1536}else e=c}else"auto"==d&&(c=e=-1);if(!e){y(1,"Bad L: value");break}2>v.state?oa.ulen=c:(h.ulen=c,h.dur_fact=e/c);break;case "M":Lj(d);break;case "U":Fi(d);
break;case "P":if(0==v.state)break;if(1==v.state){L.P=d;break}2==v.state&&nb();if(0>k.writefields.indexOf(a))break;b={type:9,text:d,dur:0};var f=x[E.top_voice];if(h.v!=f.v){if(h.time==f.time&&(!f.last_sym||9!=f.last_sym.type)){var g=h;h=f;ya(b);h=g}}else ya(b);break;case "Q":if(0==v.state)break;a:{var g=0,l,f={type:14,dur:0};sd(f);0>k.writefields.indexOf("Q")&&(f.del=!0);if('"'==d[0]){g=d.indexOf('"',1);if(0>g){y(1,"Unterminated string in Q:");break a}f.tempo_str1=d.slice(1,g);for(g++;" "==d[g];)g++}b=
new hb;b.buffer=d;for(b.index=g;;){l=d[b.index];if(void 0==l||"0">=l||"9"<l)break;g=nc(b);f.tempo_notes||(f.tempo_notes=[]);for(f.tempo_notes.push(1536*g[0]/g[1]);;){l=d[b.index];if(" "!=l)break;b.index++}}if("="==l){for(l=d[++b.index];" "==l;)l=d[++b.index];g=b.index;"c"==l&&"a"==d[g+1]&&"."==d[g+2]&&" "==d[g+3]&&(f.tempo_ca="ca. ",b.index+=4);"/"!=d[b.index+1]?f.tempo=b.get_int():(g=nc(b),f.new_beat=1536*g[0]/g[1]);for(l=d[b.index];" "==l;)l=d[++b.index]}if('"'==l){b.index++;g=d.indexOf('"',b.index+
1);if(0>g){y(1,"Unterminated string in Q:");break a}f.tempo_str2=d.slice(b.index,g)}if(3!=v.state){if(1==v.state){L.Q=d;oa.tempo=f;break a}nb()}h.v==E.top_voice&&(ya(f),oa.tempo&&0==h.time&&(oa.tempo.del=!0))}break;case "V":b=rf(d,1);f=b.shift();if(2>v.state)0!=b.length&&Ii(f,b),"*"!=f&&1==v.state&&He(f);else if("*"==f)y(1,"Cannot have V:* in tune body");else if(h=He(f),Ge(b),2==v.state&&nb(),Ie(),b=h.v,void 0==h.time&&(h.time=0,0>Ac&&(h.st=h.cst=++M,E.nstaff=M,E.voices[b].st=M,E.voices[b].range=
b,E.staves[M]={stafflines:"|||||",staffscale:1}),0>E.voices[b].range&&0<=Ac&&(h.ignore=!0)),!h.filtered&&!h.ignore&&v.voice_opts){h.filtered=!0;var q;for(l in v.voice_opts)if(v.voice_opts.hasOwnProperty(l)&&(b=new RegExp(l),b.test(h.id)||b.test(h.nm)))for(q in v.voice_opts[l])v.voice_opts[l].hasOwnProperty(q)&&Be(v.voice_opts[l][q])}break;case "K":if(0==v.state)break;a:{var n;b:{l=d;q=0;c={type:5,k_delta:0,dur:0};sd(c);e=1;switch(l[0]){case "A":c.k_sf=3;break;case "B":c.k_sf=5;break;case "C":c.k_sf=
0;break;case "D":c.k_sf=2;break;case "E":c.k_sf=4;break;case "F":c.k_sf=-1;break;case "G":c.k_sf=1;break;case "H":switch(l[1]){case "P":c.k_bagpipe="P";e++;break;case "p":c.k_bagpipe="p";c.k_sf=2;e++;break;default:y(1,"Unknown bagpipe-like key")}n=!0;break;case "P":n=c.k_drum=!0;break;case "n":0==l.indexOf("none")&&(c.k_sf=0,c.k_none=!0,e=4);default:n=!0}if(!n){switch(l[e]){case "#":c.k_sf+=7;e++;break;case "b":c.k_sf-=7,e++}l=l.slice(e).trim();switch(l.slice(0,3).toLowerCase()){case "aeo":case "m":case "min":c.k_sf-=
3;q=5;break;case "dor":c.k_sf-=2;q=1;break;case "ion":case "maj":break;case "loc":c.k_sf-=5;q=6;break;case "lyd":c.k_sf+=1;q=3;break;case "mix":--c.k_sf;q=4;break;case "phr":c.k_sf-=4;q=2;break;default:"m"!=l[0]||" "!=l[1]&&"\t"!=l[1]&&"\n"!=l[1]?n=!0:(c.k_sf-=3,q=5)}n||(l=l.replace(/\w+\s*/,""));0==l.indexOf("exp ")&&((l=l.replace(/\w+\s*/,""))||y(1,"No accidental after 'exp'"),c.k_exp=!0);e=l[0];if("^"==e||"_"==e||"="==e){c.k_a_acc=[];n=new hb;n.buffer=l;do{e=mc(n);if(!e){q=[c,null];break b}c.k_a_acc.push(e);
for(e=l[n.index];" "==e;)e=l[++n.index]}while("^"==e||"_"==e||"="==e);l=l.slice(n.index)}else c.k_exp&&0==l.indexOf("none")&&(c.k_sf=0,l=l.replace(/\w+\s*/,""))}c.k_delta=(ud[(c.k_sf+7)%7]+14)%7;c.k_mode=q;q=[c,rf(l,0)]}l=q[0];q=q[1];if(l.k_sf&&!l.k_exp&&l.k_a_acc){var m,r,p=[],u=[];if(0<l.k_sf)for(m=0;m<l.k_sf;m++)p[m]=1,u[m]=[26,23,27,24,21,25,22][m];else for(m=0;m<-l.k_sf;m++)p[m]=-1,u[m]=[22,25,21,24,20,23,26][m];e=l.k_a_acc.length;for(n=0;n<e;n++){r=l.k_a_acc[n];for(c=0;c<m;c++)if(u[c]==r.pit){p[c]=
r.acc;break}c==m&&(p[c]=r.acc,u[c]=r.pit,m++)}for(n=0;n<m;n++)(r=l.k_a_acc[n])||(r=l.k_a_acc[n]={}),r.acc=p[n],r.pit=u[n]}switch(v.state){case 1:void 0!=l.k_sf||l.k_a_acc||(l.k_sf=0,l.k_none=!0);for(n=0;n<x.length;n++)c=x[n],c.key=l,c.okey=T(l),c.ckey=T(l);v.okey=T(l);v.ckey=l;0!=q.length&&Ii("*",q);oa.ulen||(oa.ulen=192);v.state=2;r=sf();la(k.topspace);if(k.titleformat){var t,w,f={},g=T(Mj);l={A:k.infospace,C:k.composerspace,O:k.composerspace,R:k.infospace};q={};n="";c=k.titleformat;for(e=0;;){for(;" "==
c[e];)e++;if(e>=c.length)break;b=c[e++];if("A">b||"Z"<b)"+"==b?0!=n.length&&"+"!=n.slice(-1)&&(n=n.slice(0,-1)+"+"):","==b&&("+"==n.slice(-1)&&(n=n.slice(0,-1)+"l"),n+="\n");else{if(f[b])q[b]++;else{if(!L[b])continue;f[b]=L[b].split("\n");q[b]=1}n+=b;switch(c[e]){case "-":n+="l";e++;break;case "0":n+="c";e++;break;case "1":n+="r";e++;break;default:n+="c"}}}"+"==n.slice(-1)&&(n=n.slice(0,-1)+"l");n+="\n";m={l:k.titlespace,c:k.titlespace,r:k.titlespace};var B={l:0,c:.5*r,r:r},A={},z;c=n;for(e=0;;){A.l=
A.c=A.r=u=0;for(w=e;;){b=c[w++];if("\n"==b)break;p=c[w++];if("+"==p)p=c[w+1];else if(0!=A[p])continue;if(z=f[b])(r=g[b])||(r="history"),t=Xc(r),t=1.1*t.size,l[b]&&(t+=l[b]),u<t&&(u=t),A[p]=t}m.l+=u-A.l;m.c+=u-A.c;for(m.r+=u-A.r;;){b=c[e++];if("\n"==b)break;p=c[e++];if(0!=f[b].length){z=f[b].shift();"+"==p&&(q[b]--,b=c[e++],p=c[e++],0<f[b].length&&(z=z?z+(" "+f[b].shift()):" "+f[b].shift()));(r=g[b])||(r="history");t=Xc(r);t=1.1*t.size;l[b]&&(t+=l[b]);Na(r);w=B[p];u=m[p]+t;"Q"==b?oa.tempo.del||("l"!=
p&&(z=Zf(oa.tempo),"c"==p&&(z*=.5),w-=z),$f(oa.tempo,w,-u)):z&&ja(w,-u,z,p);"T"==b&&(r=g.T="subtitle",l.T=k.subtitlespace);if(1>=q[b])for("T"==b&&(t=Xc(r),t=1.1*t.size,l[b]&&(t+=l[b]),Na(r));0<f[b].length;)u+=t,z=f[b].shift(),ja(w,-u,z,p);q[b]--;m[p]=u}}m.c>m.l&&(m.l=m.c);m.r>m.l&&(m.l=m.r);if(e>=n.length)break;m.c=m.r=m.l}la(m.l);la(k.musicspace)}else{if(L.T&&0<=k.writefields.indexOf("T"))for(l=0;;){q=L.T.indexOf("\n",l);if(0>q){Ee(L.T.substring(l),0!=l);break}Ee(L.T.slice(l,q),0!=l);l=q+1}Na("composer");
c=0;v.ckey.k_bagpipe&&!k.infoline&&0<=k.writefields.indexOf("R")&&(g=L.R);g&&(ja(0,-k.composerspace,g),c=k.composerspace);n=L.A;0<=k.writefields.indexOf("C")&&(b=L.C);0<=k.writefields.indexOf("O")&&(f=L.O);if(b||f||k.infoline){la(k.composerspace);0>k.aligncomposer?(m=0,p=" "):0==k.aligncomposer?(m=.5*r,p="c"):(m=r,p="r");e=c;if(b||f){0<=k.aligncomposer&&c!=e&&la(c-e);for(l=0;;){la(D.curfont.size);q=b?b.indexOf("\n",l):-1;if(0>q){Ji(m,0,b?b.substring(l):null,f,p);break}ja(m,0,b.slice(l,q),p);c+=D.curfont.size;
l=q+1}e>c&&la(e-c)}((g=g?null:L.R)||n)&&k.infoline&&(Na("info"),la(D.curfont.size+k.infospace),Ji(r,0,g,n,"r"),c+=D.curfont.size+k.infospace)}else e=k.composerspace;L.P&&0<=k.writefields.indexOf("P")&&(Na("parts"),c=k.partsspace+D.curfont.size-c,0<c&&(e+=c),.01<e&&la(e),ja(0,0,L.P),e=0);la(e+k.musicspace)}De=0<=k.writefields.indexOf("M")?3:2;D.nbar=k.measurefirst;break a;case 2:nb(!0)}0!=q.length&&Ge(q);b=(k.transp||0)+(h.transp||0)+(h.shift||0);if(void 0==l.k_sf){if(!l.k_a_acc&&!b)break a;l.k_sf=
h.okey.k_sf}h.okey=T(l);b&&(h.vtransp=b,tf(l));l.k_old_sf=h.ckey.k_sf;h.ckey=l;qf()?(h.key=T(l),l.k_none&&(h.key.k_sf=0)):(b=h.last_sym)&&6==b.type?(h.last_sym=b.prev,h.last_sym||(h.sym=null),ya(l),l.next=b,b.prev=l,h.last_sym=b):ya(l)}break;case "N":case "R":L[a]=L[a]?L[a]+("\n"+d):d;break;case "r":if(!R.keep_remark||3!=v.state)break;b={type:17,text:d,dur:0};ya(b);break;default:y(0,"'$1:' line ignored",a)}}function Ki(){var a,d,b=v.line,c={type:0,ctx:v.ctx,istart:v.bol+b.index,dur:0,multi:0};ib&&
ib.bar&&Od("|");oa.new_nbar&&(c.bar_num=oa.new_nbar,oa.new_nbar=0);for(d=b["char"]();;){a=b.next_char();switch(a){case "|":case "[":case "]":case ":":d+=a;continue}break}":"==d[0]&&(1==d.length?(d="|",c.bar_dotted=!0):c.rbstop=2);Bc&&Je(c);za&&(lf(za,c),za=null);switch(d.slice(-1)){case "[":if(1==d.length){c.text="";break}d=d.slice(0,-1);b.index--;a="[";break;case ":":c.rbstop=2}if("0"<a&&"9">=a){for(c.text=a;;){a=b.next_char();if(0>"0123456789,.-".indexOf(a))break;c.text+=a}c.rbstop=2;c.rbstart=
2}else if('"'==a&&"["==d){for(;;){a=b.next_char();if(!a){y(1,"No end of repeat string");return}if('"'==a){b.index++;break}"\\"==a&&(c.text+=a,a=b.next_char());c.text+=a}c.text=zc(c.text);c.rbstop=2;c.rbstart=2}"]"==d[0]&&(c.rbstop=2,1!=d.length?d=d.slice(1):c.invis=!0);c.iend=v.bol+b.index;c.rbstart&&h.norepbra&&!h.second&&(c.norepbra=!0);if(0>h.ulen){var e,f;if((a=h.last_sym)&&7!=a.type&&0!=a.type){for(;0!=a.type&&a.prev;)a=a.prev;b=a.time;e=h.time-b;if(0==b){for(;a&&!a.dur;)a=a.next;a&&10==a.type&&
a.invis&&(b+=a.dur*h.wmeasure/e,a.prev?a.prev.next=a.next:h.sym=a.next,a.next&&(a.next.prev=a.prev),a=a.next)}if(h.wmeasure!=e){for(;a;a=a.next)if(a.time=b,a.dur&&!a.grace&&(a.dur=a.dur*h.wmeasure/e,a.dur_orig=a.dur_orig*h.wmeasure/e,b+=a.dur,8==a.type||10==a.type)){for(f=0;f<=a.nhd;f++)a.notes[f].dur=a.notes[f].dur*h.wmeasure/e;f=od(a,a.dur_orig);a.head=f[0];a.dots=f[1];a.nflags=f[2];-2>=a.nflags?a.stemless=!0:delete a.stemless}h.time=c.time=b}}}if((a=h.last_sym)&&11==a.type)a.time--;else if(a&&
0==a.type){if("["==d&&!a.text&&!a.a_gch&&(0==h.st||E.staves[h.st-1].flags&64||c.norepbra)){c.text&&(a.text=c.text);c.a_gch&&(a.a_gch=c.a_gch);c.norepbra&&(a.norepbra=c.norepbra);c.rbstart&&(a.rbstart=c.rbstart);c.rbstop&&(a.rbstop=c.rbstop);return}if("|:"==d&&!c.text){if(":|"==a.bar_type){a.bar_type="::";a.rbstop=2;return}if("||"==a.bar_type){a.bar_type="||:";a.rbstop=2;return}}}switch(d){case "[":c.rbstop=2;case "[]":case "[|]":c.invis=!0;d="[]";break;case ":|:":case ":||:":d="::";break;case "||":if(!k.rbdbstop)break;
case "[|":case "|]":c.rbstop=2}c.bar_type=d;h.lyric_restart||(h.lyric_restart=c);h.sym_restart||(h.sym_restart=c);!a||5!=a.type||a.prev&&0==a.prev.type?ya(c):(h.last_sym=a.prev,a.prev||(h.sym=a.prev),ya(c),c.next=a,a.prev=c,h.last_sym=a);c.st=h.st;c.rbstart&&!h.norepbra&&0<h.st&&!(E.staves[h.st-1].flags&64)&&(a={type:0,ctx:c.ctx,istart:c.istart,iend:c.iend,bar_type:"[",multi:0,invis:!0,text:c.text,rbstart:2},ya(a),a.st=h.st,delete c.text,c.rbstart=0)}function rf(a){var d=[],b="",c,e,f=a.length;for(c=
0;c<f;c++)switch(a[c]){case "=":if(!b){b="=";break}b+="=";d.push(b);b="";break;case " ":case "\t":if(!b)break;d.push(b);b="";break;case '"':b&&(d.push(b),b="");for(e=++c;c<f&&'"'!=a[c];)"\\"==a[c]&&c++,c++;if('"'!=a[c]){y(1,"Unterminated string");break}d.push(a.slice(e,c));break;case "\\":b+=a[c++];default:b+=a[c]}b&&d.push(b);return d}function od(a,d){var b,c,e;0!=d%12&&y(1,"Invalid note duration $1",d);d/=12;0==d&&y(1,"Note too short");for(e=5;0!=d&&!(d&1);d>>=1,e--);switch(d>>1){case 0:c=0;break;
case 1:c=1;break;case 3:c=2;break;default:c=3}e-=c;if(0<=e)b=0;else switch(e){default:y(1,"Note too long"),e=-4;case -4:b=4;break;case -3:b=k.squarebreve?4:3;break;case -2:b=2;break;case -1:b=1}return[b,c,e]}function nc(a){var d,b,c;Ke.lastIndex=a.index;d=Ke.exec(a.buffer);if(!d[0])return[1,1];b=d[1]||1;c=d[3]||1;d[3]||(c*=1<<d[2].length);a.index=Ke.lastIndex;return[b,c]}function mc(a){var d,b,c,e,f=a["char"]();switch(f){case "^":f=a.next_char();"^"==f?(d=2,f=a.next_char()):d=1;break;case "=":d=3;
f=a.next_char();break;case "_":f=a.next_char(),"_"==f?(d=-2,f=a.next_char()):d=-1}if(d&&3!=d&&"1"<=f&&"9">=f||"/"==f)c=nc(a),b=c[0],c=c[1],c=1==c?h?h.uscale:1:2*c,f=a["char"]();e=uf.indexOf(f)+16;f=a.next_char();if(16>e)y(1,"'$1' is not a note",a.buffer[a.index-1]);else{for(;"'"==f;)e+=7,f=a.next_char();for(;","==f;)e-=7,f=a.next_char();a={pit:e,apit:e,shhd:0,shac:0,ti1:0};d&&(a.acc=d,b&&(a.micro_n=b,a.micro_d=c));return a}}function Pd(){var a=v.line,d=0;"."!=a.buffer[a.index-1]||za||(d=8);switch(a.next_char()){case "'":return a.index++,
d+1;case ",":return a.index++,d+2}return d+3}function Gh(a){a.notes=a.notes.sort(function(a,b){return a.pit-b.pit})}function Nj(a,d){var b,c,e,f,g;g=0;var l=v.line,q=za;za=null;v.stemless=!1;c={type:8,ctx:v.ctx,stem:0,multi:0,nhd:0,xmx:0};c.istart=v.bol+l.index;h.color&&(c.color=h.color);a?c.grace=!0:(Bc&&Je(c),v.repeat_n&&(c.repeat_n=v.repeat_n,c.repeat_k=v.repeat_k,v.repeat_n=0));f=l["char"]();switch(f){case "X":c.invis=!0;case "Z":c.type=7;f=l.next_char();c.nmes="0"<f&&"9">=f?l.get_int():1;c.dur=
h.wmeasure*c.nmes;if(h.second)return h.time+=c.dur,null;break;case "y":c.type=11;c.invis=!0;c.dur=0;f=l.next_char();c.width="0"<=f&&"9">=f?l.get_int():10;break;case "x":c.invis=!0;case "z":c.type=10;l.index++;e=nc(l);c.dur_orig=(0>h.ulen?384:h.ulen)*e[0]/e[1];c.dur=c.dur_orig*h.dur_fact;c.notes=[{pit:18,dur:c.dur_orig}];break;case "[":e=!0,f=l.next_char();default:h.uscale&&(c.uscale=h.uscale);for(c.notes=[];;){if(e)for(;f&&"%"!=f;){f=f.charCodeAt(0);if(128<=f)return y(1,Fe),null;f=wb[f];switch(f[0]){case "(":g<<=
4;g+=Pd();f=l["char"]();continue;case "!":za||(za=[]);if(1<f.length)za.push(f.slice(1,-1));else{for(b="";;){f=l.next_char();if(!f||"%"==f){y(1,"No end of decoration");return}if("!"==f)break;b+=f}za.push(b)}f=l.next_char();continue}break}var n;n=l;f=c.grace||0>h.ulen?384:h.ulen;(b=mc(n))?("0"==n["char"]()&&(v.stemless=!0,n.index++),n=nc(n),b.dur=f*n[0]/n[1]):b=void 0;if(!b)return;h.octave&&(b.apit=b.pit+=7*h.octave);h.ottava&&(b.pit+=h.ottava);g&&(b.sl1=g,c.sl1?c.sl1++:c.sl1=1,g=0);za&&(b.a_dcn=za,
za=null);c.notes.push(b);if(!e)break;for(f=l["char"]();;){switch(f){case ")":b.sl2?b.sl2++:b.sl2=1;c.sl2?c.sl2++:c.sl2=1;f=l.next_char();continue;case "-":b.ti1=Pd();c.ti1=!0;f=l["char"]();continue;case ".":if(f=l.next_char(),"-"!=f)y(1,"Misplaced dot");else continue}break}if("]"==f){l.index++;e=nc(l);c.nhd=c.notes.length-1;for(f=0;f<=c.nhd;f++)b=c.notes[f],b.dur=b.dur*e[0]/e[1];break}}c.dur_orig=c.notes[0].dur;c.dur=c.notes[0].dur*h.dur_fact}if(c.grace&&8!=c.type)y(1,"Not a note in grace note sequence");
else{if(c.notes){if(c.grace){e=h.key.k_bagpipe?8:4;for(f=0;f<=c.nhd;f++)c.notes[f].dur/=e;c.dur/=e;c.dur_orig/=e;a.stem&&(c.stem=a.stem)}else{switch(h.pos.stm){case 1:c.stem=1;break;case 2:c.stem=-1;break;case 4:c.stemless=!0}c.combine=h.combine;c.dur*=d;if(b=h.brk_rhythm){h.brk_rhythm=0;e=h.last_note;if(0<b){g=2*b-1;c.dur=c.dur*g/b;c.dur_orig=c.dur_orig*g/b;for(f=0;f<=c.nhd;f++)c.notes[f].dur=c.notes[f].dur*g/b;e.dur/=b;e.dur_orig/=b;for(f=0;f<=e.nhd;f++)e.notes[f].dur/=b}else{b=-b;g=2*b-1;c.dur/=
b;c.dur_orig/=b;for(f=0;f<=c.nhd;f++)c.notes[f].dur/=b;e.dur=e.dur*g/b;e.dur_orig=e.dur_orig*g/b;for(f=0;f<=e.nhd;f++)e.notes[f].dur=e.notes[f].dur*g/b}h.time=e.time+e.dur;f=od(e,e.dur_orig);e.head=f[0];e.dots=f[1];e.nflags=f[2];-2>=e.nflags?e.stemless=!0:delete e.stemless;for(e=e.next;e;e=e.next)e.time=h.time}}if(8==c.type){if(f=od(c,c.dur_orig),c.head=f[0],c.dots=f[1],c.nflags=f[2],c.xstem&&(c.nflags=0),-2>=c.nflags&&(c.stemless=!0),h.map&&kc[h.map])for(f=0;f<=c.nhd;f++)a:{var m;n=c.notes[f];var r=
kc[h.map];b="abcdefg"[(n.pit+77)%7];g=n.acc?"__ _  ^ ^^ =".split(" ")[n.acc+2]:"";e=g+b;for(m=n.pit;28<=m;m-=7)e+="'";for(m=n.pit;21>m;m+=7)e+=",";if(m=r[e])m[1]&&(n.apit=n.pit=m[1].pit,n.acc=m[1].acc);else if(e="octave,"+g+b,!r[e]&&(e="key,"+"abcdefg"[(n.pit+77-h.ckey.k_delta)%7],!r[e]&&(e="all",!r[e])))break a;n.map=r[e]}}else f=c.dur_orig,f==h.wmeasure&&(f=3072>f?1536:6144>f?3072:6144),f=od(c,f),c.head=f[0],c.dots=f[1],c.nflags=f[2];h.last_note=c}ya(c);if(8==c.type&&h.vtransp){var p,u,t,w;f=c.nhd;
e=h.okey.k_sf;g=h.ckey.k_sf-e;b=ud[(g+28)%7];n=h.vtransp;0>n&&0!=b&&(b-=7);b+=7*(n/3/12|0);for(n=0;n<=f;n++){m=c.notes[n];u=m.pit;m.pit+=b;m.apit=m.pit;w=kg[(u+5+112)%7];r=m.acc;if(!r)if(h.okey.a_acc)for(p=0;p<h.okey.a_acc.length;p++){if(t=h.okey.a_acc[p],0==(u+112-t.pit)%7){r=t.acc;break}}else 0<e?w<e-1&&(r=1):0>e&&w>=e+6&&(r=-1);p=w+g;r&&3!=r&&(p+=7*r);w=(((p+1+21)/7|0)+2-3+160)%5;r=Oj[w];if(!m.acc)if(h.ckey.k_none){if(3==r||Pj(m.pit))continue}else if(h.ckey.a_acc){w=ud[(p+112)%7];for(p=0;p<h.ckey.a_acc.length&&
0!=(w+112-h.ckey.a_acc[p].pits)%7;p++);if(p<h.ckey.a_acc.length)continue}else continue;w=m.acc;if((p=m.micro_d)&&w!=r)switch(u=m.micro_n,r){case 3:u>p/2?(u-=p/2,m.micro_n=u,r=w):r=-w;break;case 2:u>p/2?(m.pit+=1,m.apit=m.pit,u-=p/2):u+=p/2;r=w;m.micro_n=u;break;case -2:u>=p/2?(--m.pit,m.apit=m.pit,u-=p/2):u+=p/2,r=w,m.micro_n=u}m.acc=r}}k.shiftunison&&(c.shiftunison=k.shiftunison);a||(h.lyric_restart||(h.lyric_restart=c),h.sym_restart||(h.sym_restart=c));q&&lf(q,c,c.prev);v.stemless&&(c.stemless=
!0);c.iend=v.bol+l.index;return c}}function qi(){function a(r){for(var p,u,t,w;;){p=m["char"]();if(!p||"%"==p)break;if("."==p)switch(m.buffer[m.index+1]){case "(":case "-":case "|":p=m.next_char()}u=p.charCodeAt(0);if(128<=u){y(1,Fe);m.index++;break}if(!r&&$c[u]){w=0;for(t in Zc)if(Zc.hasOwnProperty(t)&&t[0]==p){if(0>t.indexOf("n")){if(m.buffer.indexOf(t,m.index)!=m.index)continue;m.index+=t.length}else{a:{w=void 0;var x,z,A=t;z=1;for(x=m.index+1;z<A.length;z++,x++)if(A[z]!=m.buffer[x]){if("n"!=A[z]){w=
void 0;break a}w=uf.indexOf(m.buffer[x]);if(0>w){w=void 0;break a}for(;"'"==m.buffer[x+1];)w+=7,x++;for(;","==m.buffer[x+1];)w-=7,x++}m.index=x}if(!w)continue}var A=Zc[t],B=w;w=m;x=v.istart;v.line=m=new hb;v.istart+=w.index;z=m;if(B){var D,L=B,I="",M=A.length;for(vd=0;vd<M;vd++)if(D=A[vd],"h"<=D&&"z">=D){B=L+D.charCodeAt(0)-110;for(D="";0>B;)B+=7,D+=",";for(;14<B;)B-=7,D+="'";I+=uf[B]+D}else I+=D;A=I}z.buffer=A;a(!0);v.line=m=w;v.istart=x;w=1;break}if(w)continue}u=wb[u];switch(u[0]){case " ":if(w=
h.last_note)w.beam_end=!0,d&&(w.gr_shift=!0);break;case "\n":if(k.barsperstaff)break;0==E.voices[h.v].range&&h.last_sym&&(h.last_sym.eoln=!0);break;case "&":p=m.next_char();if(")"==p){Od(")");break}Od("&");continue;case "(":p=m.next_char();if("0"<p&&"9">=p){u=m.get_int();w=Qj[u];x=u;p=m["char"]();if(":"==p&&(p=m.next_char(),"0"<p&&"9">=p&&(w=m.get_int(),p=m["char"]()),":"==p))if(p=m.next_char(),"0"<p&&"9">=p)x=m.get_int(),m["char"]();else{y(1,"Invalid 'r' in tuplet");continue}if(0==w||void 0==w)w=
0==h.wmeasure%9?3:2;(g=f[++l])||(f[l]=g={});g.p=u;g.q=w;g.r=x;g.f=k.tuplets;g.fact=q*w/u;q=g.fact;continue}if("&"==p){Od("(");break}n<<=4;m.index--;n+=Pd();continue;case ")":if(h.ignore)break;if(w=h.last_sym)switch(w.type){case 8:case 10:case 11:break;default:w=null}if(!w){y(1,"Bad character '$1'",p);break}w.slur_end?w.slur_end++:w.slur_end=1;break;case "!":za||(za=[]);if(1<u.length)w=u.slice(1,-1);else{w="";for(u=m.index;;){p=m.next_char();"%"==p&&(p=0);if(!p)break;if("!"==p)break;w+=p}if(!p){m.index=
u;y(1,"No end of decoration");break}}Xf[w]&&Le(w);za.push(w);break;case '"':Li(u);break;case "-":if(!h.last_note||8!=h.last_note.type){y(1,"No note before '-'");break}p=Pd();w=h.last_note;for(u=0;u<=w.nhd;u++)w.notes[u].ti1?0==w.nhd&&y(1,"Too many ties"):w.notes[u].ti1=p;w.ti1=!0;d&&(d.ti1=!0);continue;case "[":w=m.buffer[m.index+1];if(0<='|[]: "'.indexOf(w)||"1"<=w&&"9">=w){if(d){y(1,Mi);break}Ki();continue}if(":"==m.buffer[m.index+2]){u=m.buffer.indexOf("]",m.index+1);if(0>u){y(1,"Lack of ']'");
break}p=m.buffer.slice(m.index+3,u).trim();v.istart=v.bol+m.index;v.iend=v.bol+u++;m.index=0;Ld(w,p);m.index=u;continue}case "n":w=Nj(d,q);if(!w)continue;8==w.type&&n&&(w.slur_start=n,n=0);if(d){0<=l&&(w.in_tuplet=!0);continue}0<=l&&w.notes&&(w.in_tuplet=!0,0<l?(f[0].p&&(w.tp0=f[0].p,w.tq0=f[0].q,w.tf=f[0].f,f[0].p=0),f[0].r--,g.p&&(w.tp1=g.p,w.tq1=g.q,w.tf=g.f,g.p=0)):g.p&&(w.tp0=g.p,w.tq0=g.q,w.tf=g.f,g.p=0),g.r--,0==g.r&&(0==l--?(w.te0=!0,q=1,h.time=Math.round(h.time),w.dur=h.time-w.time):(w.te1=
!0,g=f[0],0==g.r?(l--,w.te0=!0,q=1,h.time=Math.round(h.time),w.dur=h.time-w.time):q=g.fact)));continue;case "<":if(!h.last_note){y(1,"No note before '<'");break}if(d){y(1,"Cannot have a broken rhythm in grace notes");break}for(w="<"==p?1:-1;"<"==p||">"==p;)w*=2,p=m.next_char();h.brk_rhythm=w;continue;case "i":break;case "{":if(d){y(1,"'{' in grace note");break}b=h.last_note;h.last_note=null;c=za;za=void 0;d={type:4,ctx:v.ctx,istart:v.bol+m.index,dur:0,multi:0};switch(h.pos.gst){case 1:d.stem=1;break;
case 2:d.stem=-1;break;case 4:d.stem=2}ya(d);p=m.next_char();if("/"==p){d.sappo=!0;break}continue;case "|":if(d){y(1,Mi);break}p=m.buffer[m.index-1];Ki();"."==p&&(h.last_sym.bar_dotted=!0);continue;case "}":w=h.last_note;if(!d||!w){y(1,"Bad character '$1'",p);break}za&&y(1,"Decoration ignored");w.gr_end=!0;d.extra=d.next;d.extra.prev=null;d.next=null;h.last_sym=d;d=null;if(!w.prev&&!h.key.k_bagpipe){for(u=0;u<=w.nhd;u++)w.notes[u].dur*=2;w.dur*=2;w.dur_orig*=2;p=od(w,w.dur_orig);w.head=p[0];w.dots=
p[1];w.nflags=p[2]}h.last_note=b;za=c;break;case "\\":for(u=m.index+1;;u++){switch(m.buffer[u]){case " ":case "\t":continue;case "%":m.index=m.buffer.length;case void 0:p=void 0,e=!0}break}if(!p)break;default:y(1,"Bad character '$1'",p)}m.index++}}var d,b,c,e,f=[],g,l=-1,q=1,n=0,m=v.line;if(3!=v.state){if(2!=v.state)return;nb()}a();if(0<=l)for(y(1,"No end of tuplet"),s=h.last_note;s;s=s.prev)if(s.tp1&&(s.tp1=0),s.tp0){s.tp0=0;break}d&&(y(1,"No end of grace note sequence"),h.last_sym=d.prev,h.last_note=
b,d.prev&&(d.prev.next=null));k.breakoneoln&&h.last_note&&(h.last_note.beam_end=!0);e||k.barsperstaff||"\n"!=wb[10]||0!=E.voices[h.v].range||!h.last_sym||(h.last_sym.eoln=!0)}function uc(a){a=a.charCodeAt(0);128<=a&&(a=97);return Rj[a]}function lb(a){var d=D.curfont.swfac,b=0,c,e,f,g=a.length;for(c=0;c<g;c++){f=a[c];switch(f){case "$":f=a[c+1];if("0"==f)D.curfont=D.deffont;else if("1"<=f&&"9">=f)D.curfont=Xc("u"+f);else{b+=uc("$")*d;break}c++;d=D.curfont.swfac;continue;case "&":e=a.indexOf(";",c),
0<e&&10>e-c&&(c=e,f="a")}b+=uc(f)*d}return b}function Na(a){D.curfont=D.deffont=Xc(a)}function Ni(a){var d,b=D.curfont,c=b;A.push(a.replace(/<|>|&.*?;|&|\$./g,function(a){switch(a[0]){case "<":return"&lt;";case ">":return"&gt;";case "&":return"&"==a?"&amp;":a;case "$":if("0"==a[1])d=D.deffont;else if("1"<=a[1]&&"9">=a[1])d=Xc("u"+a[1]);else return a;a="";if(d==c)return a;c!=b&&(a="</tspan>");c=d;return c==b?a:a+'<tspan\n\tclass="f'+d.fid+k.fullsvg+'">'}}));c!=b&&(A.push("</tspan>"),D.curfont=c)}function ja(a,
d,b,c,e){A.push('<text class="f'+D.curfont.fid+k.fullsvg+'" x="');vc(a,'" y="',d);switch(c){case "c":A.push('" text-anchor="middle">');break;case "j":A.push('" textLength="'+e.toFixed(2)+'">');break;case "r":A.push('" text-anchor="end">');break;default:A.push('">')}Ni(b);A.push("</text>\n")}function Pg(a,d,b){var c=lb(b);A.push('<rect class="stroke" x="');vc(a-2,'" y="',d+D.curfont.size-2);A.push('" width="'+(c+4).toFixed(2)+'" height="'+(D.curfont.size+3).toFixed(2)+'"/>\n');ja(a,d,b)}function sf(){return(k.pagewidth-
k.leftmargin-k.rightmargin-2)/k.scale}function Ee(a,d){var b;if(a){b=a;var c;k.titletrim&&(c=b.lastIndexOf(", "),0>c||"A">b[c+2]||"Z"<b[c+2]||c<b.length-7||0<=b.indexOf(" ",c+3))&&(c=0);!d&&0<=k.writefields.indexOf("X")&&(b=L.X+".  "+b);c&&(b=b.slice(c+2).trim()+" "+b.slice(0,c));a=k.titlecaps?b.toUpperCase():b;d?(Na("subtitle"),b=D.curfont.size,la(k.subtitlespace+b)):(Na("title"),b=D.curfont.size,la(k.titlespace+b));k.titleleft?ja(0,.2*b,a):ja(sf()/2,.2*b,a,"c")}}function Ji(a,d,b,c,e){if(!b){if(!c)return;
b=c;c=null}c?ja(a,d,b+" ("+c+")",e):ja(a,d,b,e)}function ad(a,d){if("s"!=d){Na("text");var b=sf(),c=D.curfont.size*k.lineskipfac,e=D.curfont.size*k.parskipfac,f,g,h,q,n,m;switch(d){default:switch(d){case "c":b/=2;break;case "r":break;default:b=0}for(g=0;;){f=a.indexOf("\n",g);if(0>f){la(c);ja(b,0,a.slice(g),d);break}if(f==g){la(e);for(Cb();"\n"==a[f+1];)la(c),f++;if(f==a.length)break}else la(c),ja(b,0,a.slice(g,f),d);g=f+1}la(e);Cb();break;case "f":case "j":for(g=0;;){f=a.indexOf("\n\n",g);h=0>f?
a.slice(g):a.slice(g,f);h=h.split(/\s+/);for(g=q=n=0;g<h.length;g++)m=lb(h[g]+" "),q+=m,q>=b&&(la(c),ja(0,0,h.slice(n,g).join(" "),d,b),n=g,q=m);0!=q&&(la(c),ja(0,0,h.slice(n).join(" ")));la(e);Cb();if(0>f)break;for(;"\n"==a[f+2];)la(c),f++;if(f==a.length)break;g=f+2}}}}function Aj(a){function d(a,b,c){c=0;var d,e;"$"==a[c]&&"0"<=a[c+1]&&"9">=a[c+1]&&(c+=2);e=0;d=c;if("0"<=a[c]&&"9">=a[c]||"."==a[c+1]){for(;c<a.length&&(c++," "!=a[c]&&":"!=a[c-1]&&"."!=a[c-1]););for(e=c;" "==a[c];)c++}0!=e&&ja(b,
0,a.slice(d,e),"r");c<a.length&&ja(b+5,0,a.slice(c),"l");return c>=a.length&&0==e}var b,c,e,f,g,h,q;Cb();Na("words");var n=sf()/2;h=(n-45)/(uc("a")*D.curfont.swfac);f=0;a=a.split("\n");g=a.length;for(c=0;c<g;c++){b=a[c];if(b.length>h){f=0;break}b?q=!0:q&&(f++,q=!1)}if(0<f){c=f=(f+1)/2|0;q=!1;for(h=0;h<g;h++){b=a[h];for(e=0;" "==b[e];)e++;if(e==b.length){if(q&&0>=--c)break;q=!1}else q=!0}b=h+1}else b=h=g;la(k.wordsspace);for(c=0;c<h||b<g;c++)q=.2*D.curfont.size,c<h&&0==a[c].length&&Cb(),la(k.lineskipfac*
D.curfont.size-q),c<h&&d(a[c],45,0),b<g&&(d(a[b],20+n,1)&&0==--f&&(c<h?f++:b<a.length-1&&(n*=.6)),b++),la(q)}function ce(a){var d,b;if(!Me[a])if(Me[a]=!0,b=Qd[a]){for(d=0;;){a=b.indexOf('xlink:href="#',d);if(0>a)break;a+=13;d=b.indexOf('"',a);ce(b.slice(a,d))}Rd+="\n"+b}else X(1,null,"Unknown glyph: '$1'",a)}function Sj(a){var d,b,c,e;for(b=0;;){e=a.indexOf("<",b);if(0>e)break;if("\x3c!--"==a.slice(e,e+4)){if(b=a.indexOf("--\x3e",e+4),0>b)break}else{d=a.indexOf('id="',e);if(0>d)break;d+=4;b=a.indexOf('"',
d);if(0>b)break;c=a.slice(d,b);b=a.indexOf(">",b);if(0>b)break;if("/"==a[b-1])b++;else{d=a.indexOf(" ",e);if(0>d)break;d=a.slice(e+1,d);b=a.indexOf("</"+d+">",b);if(0>b)break;b+=3+d.length}Qd[c]=a.slice(e,b)}}}function Ne(){z.started&&(z.started=!1,A.push("</g>\n"));if(1!=z.scale||z.color)A.push("<g "),1!=z.scale&&(0<=z.st?A.push(r[z.st].scale_str):A.push(x[z.v].scale_str)),z.color&&(1!=z.scale&&A.push(" "),A.push('style="color:'+z.color+'"')),A.push(">\n"),z.started=!0}function pd(a){if(a==z.color)return null;
var d=z.color;z.color=a;Ne();return d}function hc(a){var d,b;a!=z.st&&1!=z.scale&&(z.scale=0);d=0<=a?r[a].staffscale:1;b=0<=a&&1!=d?r[a].y:Da;if(d!=z.scale||b!=z.dy)z.scale=d,z.dy=b,z.st=a,Ne()}function de(a){var d=a.p_v.scale;if(1==d)hc(a.st);else if(d!=z.scale||z.dy!=Da)z.scale=d,z.dy=Da,z.st=-1,z.v=a.v,Ne()}function Oe(a,d){0>a?(z.scale=1,A=r[0].output):(z.scale=d?1:r[a].staffscale,A=1==z.scale?r[a].output:r[a].sc_out);z.st=a;z.dy=0}function Oi(a,d,b){if(void 0!=a.istart){var c=a.type,e=a.ymx-
a.ymn+4,f=a.wl||2,g=a.wr||2;a.grace&&(c=4);b(d||Pi[c],a.istart,a.iend,a.x-f-2,r[a.st].y+a.ymn+e-2,f+g+4,e,a)}}function Tj(a,d){Oi(a,d,R.anno_start)}function Uj(a,d){Oi(a,d,R.anno_stop)}function Qi(){}function Z(a,d,b,c,e){d=vf(d);b=Pe(b);A.push(a.replace(/X|Y|A|B|F|G/g,function(a){switch(a){case "X":return d.toFixed(2);case "Y":return b.toFixed(2);case "A":return c;case "B":return e;case "F":return c.toFixed(2);default:return e.toFixed(2)}}))}function cg(a,d,b,c,e){Z('<g transform="translate(X,Y',
a,d);b&&A.push(") rotate("+b.toFixed(2));c&&(e?A.push(") scale("+c.toFixed(2)+", "+e.toFixed(2)):A.push(") scale("+c.toFixed(2)));A.push(')">\n');z.g++}function dg(){z.g--;A.push("</g>\n")}function vf(a){return z.g?a:(a+fc)/z.scale}function Pe(a){return z.g?a:1==z.scale?Da-a:0>z.st?(Da-a)/z.scale:z.dy-a}function vc(a,d,b){a=vf(a);b=Pe(b);A.push(a.toFixed(2)+d+b.toFixed(2))}function xe(a,d,b){Z('<path class="A" d="mX Y\n',a,d,b?"fill":"stroke")}function ia(a,d,b){var c=Vj[b];c&&!Qd[b]?Z('<text x="X" y="Y">A</text>\n',
a+c.x*z.scale,d+c.y,c.c):Qd[b]?(ce(b),Z('<use x="X" y="Y" xlink:href="#A"/>\n',a,d,b)):X(1,null,"no definition of $1",b)}function Jd(a,d,b,c){c?(ce("clearbg"),c=' filter="url(#clearbg)"'):c="";Z('<text style="font:italic 12px serif"\n\tx="X" y="Y" text-anchor="middle"B>A</text>\n',a,d,b.toString(),c)}function Ri(a,d,b){var c,e=25+3*(b/20|0);c=15<b?(b-15)/e|0:0;Z('<path class="stroke" stroke-width="1.2"\n\tstroke-dasharray="5,F"\n\td="mX YhG"/>\n',a+(b-e*c-5)/2,d+3,Math.round((e-5)/z.scale),e*c+5)}
function Vc(a,d,b,c,e,f){var g=c?Id:3.5,h=-b;0>b&&(g=-g);a+=g*z.scale;0>z.st&&(h/=z.scale);Z('<path class="stroke" d="mX YvF"/>\n',a,d,h);if(e){A.push('<path class="fill"\n\td="');d+=b;if(0<b)if(f)if(c)for(;0<=--e;)Z("MX Yl3 1.5 0 2 -3 -1.5z\n",a,d),d-=3;else for(d+=1;0<=--e;)Z("MX Yl7 3.2 0 3.2 -7 -3.2z\n",a,d),d-=5.4;else if(c)if(1==e)Z("MX Yc0.6 3.4 5.6 3.8 3 10\n\t1.2 -4.4 -1.4 -7 -3 -7\n",a,d);else for(;0<=--e;)Z("MX Yc1 3.2 5.6 2.8 3.2 8\n\t1.4 -4.8 -2.4 -5.4 -3.2 -5.2\n",a,d),d-=3.5;else if(1==
e)Z("MX Yc0.6 5.6 9.6 9 5.6 18.4\n\t1.6 -6 -1.3 -11.6 -5.6 -12.8\n",a,d);else for(;0<=--e;)Z("MX Yc0.9 3.7 9.1 6.4 6 12.4\n\t1 -5.4 -4.2 -8.4 -6 -8.4\n",a,d),d-=5.4;else if(!f)if(c)if(1==e)Z("MX Yc0.6 -3.4 5.6 -3.8 3 -10\n\t1.2 4.4 -1.4 7 -3 7\n",a,d);else for(;0<=--e;)Z("MX Yc1 -3.2 5.6 -2.8 3.2 -8\n\t1.4 4.8 -2.4 5.4 -3.2 5.2\n",a,d),d+=3.5;else if(1==e)Z("MX Yc0.6 -5.6 9.6 -9 5.6 -18.4\n\t1.6 6 -1.3 11.6 -5.6 12.8\n",a,d);else for(;0<=--e;)Z("MX Yc0.9 -3.7 9.1 -6.4 6 -12.4\n\t1 5.4 -4.2 8.4 -6 8.4\n",
a,d),d+=5.4;else if(!c)for(d+=1;0<=--e;)Z("MX Yl7 -3.2 0 -3.2 -7 3.2z\n",a,d),d+=5.4;A.push('"/>\n')}}function gi(a,d,b,c,e){e=e?-3:3;d+=e;b/=z.scale;A.push('<path class="stroke" d="m');vc(a," ",d);A.push("v"+e.toFixed(2)+"l"+b.toFixed(2)+" "+(-c).toFixed(2)+"v"+(-e).toFixed(2)+'"/>\n')}function Qe(a,d,b){Z('<path class="stroke" stroke-width="0.8" d="mX YhF"/>\n',a,d,b)}function Si(a,d,b,c){var e=Wj[b];e?(a+=e.dx,d+=e.dy,e.def||(wd+="\n."+b+" {"+e.style+"}",e.def=!0),Z('<text x="X" y="Y" class="A"B>',
a,d,b,e.anchor||""),Na("annotation"),Ni(c),A.push("</text>\n")):ia(a,d,b)}function Ti(a,d,b){cg(a,d,270);a=0;d=-4;for(b=Math.ceil(b/6);0<=--b;)ia(a,d,"ltr"),a+=6;dg()}function Ui(a,d,b){d+=4;for(b=Math.ceil(b/6);0<=--b;)ia(a,d,"ltr"),a+=6}function Mh(a,d,b,c,e){if(Vi[b])Vi[b](a,d,c,e);else X(1,null,"No function for decoration '$1'",b)}function la(a){Da+=a}function jg(){var a;if(!Ya&&0!=A.length&&R.img_out&&0!=Da){Da*=k.scale;a=R.imagesize?'<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n\txmlns:xlink="http://www.w3.org/1999/xlink"\n\tcolor="black"\n'+
R.imagesize+' viewBox="0 0 '+k.pagewidth.toFixed(0)+" "+Da.toFixed(0)+'">\n':'<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n\txmlns:xlink="http://www.w3.org/1999/xlink"\n\tcolor="black"\n\twidth="'+k.pagewidth.toFixed(0)+'px" height="'+Da.toFixed(0)+'px">\n';if(wd||ze||xd)a+='<style type="text/css">'+wd+ze+"\n",xd&&(a+='@font-face {\n  font-family: "music";\n  src: '+xd+"}\n"),a+="</style>\n";Rd&&(a+="<defs>"+Rd+"\n</defs>\n");k.bgcolor&&(a+='<rect width="100%" height="100%" fill="'+k.bgcolor+
'"/>\n');a=1==k.scale?a+'<g class="music" stroke-width=".7">\n':a+('<g class="music" stroke-width=".7" transform="scale('+k.scale.toFixed(2)+')">\n');Wb&&Wb.ps_flush(!0);R.img_out(a+A.join("")+"</g>\n</svg>");A=[];ze="";k.fullsvg?(Me={},hg={}):Rd=wd=xd="";Da=0}}function Cb(){!Ya&&A&&R.img_out&&(R.page_format&&!lc.started&&(lc.started=!0,lc.newpage?(lc.newpage=!1,R.img_out('<div class="nobrk newpage">')):R.img_out('<div class="nobrk">')),jg())}function Yc(){lc.started&&(lc.started=!1,R.img_out("</div>"))}
function ya(a){a.ctx||sd(a);h.ignore||(v.last_sym=a,(a.prev=h.last_sym)?h.last_sym.next=a:h.sym=a,h.last_sym=a);a.v=h.v;a.p_v=h;a.st=h.cst;a.time=h.time;a.dur&&!a.grace&&(h.time+=a.dur);a.pos=h.pos;h.second&&(a.second=!0);h.floating&&(a.floating=!0)}function Md(a,d){var b={type:d,dur:0},c;c=h;h=a;ya(b);h=c;c=b.prev;c||(c=b.next);c&&(b.ctx=c.ctx,b.istart=c.istart,b.iend=c.iend);return b}function Wi(a){var d,b,c,e=a.nmes,f=a.dur/e,g=a.a_dd;a.type=10;a.dur=f;a.head=0;a.nflags=-2;c=a.next;d=a.p_v;d.last_sym=
a;d.time=a.time+f;d.cst=a.st;for(b=a;0<--e;)b=Md(d,0),b.bar_type="|",b=Md(d,10),a.invis&&(b.invis=!0),b.dur=f,b.head=0,b.nflags=-2,d.time+=f;if(b.next=c)c.prev=b;b.a_dd=g}function Xi(){var a,d,b;(d=oa.tempo)&&0>=Ac&&(b=E.top_voice,a=x[b],a.sym&&14!=a.sym.type&&(d=T(d),d.v=b,d.p_v=a,d.st=a.st,d.time=0,d.next=a.sym,d.next&&(d.next.prev=d),a.sym=d));for(b=0;b<x.length;b++){a=x[b];a.ignore&&(a.ignore=!1);for(d=a.sym;d&&!(d.time>=Ac);d=d.next);for(;d;d=d.next){switch(d.type){case 4:d.next&&0==d.next.type&&
d.time--;if(!k.graceword)continue;for(a=d.next;a;a=a.next){switch(a.type){case 11:continue;case 8:a.a_ly&&(d.a_ly=a.a_ly,a.a_ly=null)}break}continue}if(d.feathered_beam){var c,e,f,g,h,q;c=d;f=c.dur;var n=1;for(q=c;q&&!q.beam_end&&q.next;q=q.next)n++;if(1>=n)delete c.feathered_beam;else{h=q;e=f/2;a=f/(n-1);g=c.time;if(0<c.feathered_beam)for(q=c,c=n-1;q!=h;q=q.next,c--)f=(a*c|0)+e,q.dur=f,q.time=g,g+=f;else for(q=c,c=0;q!=h;q=q.next,c++)f=(a*c|0)+e,q.dur=f,q.time=g,g+=f;q.dur=q.time+q.dur-g;q.time=
g}}}}}function Yi(){var a,d,b,c,e,f,g,l=x.length;for(f=0;f<l;f++)if(a=x[f],d=a.clone){a.clone=null;for(b=a.sym;b&&!(b.time>=Ac);b=b.next);d.clef=T(a.clef);for(h=d;b;b=b.next)if(12!=b.type){a=T(b);if(b.notes)for(a.notes=[],g=0;g<=b.nhd;g++)a.notes.push(T(b.notes[g]));ya(a);d.second?a.second=!0:delete a.second;d.floating?a.floating=!0:delete a.floating;delete a.a_ly;if(c=a.extra)for(e=T(c),a=a.extra=e,a.v=d.v,a.p_v=d,a.st=d.st,c=c.next;c;c=c.next){e=T(c);if(c.notes)for(e.notes=[],g=0;g<=c.nhd;g++)e.notes.push(T(c.notes[g]));
a.next=e;e.prev=a;a=e;a.v=d.v;a.p_v=d;a.st=d.st}}}}function Zi(a){var d,b={voices:[],staves:[],top_voice:0};if(a)B=E=b;else{for(a=0;a<x.length;a++){d=E.voices[a].st;d=E.staves[d];var c=x[a];void 0!=c.stafflines&&(d.stafflines=c.stafflines);c.staffscale&&(d.staffscale=c.staffscale);b.voices[a]=T(E.voices[a]);b.voices[a].range=-1;delete b.voices[a].second}for(d=0;d<E.staves.length;d++)b.staves[d]=T(E.staves[d]),b.staves[d].flags=0;E=E.next=b}}function Ie(){var a;if(!h.ckey.k_bagpipe&&!h.ckey.k_drum&&
(k.transp&&h.transp&&y(0,"Mix of old and new transposition syntaxes"),a=(k.transp||0)+(h.transp||0)+(h.shift||0),a!=(h.vtransp||0)))if(h.vtransp=a,a=h.last_sym){for(;5!=a.type;){if(!a.prev){a=h.key;break}a=a.prev}tf(a);h.ckey=T(a);h.key.k_none&&(a.k_sf=0)}else h.key=T(h.okey),tf(h.key),h.ckey=T(h.key),h.key.k_none&&(h.key.k_sf=0)}function Le(a){if(!k.sound)switch(a){case "15ma(":h.ottava=-14;break;case "8va(":h.ottava=-7;break;case "8vb(":h.ottava=7;break;case "15mb(":h.ottava=14;break;case "15ma)":case "8va)":case "8vb)":case "15mb)":h.ottava=
0}}function Be(a){var d,b,c,e=!1;a.match(/ lock$/)&&(e=!0,a=a.slice(0,-5).trim());if(b=a.match(/(\w|-)+/)){b=b[0];a=a.replace(b,"").trim();switch(b){case "break":b=a.split(" ");var f;oa["break"]=[];for(d in b)if(b.hasOwnProperty(d))if(a=b[d],e=a.indexOf(":"),0>e)oa["break"].push({m:a,n:0,d:1});else{f=a.indexOf("/");if(0>f){y(1,"'/' missing in %%break");break}c=parseInt(a.slice(f+1));if(isNaN(c)||1>=c){y(1,"Bad denominator in %%break");break}oa["break"].push({m:a.slice(0,e-1),n:a.slice(e+1,f-1),d:c})}return;
case "center":if(2<=v.state){b=mb(b);b.text=zc(a);return}ad(zc(a),"c");return;case "clef":2<=v.state&&(2==v.state&&nb(),(b=Ei(a))&&Hi(b));return;case "clip":return;case "deco":b=a.match(/(\S*)\s+(.*)/);we[b[1]]=b[2];return;case "linebreak":for(b=0;128>b;b++)if("\n"==wb[b]){wb[b]=I;break}a=a.split(/\s+/);for(b=0;b<a.length;b++){d=a[b];switch(d){case "!":case "$":case "*":case ";":case "?":case "@":break;case "<none>":continue;case "<EOL>":d="\n";break;default:y(1,"Bad value '$1' in %%linebreak - ignored",
d);continue}wb[d.charCodeAt(0)]="\n"}return;case "MIDI":b=a.split(/\s+/);switch(b[0]){case "program":b=b[2]?b[2]:b[1],b=parseInt(b),isNaN(b)||0>b||127<b?y(1,"Bad program in %%MIDI"):h?h.instr=b:oa.instr=b}return;case "map":a:if(a)if(b=rf(a,2),3>b.length)y(1,"Not enough parameters in %%map");else{c=b[1];if(0==c.indexOf("octave,")||0==c.indexOf("key,"))c=c.replace(/[,']+$/m,"").toLowerCase(),"k"==c[0]&&(c=c.replace(/[_=^]+/,""));else if("*"==c[0]||0==c.indexOf("all"))c="all";else{c=new hb;c.buffer=
b[1];d=mc(c);if(!d){y(1,"Bad note in %%map");break a}c="abcdefg"[(d.pit+77)%7];d.acc&&(c="__ _  ^ ^^ =".split(" ")[d.acc+2]+c);for(a=d.pit;28<=a;a-=7)c+="'";for(a=d.pit;21>a;a+=7)c+=","}(a=kc[b[0]])||(kc[b[0]]=a={});(d=a[c])||(a[c]=d=[]);if(b[2]){a=2;if(0>b[2].indexOf("=")){"*"!=b[2][0]&&(c=new hb,c.buffer=b[2],d[1]=mc(c));if(!b[3])break a;a++;0>b[3].indexOf("=")&&(d[0]=b[3].split(","),a++)}for(;a<b.length;a++)switch(b[a]){case "heads=":d[0]=b[++a].split(",");break;case "print=":c=new hb;c.buffer=
b[++a];d[1]=mc(c);break;case "color=":d[2]=b[++a]}}}return;case "maxsysstaffsep":if(3==v.state){E.voices[h.v].maxsep=Wc(a);return}break;case "multicol":oi();switch(a){case "start":Cb();Ya={posy:Da,maxy:Da,lmarg:k.leftmargin,rmarg:k.rightmargin,state:v.state};break;case "new":if(!Ya){y(1,"%%multicol new without start");break}Da>Ya.maxy&&(Ya.maxy=Da);3==v.state?(b=mb("leftmargin"),b.param=Ya.lmarg.toFixed(2),b=mb("rightmargin"),b.param=Ya.rmarg.toFixed(2)):(k.leftmargin=Ya.lmarg,rd(),k.rightmargin=
Ya.rmarg);Da=Ya.posy;break;case "end":if(!Ya){y(1,"%%multicol end without start");break}Da<Ya.maxy&&(Da=Ya.maxy);3==v.state?(b=mb("leftmargin"),b.param=Ya.lmarg.toFixed(2),b=mb("rightmargin"),b.param=Ya.rmarg.toFixed(2)):(k.leftmargin=Ya.lmarg,rd(),k.rightmargin=Ya.rmarg);Ya=void 0;Cb();break;default:y(1,"Unknown keyword '$1' in %%multicol",a)}return;case "musicfont":xd=a;return;case "ottava":if(3!=v.state){if(2!=v.state)return;nb()}b=parseInt(a);if(isNaN(b)||-2>b||2<b){y(1,xc,"%%ottava");return}switch(h.ottava){case 14:c=
"15mb)";break;case 7:c="8vb)";break;case -7:c="8va)";break;case -14:c="15ma)"}c&&(za||(za=[]),za.push(c),Le(c));switch(b){case -2:c="15mb(";break;case -1:c="8vb(";break;case 0:return;case 1:c="8va(";break;case 2:c="15ma("}za||(za=[]);za.push(c);Le(c);return;case "repbra":2<=v.state&&(2==v.state&&nb(),h.norepbra=!eg(a));return;case "repeat":if(3!=v.state)return;if(!h.last_sym){y(1,"%%repeat cannot start a tune");return}if(a.length){c=a.split(/\s+/);b=parseInt(c[0]);a=parseInt(c[1]);if(isNaN(b)||1>
b||0==h.last_sym.type&&2<b){y(1,"Incorrect 1st value in %%repeat");return}if(isNaN(a))a=1;else if(1>a){y(1,"Incorrect 2nd value in %%repeat");return}}else a=b=1;v.repeat_n=0==h.last_sym.type?b:-b;v.repeat_k=a;return;case "sep":f=k.pagewidth-k.leftmargin-k.rightmargin;d=c=e=0;a&&(a=a.split(/\s+/),d=Wc(a[0]),a[1]&&(c=Wc(a[1]),a[2]&&(e=Wc(a[2]))));1>d&&(d=14);1>c&&(c=d);1>e&&(e=90);if(2<=v.state){b=mb(b);b.x=(f-e)/2/k.scale;b.l=e/k.scale;b.sk1=d;b.sk2=c;return}la(d);A.push('<path class="stroke"\n\td="M');
vc((f-e)/2/k.scale," ",0);A.push("h"+(e/k.scale).toFixed(2)+'"/>\n');la(c);Cb();return;case "setbarnb":d=parseInt(a);isNaN(d)?y(1,"Bad %%setbarnb value"):2<=v.state?oa.new_nbar=d:k.measurefirst=d;return;case "staff":if(3!=v.state){if(2!=v.state)return;nb()}d=parseInt(a);if(isNaN(d)){y(1,"Bad %%staff value '$1'",a);return}b="+"==a[0]||"-"==a[0]?h.cst+d:d-1;if(0>b||b>M){y(1,"Bad %%staff number $1 (cur $2, max $3)",b,h.cst,M);return}delete h.floating;h.cst=b;return;case "staffbreak":if(3!=v.state){if(2!=
v.state)return;nb()}b={type:13,dur:0};"0"<=a[0]&&"9">=a[0]?(b.xmx=Wc(a),"f"==a.slice(-1)&&(b.stbrk_forced=!0)):(b.xmx=14,"f"==a[0]&&(b.stbrk_forced=!0));ya(b);return;case "stafflines":d=Gi(a);void 0==d?y(1,"Bad %%stafflines value"):yc(b,d);return;case "staffscale":d=parseFloat(a);isNaN(d)||.3>d||2<d?y(1,"Bad %%staffscale value"):yc(b,d);return;case "staves":case "score":if(0==v.state)return;var g,l;c=[];for(var e=!1,q=l=g=f=0,n=0,m=0;m<a.length;){switch(a[m]){case " ":case "\t":break;case "[":if(q||
2<=g+l){y(1,bd,"[");e=!0;break}f|=0==g+l?4:1024;l++;n<<=8;n|=4;break;case "{":if(q||g||2<=l){y(1,bd,"{");e=!0;break}f|=l?256:1;g++;n<<=8;n|=1;break;case "(":if(q){y(1,bd,"(");e=!0;break}f|=16;q++;n<<=8;n|=16;break;case "*":!g||q||f&257||(f|=128);break;case "+":f|=4096;break;default:if(a[m].match(/\w/)){for(d="";m<a.length&&!(0<=" \t()[]{}|*".indexOf(a[m]));)d+=a[m++];for(;m<a.length;m++){switch(a[m]){case " ":case "\t":continue;case "]":if(!(n&4)){y(1,bd,"]");e=!0;break}l--;f|=0==g+l?8:2048;n>>=8;
continue;case "}":if(!(n&1)){y(1,bd,"}");e=!0;break}g--;f|=l?512:2;f&=-129;n>>=8;continue;case ")":if(!(n&16)){y(1,bd,")");e=!0;break}q--;f|=32;n>>=8;continue;case "|":f|=64;continue}break}c.push([d,f]);f=0;continue}else y(1,"Bad voice ID in %%staves"),e=!0}m++}0!=n&&(y(1,"'}', ')' or ']' missing in %%staves"),e=!0);a=e||0==c.length?void 0:c;if(a){0!=x.length&&(Xi(),Yi());d=0;e=!0;for(f=0;f<x.length;f++)c=x[f],c.time>d&&(d=c.time),c.sym&&(e=!1);if(e||0==d&&0>Ac)for(f=0;f<E.voices.length;f++)E.voices[f].range=
-1;else{for(f=0;f<E.voices.length;f++)if(0<=E.voices[f].range){h=x[f];break}h.time=d;c={type:12,dur:0};(e=h.last_sym)&&0==e.type&&e.time==d?(h.last_sym=e.prev,e.prev||(h.sym=e.prev),ya(c),c.next=e,e.prev=c,h.last_sym=e,e.eoln&&(c.eoln=!0,delete e.eoln)):ya(c);E.nstaff=M;Zi();c.sy=E}Ac=d;for(f=0;f<x.length;f++)c=x[f],delete c.second,delete c.ignore,delete c.floating;for(e=l=0;e<a.length;e++){c=a[e][0];c=He(c);c.time=d;f=c.v;0==e&&(E.top_voice=c.v);if(0<=E.voices[f].range){g=T(c);E.voices[x.length]=
T(E.voices[f]);f=x.length;g.v=f;g.sym=g.last_sym=null;g.time=d;x.push(g);for(delete g.clone;c.clone;)c=c.clone;c=c.clone=g}a[e][0]=c;E.voices[f].range=l++}if("t"==b[1])for(e=0;e<a.length;e++)g=a[e][1],g&257&&3!=(g&3)&&768!=(g&768)&&0==a[e+1][1]&&!(g&16||a[e+2][1]&16)&&(a[e+2][1]&514?a[e+1][1]|=128:0==a[e+2][1]&&a[e+3][1]&514&&(a[e][1]|=16,a[e+1][1]|=32,a[e+2][1]|=16,a[e+3][1]|=32));d=-1;for(e=0;e<a.length;e++)if(g=a[e][1],48==(g&48)&&(g&=-49,a[e][1]=g),c=a[e][0],g&128?(c.floating=!0,c.second=!0):
(d++,E.staves[d]||(E.staves[d]={stafflines:"|||||",staffscale:1}),E.staves[d].flags=0),f=c.v,c.st=c.cst=E.voices[f].st=d,E.staves[d].flags|=g,g&16){for(g=c;e<a.length-1&&!(c=a[++e][0],f=c.v,a[e][1]&4096?(g.second=!0,g=c):c.second=!0,c.st=c.cst=E.voices[f].st=d,a[e][1]&32););E.staves[d].flags|=a[e][1]}0>d&&(d=0);E.nstaff=M=d;if("c"==b[1])for(d=0;d<M;d++)E.staves[d].flags^=64;for(f=0;f<x.length;f++)c=x[f],0>E.voices[f].range?c.ignore=!0:(E.voices[f].second=c.second,d=c.st,!(0<d)||c.norepbra||E.staves[d-
1].flags&64||(c.norepbra=!0));h=2<=v.state?x[E.top_voice]:null}return;case "sysstaffsep":if(3==v.state){E.voices[h.v].sep=Wc(a);return}break;case "text":if(2<=v.state){b=mb(b);b.text=zc(a);b.opt=k.textoption;return}ad(zc(a),k.textoption);return;case "transpose":if(k.sound)return;switch(v.state){case 0:k.transp=0;case 1:case 2:k.transp=(k.transp||0)+td(a);return}for(b=h.last_sym;b;b=b.prev){switch(b.type){case 8:b=T(h.okey);b.k_old_sf=h.ckey.k_sf;ya(b);break;case 5:break;default:continue}break}Ld("V",
h.id+" shift="+a);return;case "tune":return;case "user":Fi(a);return;case "voicecolor":if(3!=v.state){if(2!=v.state)return;nb()}h.color=a;return;case "vskip":d=Wc(a);if(0>d){y(1,"%%vskip cannot be negative");return}if(2<=v.state){b=mb(b);b.sk=d;return}la(d);Cb();return;case "newpage":case "leftmargin":case "rightmargin":case "pagescale":case "pagewidth":case "print-leftmargin":case "scale":case "staffwidth":if(3==v.state){b=mb(b);b.param=a;return}if("newpage"==b){Yc();lc.newpage=!0;return}Qg(b,a,
e);switch(b){case "leftmargin":case "pagescale":case "print-leftmargin":case "scale":rd()}return}Qg(b,a,e)}}function Bj(a,d,b){var c;switch(a){default:Wb&&Wb.ps_eval(b);break;case "js":eval(b);break;case "ml":2<=v.state?(a=mb(a),a.text=b):(jg(),R.img_out(b));break;case "svg":for(a=0;;)if(d=b.indexOf('<style type="text/css">\n',a),0<=d){a=b.indexOf("</style>",d);if(0>a){y(1,"No </style> in %%beginsvg sequence");break}wd+=b.slice(d+23,a).replace(/\s+$/,"")}else if(d=b.indexOf("<defs>",a),0<=d){a=b.indexOf("</defs>",
d);if(0>a){y(1,"No </defs> in %%beginsvg sequence");break}Sj(b.slice(d+6,a))}else break;break;case "text":c=gg[d],2<=v.state?(a=mb(a),a.text=zc(b),a.opt=gg[d]):ad(zc(b),c)}}function oi(){var a,d;if(0!=x.length){Xi();Yi();var b,c,e,f,g,h,q,n,m,v=x.length,p=[],u=[],t=-1;for(c=0;c<v;c++)p.push(x[c].sym);for(var w=1,y=B,E=0,I=0,za=1;;){if(za&&w)for(za=!1,q=-1,u=[],c=0;c<v;c++)y.voices[c]?(h=y.voices[c].range,0>h||(u[h]=c,q++)):y.voices[c]={range:-1};g=e=1E6;for(h=0;h<v;h++){c=u[h];if(void 0==c)break;
!(b=p[c])||b.time>e||(f=Nh[b.type],b.time<e?(e=b.time,g=f):f<g&&(g=f),7==b.type&&(1==b.nmes?Wi(b):0<q&&(t=e)))}if(127<g){if(za&&!w){w=1;continue}break}if(e==t){for(h=m=0;h<v;h++){c=u[h];if(void 0==c)break;if((b=p[c])&&b.time==e&&Nh[b.type]==g){if(7!=b.type){t=-1;break}if(0==m)m=b.nmes;else if(m!=b.nmes){t=-1;break}}}if(0>t)for(h=0;h<v;h++){c=u[h];if(void 0==c)break;(b=p[c])&&7==b.type&&Wi(b)}}E&&(0>E?E=g:I==e&&E==g?w=0:E=0);for(h=0;h<v;h++){c=u[h];if(void 0==c)break;(b=p[c])&&b.time==e&&Nh[b.type]==
g&&(12==b.type&&(y=b.sy,za=!0,E=-1,I=b.time),w&&(w=0,b.seqst=!0),(b.ts_prev=n)?n.ts_next=b:Q=b,n=b,p[c]=b.next)}w=g}if(Q){a:{var ta,ya,Ya,ib=B.top_voice,nb=x[ib].meter.wmeasure,wb=D.nbar;for(ta=Q;;ta=ta.ts_next){if(!ta)break a;switch(ta.type){case 6:case 1:case 5:case 13:continue;case 0:ta.bar_num?D.nbar=ta.bar_num:ta.text&&!k.contbarnb&&("1"==ta.text[0]?wb=D.nbar:(D.nbar=wb,ta.bar_num=D.nbar))}break}for(var mb=ta.time+nb,hb=D.nbar;ta;ta=ta.ts_next)switch(ta.type){case 6:nb=ta.wmeasure;ta.time<mb&&
(mb=ta.time+nb);break;case 7:for(hb+=ta.nmes-1;ta.ts_next&&0!=ta.ts_next.type;)ta=ta.ts_next;break;case 0:if(ta.bar_num){if(hb=ta.bar_num,ta.time<mb){delete ta.bar_num;break}}else{if(ta.time<mb)break;hb++}Ya=ta.time;ya=ta;do{if(0==ya.type&&ya.text&&!k.contbarnb){"1"==ya.text[0]?wb=hb:hb=wb;break}ya=ya.next}while(ya&&ya.time==Ya);ta.bar_num=hb;mb=ta.time+nb}if(oa["break"]){var Vb,Bb,xc,jc,zc,Bc;for(Bb=0;Bb<oa["break"].length;Bb++){xc=oa["break"][Bb].m;jc=oa["break"][Bb].n;zc=oa["break"][Bb].d;for(Vb=
x[ib].sym;Vb&&(0!=Vb.type||Vb.bar_num!=xc);Vb=Vb.next);if(Vb){if(0!=jc){for(Bc=Vb.time+jc/zc;Vb&&!(Vb.time>Bc);Vb=Vb.next);if(!Vb)continue}Vb.eoln=!0}}}0>k.measurenb&&(D.nbar=hb)}if(Q&&(R.get_abcmodel&&R.get_abcmodel(Q,x,Pi,L),R.img_out)){var Wc,lc,Wb,yd,od;Di(!0);if(Q){var vc,wc,yc,vd,Re;Re=B;for(wc=Re.nstaff;;){Re=Re.next;if(!Re)break;Re.nstaff>wc&&(wc=Re.nstaff)}M=wc;vd=x.length;for(yc=0;yc<vd;yc++){vc=x[yc];for(var kc=void 0,Zc=void 0,mc=void 0,aa=void 0,nc=!0,bd=127,aa=vc.sym;aa;aa=aa.next)if(8==
aa.type){bd=aa.notes[0].pit;break}for(aa=vc.sym;aa;aa=aa.next){switch(aa.type){case 7:nc=!0;break;case 0:aa.beam_on||(nc=!0);!aa.next&&aa.prev&&3==aa.prev.head&&(aa.prev.head=4);break;case 8:case 10:if(!aa.trem2){Zc=aa.nflags;aa.ntrem&&(Zc+=aa.ntrem);10==aa.type&&aa.beam_end&&(aa.beam_end=!1,nc=!0);if(nc||0>=Zc)kc&&(kc.beam_end=!0,kc=null),0>=Zc?(aa.beam_st=!0,aa.beam_end=!0):8==aa.type&&(aa.beam_st=!0,nc=!1);aa.beam_end&&(nc=!0);8==aa.type&&(kc=aa)}}if(8==aa.type)for(0!=aa.nhd&&Gh(aa),bd=aa.notes[0].pit,
mc=aa.prev;mc&&10==mc.type;mc=mc.prev)mc.notes[0].pit=bd;else aa.notes||(aa.notes=[],aa.notes[0]={},aa.nhd=0),aa.notes[0].pit=bd}kc&&(kc.beam_end=!0);for(var ee=void 0,nd=void 0,Vc=void 0,ka=vc.sym;ka;)if(0!=ka.type||!ka.rbstart||ka.norepbra)ka=ka.next;else{nd=k.rbmax;if(ka.text&&"1"==ka.text[0]){ee=0;Vc=null;for(ka=ka.next;ka;ka=ka.next)if(0==ka.type){ee++;if(ka.rbstop){ee<=k.rbmax&&(nd=ee,Vc=null);break}ee==k.rbmin&&(Vc=ka)}Vc&&(Vc.rbstop=1,nd=k.rbmin)}for(;ka;){if(2!=ka.rbstart){ka=ka.next;if(!ka)break;
if(2!=ka.rbstart){ka=ka.next;if(!ka)break;if(2!=ka.rbstart)break}}ee=0;for(ka=ka.next;ka;ka=ka.next)if(0==ka.type){ee++;if(ka.rbstop)break;ka.next?ee==nd&&(ka.rbstop=1):ka.rbstop=2}}}}var Id,Kd,Cc,qd,Ea,cb,fe,Sd;for(qd=0;qd<x.length;qd++)for(Id=x[qd],Cc=!1,Kd=Id.st,Ea=Id.sym;Ea;Ea=Ea.next){if(!Ea.floating){for(;Ea&&!Ea.floating;)Ea=Ea.next;if(!Ea)break;Cc=!1}if(Ea.dur)if(19<=Ea.notes[0].pit)Cc=!1;else if(12>=Ea.notes[Ea.nhd].pit)Cc=!0,Ea.st++;else{fe=127;for(cb=Ea.ts_prev;cb&&cb.st==Kd&&cb.v!=Ea.v;cb=
cb.ts_prev)8==cb.type&&cb.notes[0].pit<fe&&(fe=cb.notes[0].pit);if(127==fe)Cc&&Ea.st++;else if(Ea.notes[Ea.nhd].pit>fe-3)Cc=!1;else{Sd=-127;for(cb=Ea.ts_next;cb&&cb.st==Kd+1&&cb.v!=Ea.v;cb=cb.ts_next)8==cb.type&&cb.notes[cb.nhd].pit>Sd&&(Sd=cb.notes[cb.nhd].pit);if(-127==Sd)Cc&&Ea.st++;else{if(Ea.notes[0].pit<Sd+3)Cc=!0;else if(fe-=Ea.notes[Ea.nhd].pit,Sd=Ea.notes[0].pit-Sd,!Cc){if(fe<Sd+3)continue;Cc=!0}else if(fe<Sd-3){Cc=!1;continue}Ea.st++}}}else Cc&&Ea.st++}var ea,Dc,U,V,Ta,Td,wf,Yc,rd,ob=Array(M),
pa=B;r=Array(M);for(U=0;U<=M;U++)ob[U]={autoclef:!0},r[U]={output:[],sc_out:[]};for(V=0;V<x.length;V++)Ta=x[V],0>pa.voices[V].range||(U=pa.voices[V].st,pa.voices[V].second||(void 0!=Ta.stafflines&&(pa.staves[U].stafflines=Ta.stafflines),Ta.staffscale&&(pa.staves[U].staffscale=Ta.staffscale),pa.voices[V].sep&&(pa.staves[U].sep=pa.voices[V].sep),pa.voices[V].maxsep&&(pa.staves[U].maxsep=pa.voices[V].maxsep)),pa.voices[V].second||Ta.clef.clef_auto||(ob[U].autoclef=!1));for(V=0;V<x.length;V++)Ta=x[V],
0>pa.voices[V].range||pa.voices[V].second||(U=pa.voices[V].st,ea=Ta.clef,ob[U].autoclef&&(ea.clef_type=Jh(U,Q,ea.clef_type),ea.clef_line="t"==ea.clef_type?2:4),ob[U].clef=r[U].clef=ea);for(ea=Q;ea;ea=ea.ts_next){if(ea.repeat_n)b:{var $c=void 0,ad=void 0,Mb=void 0,P=void 0,F=void 0,db=ea,Ec=db.repeat_n,Se=db.repeat_k,sd=db.st,td=db.v;db.repeat_n=0;if(0>Ec){Mb=Ec=-Ec;for(P=db.prev;P;P=P.prev)if(!P.dur){if(0==P.type){X(1,P,"Bar in repeat sequence");break b}}else if(0>=--Mb)break;if(P){Mb=Se*Ec;for(F=
db;F;F=F.next)if(!F.dur){if(0==F.type){X(1,F,"Bar in repeat sequence");break b}}else if(0>=--Mb)break;if(F&&F.next){for(F=db.prev;F!=P;F=F.prev)if(8==F.type){F.beam_end=!0;break}P=db;for(ad=Se;0<=--ad;){Mb=Ec;P.dur&&Mb--;for(F=P.ts_next;0<Mb;)F.st==sd&&(F.v==td&&F.dur&&Mb--,gc(F),F=F.ts_next);Sg(P);P.dur=P.notes[0].dur=F.time-P.time;P.rep_nb=-1;P.beam_st=!0;of(P);P.seqst&&(P.space=Nd(P));P.head=4;P=F}}else X(1,db,$i)}else X(1,db,$i)}else{Mb=Ec;for(F=db.prev.prev;F&&(0!=F.type&&F.time!=Q.time||!(0>=
--Mb));F=F.prev);if(F){$c=db.time-F.time;Mb=1==Ec?Se:Ec;for(F=db;F&&!(0==F.type&&0>=--Mb);F=F.next);if(F){Mb=Se;if(2==Ec&&1<Mb){F=F.next;if(!F){X(1,db,Oh);break b}F.repeat_n=Ec;F.repeat_k=--Mb}$c/=Ec;if(2==Ec){P=db;for(F=db.ts_next;;F=F.ts_next)if(F.st==sd){if(F.v==td&&0==F.type)break;gc(F)}Sg(P);P.dur=P.notes[0].dur=$c;P.invis=!0;P.seqst&&(P.space=Nd(P));F.bar_mrep=2;F.seqst&&(F.space=Nd(F));P=F.next;for(F=P.ts_next;;F=F.ts_next)if(F.st==sd){if(F.v==td&&0==F.type)break;gc(F)}Sg(P);P.dur=P.notes[0].dur=
$c;P.invis=!0;of(P);P.seqst&&(P.space=Nd(P));F.seqst&&(F.space=Nd(F))}else for(P=db,ad=Se;0<=--ad;){for(F=P.ts_next;;F=F.ts_next)if(F.st==sd){if(F.v==td&&0==F.type)break;gc(F)}Sg(P);P.dur=P.notes[0].dur=$c;P.beam_st=!0;P.seqst&&(P.space=Nd(P));F.seqst&&(F.space=Nd(F));if(1==Se){P.rep_nb=1;break}P.rep_nb=Se-ad+1;P=F.next}}else X(1,db,Oh)}else X(1,db,Oh)}}if(12==ea.type){pa=ea.sy;for(U=0;U<=M;U++)ob[U].autoclef=!0;for(V=0;V<x.length;V++)0>pa.voices[V].range||(Ta=x[V],U=pa.voices[V].st,pa.voices[V].second||
(void 0!=Ta.stafflines&&(pa.staves[U].stafflines=Ta.stafflines),Ta.staffscale&&(pa.staves[U].staffscale=Ta.staffscale),pa.voices[V].sep&&(pa.staves[U].sep=pa.voices[V].sep),pa.voices[V].maxsep&&(pa.staves[U].maxsep=pa.voices[V].maxsep)),Dc=Ta.clef,Dc.clef_auto||(ob[U].autoclef=!1));for(V=0;V<x.length;V++)if(!(0>pa.voices[V].range||pa.voices[V].second))if(Ta=x[V],U=pa.voices[V].st,Dc=Ta.clef,Dc.clef_auto?(wf=Jh(U,ea,ob[U].clef?ob[U].clef.clef_type:"a"),Yc="t"==wf?2:4):(wf=Dc.clef_type,Yc=Dc.clef_line),
!ob[U].clef)Dc.clef_auto&&("a"!=Dc.type&&(Ta.clef=T(Ta.clef)),Ta.clef.clef_type=wf,Ta.clef.clef_line=Yc),r[U].clef=ob[U].clef=Ta.clef;else if(wf!=ob[U].clef.clef_type||Yc!=ob[U].clef.clef_line){for(Td=ea;Td.v!=V;)Td=Td.ts_next;1!=Td.type&&(Td=ui(Td,wf,Yc),Dc.clef_auto&&(Td.clef_auto=!0));ob[U].clef=Ta.clef=Td}}else if(1==ea.type)if("a"==ea.clef_type&&(ea.clef_type=Jh(ea.st,ea.ts_next,ob[ea.st].clef.clef_type),ea.clef_line="t"==ea.clef_type?2:4),Ta=ea.p_v,Ta.clef=ea,ea.second)gc(ea);else{U=ea.st;if(ob[U].clef){if(ea.clef_type==
ob[U].clef.clef_type&&ea.clef_line==ob[U].clef.clef_line)continue}else r[U].clef=ea;ob[U].clef=ea}}pa=B;for(V=0;V<x.length;V++)if(!(0>pa.voices[V].range)&&(Dc=x[V].sym)&&127==Dc.notes[0].pit){U=pa.voices[V].st;switch(r[U].clef.clef_type){default:rd=22;break;case "c":rd=16;break;case "b":rd=10}for(ea=Dc;ea;ea=ea.next)ea.notes[0].pit=rd}zi(null);if(1<x.length){var Nb,Db;for(Nb=Q;Nb.ts_next;Nb=Nb.ts_next){switch(Nb.type){case 10:if(0>Nb.combine)continue;Rg(Nb)&&Fh(Nb);continue;default:continue;case 8:if(0>=
Nb.combine)continue}if(Nb.beam_st)if(Nb.beam_end)Rg(Nb)&&Fh(Nb);else{for(Db=Nb;;){if(!Rg(Db)){Db=null;break}if(Db.beam_end)break;do Db=Db.next;while(8!=Db.type&&10!=Db.type)}if(Db)for(Db=Nb;;){Fh(Db);if(Db.beam_end)break;do Db=Db.next;while(8!=Db.type&&10!=Db.type)}}}for(var ud,Oa,jb,Ua,xf,ge,eb,Eb,Ud,wd,xd=[],ca=Q,yf=B,lg=yf.nstaff;ca;){for(Ua=0;Ua<=lg;Ua++)xd[Ua]=[];wd=[];for(Oa=ca;Oa&&0!=Oa.type;Oa=Oa.ts_next)if(12==Oa.type){if(Oa!=ca)break;yf=ca.sy;for(Ua=lg;Ua<=yf.nstaff;Ua++)xd[Ua]=[];lg=yf.nstaff}else if(!(8!=
Oa.type&&10!=Oa.type||Oa.invis)){Ua=Oa.st;if(Ua>lg){var we="*** fatal set_stem_dir(): bad staff number "+Ua+" max "+lg;X(2,null,we);throw Error(we);}ge=Oa.v;eb=wd[ge];eb||(eb={st1:-1,st2:-1},wd[ge]=eb);0>eb.st1?eb.st1=Ua:eb.st1!=Ua&&(Ua>eb.st1?Ua>eb.st2&&(eb.st2=Ua):(eb.st1>eb.st2&&(eb.st2=eb.st1),eb.st1=Ua));Eb=xd[Ua];xf=yf.voices[ge].range;for(jb=Eb.length;0<=--jb&&(Ud=Eb[jb],Ud.v!=xf););if(0>jb){Ud={v:xf,ymx:0,ymn:24};for(jb=0;jb<Eb.length;jb++)if(xf<Eb[jb].v){Eb.splice(jb,0,Ud);break}jb==Eb.length&&
Eb.push(Ud)}8==Oa.type&&(Oa.ymx>Ud.ymx&&(Ud.ymx=Oa.ymx),Oa.ymn<Ud.ymn&&(Ud.ymn=Oa.ymn),Oa.xstem&&(Oa.ts_prev.st!=Ua-1||8!=Oa.ts_prev.type?(X(1,ca,"Bad !xstem!"),Oa.xstem=!1):(Oa.ts_prev.multi=1,Oa.multi=1,Oa.stemless=!0)))}for(;ca!=Oa;ca=ca.ts_next)if(!ca.multi&&(8==ca.type||10==ca.type||4==ca.type))if(Ua=ca.st,ge=ca.v,eb=wd[ge],Eb=xd[Ua],eb&&0<=eb.st2)Ua==eb.st1?ca.multi=-1:Ua==eb.st2&&(ca.multi=1);else if(1>=Eb.length)ca.floating&&(ca.multi=Ua==x[ge].st?-1:1);else{xf=yf.voices[ge].range;for(jb=
Eb.length;0<=--jb&&Eb[jb].v!=xf;);0>jb||(jb==Eb.length-1?ca.multi=-1:(ca.multi=1,0!=jb&&jb+2==Eb.length&&(Eb[jb].ymn-k.stemheight>Eb[jb+1].ymx&&(ca.multi=-1),ud=ca.ts_next,ca.ts_prev&&ca.ts_prev.time==ca.time&&ca.ts_prev.st==ca.st&&ca.notes[ca.nhd].pit==ca.ts_prev.notes[0].pit&&ca.beam_st&&ca.beam_end&&(!ud||ud.st!=ca.st||ud.time!=ca.time)&&(ca.multi=-1))))}for(;ca&&0==ca.type;)ca=ca.ts_next}}for(lc=0;lc<x.length;lc++)for(var mg=void 0,ng=void 0,ce=void 0,og=void 0,Jd=void 0,Fc=void 0,pb=void 0,ha=
void 0,he=-1,ze=0,ha=x[lc].sym;ha;ha=ha.next)if(8!=ha.type){if(4==ha.type)if(Fc=ha.extra,2==Fc.stem)og=ha;else for(ha.stem||0!=(ha.stem=ha.multi)||(ha.stem=1);Fc;Fc=Fc.next)Fc.stem=ha.stem,Fc.multi=ha.multi}else{if(ha.stem||0!=(ha.stem=ha.multi))ha.beam_st&&!ha.beam_end&&(Jd=!0);else if(Jd)ha.stem=he;else if(ha.beam_st&&!ha.beam_end){ng=ha.yav;mg=12;for(pb=ha.next;pb;pb=pb.next){if(8==pb.type){if(pb.multi){ng=mg-pb.multi;break}ng+=pb.yav;mg+=12}if(pb.beam_end)break}if(ng<mg)he=1;else if(ng>mg||k.bstemdown)he=
-1;Jd=!0;ha.stem=he}else if(ha.stem=12<=ha.yav?-1:1,12==ha.yav&&!k.bstemdown)if(ha.prev&&0!=ha.prev.type)ce=ha.yav-ze,-7<ce&&7>ce&&(ha.stem=he);else{for(pb=ha.next;pb&&8!=pb.type&&0!=pb.type;pb=pb.next);pb&&8==pb.type&&12>pb.yav&&(ha.stem=1)}ha.beam_end&&(Jd=!1);he=ha.stem;ze=ha.yav;if(og){for(Fc=og.extra;Fc;Fc=Fc.next)Fc.stem=-he;og.stem=-he;og=null}}var J,Xb,xb,kb,Ae,qb,yb,cd,Ld,Md;for(J=Q;J;J=J.ts_next)if(8!=J.type){if(4==J.type){Ld=Md=12;for(xb=J.extra;xb;xb=xb.next)kb=15,1<xb.nflags&&(kb+=1.2*
(xb.nflags-1)),qb=3*(xb.notes[0].pit-18),yb=3*(xb.notes[xb.nhd].pit-18),0<=J.stem?(xb.y=qb,xb.ys=yb+kb,yb=Math.round(xb.ys)):(xb.y=yb,xb.ys=qb-kb,qb=Math.round(xb.ys)),yb+=2,qb-=2,qb<Ld?Ld=qb:yb>Md&&(Md=yb),xb.ymx=yb,xb.ymn=qb;J.ymx=Md;J.ymn=Ld}}else{ri(J);cd=J.nflags;if(J.beam_st&&!J.beam_end){J.feathered_beam&&(cd=++J.nflags);for(Xb=J.next;8!=Xb.type||(J.feathered_beam&&Xb.nflags++,!Xb.beam_end);Xb=Xb.next);Xb.nflags>cd&&(cd=Xb.nflags)}else if(!J.beam_st&&J.beam_end){for(Xb=J.prev;!Xb.beam_st;Xb=
Xb.prev);Xb.nflags>cd&&(cd=Xb.nflags)}kb=k.stemheight;switch(cd){case 2:kb+=2;break;case 3:kb+=5;break;case 4:kb+=10;break;case 5:kb+=16}1!=(Ae=J.p_v.scale)&&(kb*=.5*(Ae+1));qb=3*(J.notes[0].pit-18);0<J.nhd?(kb-=2,yb=3*(J.notes[J.nhd].pit-18)):yb=qb;J.ntrem&&(kb+=2*J.ntrem);J.stemless?(0<=J.stem?(J.y=qb,J.ys=yb):(J.ys=qb,J.y=yb),-4==cd&&(qb-=6),J.ymx=yb+4,J.ymn=qb-4):0<=J.stem?(2<=cd&&--kb,26<J.notes[J.nhd].pit&&(0>=cd||!J.beam_st||!J.beam_end)&&(kb-=2,28<J.notes[J.nhd].pit&&(kb-=2)),J.y=qb,J.notes[0].ti1&&
(qb-=3),J.ymn=qb-4,J.ys=yb+kb,12>J.ys&&(J.ys=12),J.ymx=J.ys+2.5|0):(18>J.notes[0].pit&&(0>=cd||!J.beam_st||!J.beam_end)&&(kb-=2,16>J.notes[0].pit&&(kb-=2)),J.ys=qb-kb,12<J.ys&&(J.ys=12),J.ymn=J.ys-2.5|0,J.y=yb,J.notes[J.nhd].ti1&&(yb+=3),J.ymx=yb+4)}if(1<x.length){var H,na,zf,He,Od,Gc,Hc,Ic,Va,Te,Af,Pd=[],pg=B;for(H=Q;H;H=H.ts_next)if(!H.invis&&(12==H.type&&(pg=H.sy),H.dur&&(Gc=Pd[H.v],Gc||(Gc={},Pd[H.v]=Gc),Gc.s=H,Gc.st=H.st,Gc.end_time=H.time+H.dur,10==H.type))){Ic=-127;Hc=127;Od=Te=!1;for(zf=0;zf<=
Pd.length;zf++)!(Gc=Pd[zf])||!Gc.s||Gc.st!=H.st||zf==H.v||Gc.end_time<=H.time||(Od=!0,na=Gc.s,pg.voices[zf].range<pg.voices[H.v].range?na.time==H.time?na.ymn<Hc&&(Hc=na.ymn,na.dots&&(Te=!0)):na.y<Hc&&(Hc=na.y):na.time==H.time?na.ymx>Ic&&(Ic=na.ymx,na.dots&&(Te=!0)):na.y>Ic&&(Ic=na.y));He=H.time+H.dur;for(na=H.ts_next;na&&!(na.time>=He);na=na.ts_next)na.st==H.st&&na.dur&&!na.invis&&(Od=!0,pg.voices[na.v].range<pg.voices[H.v].range?na.time==H.time?na.ymn<Hc&&(Hc=na.ymn,na.dots&&(Te=!0)):na.y<Hc&&(Hc=
na.y):na.time==H.time?na.ymx>Ic&&(Ic=na.ymx,na.dots&&(Te=!0)):na.y>Ic&&(Ic=na.y));Od?(127==Hc&&12>H.y&&(Va=12-H.y,H.y+=Va,H.ymx+=Va,H.ymn+=Va),-127==Ic&&12<H.y&&(Va=H.y-12,H.y-=Va,H.ymx-=Va,H.ymn-=Va),Va=Hc-H.ymx,0>Va?(Va=6*Math.ceil(-Va/6),H.ymn-Va>=Ic?(H.y-=Va,H.ymx-=Va,H.ymn-=Va):(Af=Te?15:10,H.notes[0].shhd=Af,H.xmx=Af)):(Va=Ic-H.ymn,0<Va&&(Va=6*Math.ceil(Va/6),H.ymx+Va<=Hc?(H.y+=Va,H.ymx+=Va,H.ymn+=Va):(Af=Te?15:10,H.notes[0].shhd=Af,H.xmx=Af)))):(H.y=12,H.ymx=24,H.ymn=0)}var Yb,W,N,zd,K,Fb,
Vd,Gb,qg,Bf,Qd,rb,Pa,Cf,Ue,Rd,Df,ie,Ug,Ef,Ff,je,ke;for(Yb=Q;Yb;Yb=Yb.ts_next)if(8==Yb.type&&!Yb.invis){if(Yb.xstem&&0>Yb.ts_prev.stem){N=Yb.ts_prev;for(Gb=0;Gb<=N.nhd;Gb++)N.notes[Gb].shhd+=7,N.notes[Gb].shac-=7;N.xmx+=7}for(N=Yb;;){N=N.ts_next;if(!N)break;if(N.time!=Yb.time){N=null;break}if(8==N.type&&!N.invis&&N.st==Yb.st)break}if(N&&(W=Yb,B.voices[W.v].range<B.voices[N.v].range?N.dot_low=!0:W.dot_low=!0,!(W.ymn>N.ymx||W.ymx<N.ymn||Gj(W,N)))){ie=Lh(W);Ug=Kh(N);if((zd=W.ts_prev)&&zd.time==W.time&&
zd.st==W.st&&8==zd.type&&!zd.invis)for(Ff=Lh(zd),K=0;K<bb;K++)Ff[K]>ie[K]&&(ie[K]=Ff[K]);else zd=null;rb=-10;for(K=0;K<bb;K++)Ug[K]+ie[K]>rb&&(rb=Ug[K]+ie[K]);if(!(-3>rb&&(!W.dots||!N.dots||!N.dot_low||0<W.stem||0>N.stem||W.notes[W.nhd].pit+2!=N.notes[0].pit||N.notes[0].pit&1))){Ef=Lh(N);Df=Kh(W);if(zd)for(Ff=Kh(zd),K=0;K<bb;K++)Ff[K]>Df[K]&&(Df[K]=Ff[K]);Pa=Cf=Ue=-100;for(K=0;K<bb;K++)Df[K]+Ef[K]>Pa&&(Pa=Df[K]+Ef[K]),Ef[K]>Ue&&(Ue=Ef[K]),ie[K]>Cf&&(Cf=ie[K]);Bf=0;Fb=W.nhd;for(Vd=N.nhd;;){Qd=W.notes[Fb].pit-
N.notes[Vd].pit;switch(Qd){case 0:if(W.notes[Fb].acc!=N.notes[Vd].acc){Bf=-1;break}N.notes[Vd].acc&&(N.notes[Vd].acc=0);W.dots&&N.dots&&W.notes[Fb].pit&1&&(Bf=1);break;case -1:W.dots&&N.dots&&(W.notes[Fb].pit&1?(W.dot_low=!1,N.dot_low=!1):(W.dot_low=!0,N.dot_low=!0));break;case -2:!W.dots||!N.dots||W.notes[Fb].pit&1||(W.dot_low=!1,N.dot_low=!1)}if(0>Bf)break;if(0<=Qd&&0>--Fb)break;if(0>=Qd&&0>--Vd)break}if(0>Bf){var Jc=void 0,Zb=void 0,Kc=W,oc=N,kf=Fb;if(oc.notes[Vd].acc){Jc=2*Tg[Kc.head]+Kc.xmx+
oc.notes[Vd].shac+2;oc.notes[Vd].micro&&(Jc+=2);Kc.dots&&(Jc+=6);for(Zb=0;Zb<=oc.nhd;Zb++)oc.notes[Zb].shhd+=Jc,oc.notes[Zb].shac-=Jc;oc.xmx+=Jc}else{Jc=2*Tg[oc.head]+oc.xmx+Kc.notes[kf].shac+2;Kc.notes[kf].micro&&(Jc+=2);oc.dots&&(Jc+=6);for(Zb=0;Zb<=Kc.nhd;Zb++)Kc.notes[Zb].shhd+=Jc,Kc.notes[Zb].shac-=Jc;Kc.xmx+=Jc}}else{qg=0;W.dots?N.dots&&(Bf||(qg=1)):N.dots&&Pa+Cf<rb+Ue&&(qg=1);je=Ug;ke=Ef;!zd&&Pa+Cf<rb+Ue&&(W=N,N=Yb,rb=Pa,je=Df,ke=ie,Ue=Cf);rb+=3;0>rb&&(rb=0);Gb=0<=W.stem?0:W.nhd;rb+=W.notes[Gb].shhd;
Gb=0<=N.stem?0:N.nhd;rb-=N.notes[Gb].shhd;if(W.dots)if(Rd=7.7+W.xmx+3.5*W.dots-3.5+3,!qg){Pa=-100;for(Fb=0;Fb<=W.nhd;Fb++)K=W.notes[Fb].pit,K&1||(W.dot_low?K--:K++),K*=2,1>K?K=1:K>=bb-1&&(K=bb-2),je[K]>Pa&&(Pa=je[K]),je[K-1]+1>Pa&&(Pa=je[K-1]+1),je[K+1]+1>Pa&&(Pa=je[K+1]+1);Rd+Pa+2>rb&&(rb=Rd+Pa+2)}else if(Rd<rb+Ue+N.xmx){for(Fb=Pa=0;Fb<=W.nhd;Fb++)K=W.notes[Fb].pit,K&1||(W.dot_low?K--:K++),K*=2,1>K?K=1:K>=bb-1&&(K=bb-2),ke[K]>Pa&&(Pa=ke[K]),ke[K-1]+1>Pa&&(Pa=ke[K-1]=1),ke[K+1]+1>Pa&&(Pa=ke[K+1]+
1);4.5<Pa&&7.7+W.xmx+2<rb+Pa+N.xmx&&(N.xmx=Pa+3-7.7)}for(Gb=N.nhd;0<=Gb;Gb--)N.notes[Gb].shhd+=rb;N.xmx+=rb;qg&&(W.xmx=N.xmx)}}}}}var Ob,dd,Ve,Vg,Wg,lf,mf;for(Ob=Q;Ob;)if(8!=Ob.type||Ob.invis)Ob=Ob.ts_next;else{Ve=Ob.st;lf=Ob.time;Wg=!1;for(dd=Ob;dd&&dd.time==lf&&8==dd.type&&dd.st==Ve;dd=dd.ts_next)if(!Wg)for(Vg=0;Vg<=dd.nhd;Vg++)if(dd.notes[Vg].acc){Wg=!0;break}if(Wg){mf=si[Ob.head];for(Ve={notes:[]};Ob!=dd;Ob=Ob.ts_next)Ve.notes=Ve.notes.concat(Ob.notes);Gh(Ve);ti(Ve.notes,mf)}else Ob=dd}Hh(null);
yd=Ci();if(k.singleline)Wb=xi()+yi(Q,null)+yd,k.pagewidth=Wb*k.scale+k.leftmargin+k.rightmargin+2;else{var Xg=Wb=sf(),Yg=yd,qa,We,ye,rg,eg=k.leftmargin,fg=k.rightmargin,gg=k.pagewidth,hg=k.scale;qa=Q;Xg-=xi();k.custos&&1==x.length&&(Xg-=12);if(k.barsperstaff){ye=k.barsperstaff;for(We=qa;qa;qa=qa.ts_next)0!=qa.type||!qa.bar_num||0<--ye||(qa.eoln=!0,ye=k.barsperstaff);qa=We}rg=Yg;for(We=qa;qa;qa=qa.ts_next)if(16==qa.type)switch(qa.subtype){case "leftmargin":case "rightmargin":case "pagescale":case "pagewidth":case "scale":case "staffwidth":Qg(qa.subtype,
qa.param)}else if(qa.seqst||qa.eoln)if(rg+=qa.shrink,rg>Xg){var Zg;b:{for(var $g=void 0,sg=void 0,ah=void 0,tg=void 0,Be=void 0,Gf=void 0,bh=void 0,Lc=void 0,nf=void 0,da=We,$b=qa,pf=Xg,ig=Yg;$b&&!$b.eoln;$b=$b.ts_next);for(ah=yi(da,$b)+ig;;){sg=Math.ceil(ah/pf);if(1>=sg){$b&&($b=Ih($b));Zg=$b;break b}Lc=nf=da;Be=da.x+ah/sg*k.breaklimit;tg=da.x+pf;for($g=!1;da!=$b;da=da.ts_next)if(Gf=da.x){if(Gf>tg)break;if(0==da.type){if(Gf>Be){$g=!0;break}Lc=da}}if(!da){Zg=void 0;break b}0==da.type&&($g=!0);if(!$g){for(var Ce=
Lc.dur&&!Lc.beam_st&&!Lc.beam_end,jg=Lc.time,da=Lc,Lc=bh=null,tg=tg-6;da!=$b;da=da.ts_next)if(da.beam_st&&(Ce=!0),da.beam_end&&(Ce=!1),(Gf=da.x)&&!(Gf<Be)){if(Gf+da.shrink>=tg)break;Ce||da.in_tuplet||(Lc=da,0==(da.time-jg)%192&&(bh=da))}bh&&(Lc=bh);Lc&&(da=Lc)}if(da.nl)for(X(0,da,"Line split problem - adjust maxshrink and/or breaklimit"),sg=2,da=da.ts_next;da!=$b&&!(da.x&&0>=--sg);da=da.ts_next);da=Ih(da);if(!da||$b&&da.time>=$b.time)break;ah-=da.x-nf.x}Zg=da}qa=We=Zg;if(!qa)break;rg=qa.shrink;Yg=
0}else if(qa.eoln){We=Ih(qa);delete qa.eoln;qa=We;if(!qa)break;16==qa.type&&(qa=qa.ts_prev);rg=qa.shrink;Yg=0}k.leftmargin=eg;k.rightmargin=fg;k.pagewidth=gg;k.scale=hg}for(le=0;;){Jj();yd=Ci();for(var Ee=void 0,pc=void 0,ch=void 0,Hf=void 0,ed=void 0,Mc=void 0,Wd=void 0,qc=Wb-yd,O=Q,me=0,fa=0;;){4!=O.type||Ee||(Ee=O);O.seqst&&(Wd=O.space,me+=O.shrink,Wd<O.shrink&&(Wd=O.shrink),fa+=Wd);if(!O.ts_next)break;O=O.ts_next}if(0==fa)Ca=0;else{pc=fa;k.stretchstaff&&(pc*=1.8);ic?fa>=qc?le=0:(le=(qc-fa)/(pc-
fa),1<le&&(k.stretchstaff?k.linewarn&&X(0,O,"Line underfull ($1pt of $2pt)",(1*pc+0*fa).toFixed(2),qc.toFixed(2)):(qc=fa,le=0))):fa<qc&&(qc-fa)/(pc-fa)>=le&&(ed=le*pc+(1-le)*fa,ed<qc*(1-k.stretchlast)&&(qc=ed));ch=qc/fa;fa=pc=0;for(O=Q;;){O.seqst&&(Wd=O.shrink,0!=O.space&&(Wd<O.space*ch&&(Wd=O.space*ch),pc+=O.space*ch*1.8),fa+=Wd,pc+=Wd,O.x=fa,O.xmax=pc);if(!O.ts_next)break;O=O.ts_next}fa>=qc?(ed=0,fa==me?Mc=1:(Mc=(fa-qc)/(fa-me),1<Mc&&X(0,O,"Line too much shrunk $1 $2 $3",me.toFixed(2),fa.toFixed(2),
qc.toFixed(2))),Ca=me*Mc+fa*(1-Mc)):(Mc=0,ed=pc>fa?(qc-fa)/(pc-fa):1,1<ed&&(k.stretchstaff||(ed=0)),Ca=pc*ed+fa*(1-ed));O=Q;if(0!=Mc)if(1>Mc)for(fa=me=0;O;O=O.ts_next)O.seqst&&(me+=O.shrink*Mc,fa=me+O.x*(1-Mc)),O.x=fa;else for(Mc=Ca/fa,fa=0;O;O=O.ts_next)O.seqst&&(fa=O.x*Mc),O.x=fa;else for(fa=0;O;O=O.ts_next)O.seqst&&(fa=O.xmax*ed+O.x*(1-ed)),O.x=fa;for(O=Ee;O;O=O.ts_next)if(4==O.type)for(fa=O.gr_shift?O.prev.x+O.prev.wr+Number(k.gracespace[0]):O.x-O.wl+Number(k.gracespace[0]),Hf=O.extra;Hf;Hf=Hf.next)Hf.x+=
fa}if(0!=Ca){0!=yd&&(fc+=yd);Wc=A;for(var Fe=A=void 0,Ge=void 0,If=void 0,Nc=void 0,Jf=void 0,Pb=void 0,fd=void 0,Ad=void 0,Oc=void 0,C=void 0,rc=void 0,Xd=void 0,Oc=0;Oc<x.length;Oc++)for(var qf={},rf=!0,Xd=x[Oc],C=Xd.sym;C;C=C.next)switch(C.type){case 4:for(Pb=C.extra;Pb;Pb=Pb.next)Pb.beam_st&&!Pb.beam_end&&Mg(qf,Pb);break;case 8:if(C.beam_st&&!C.beam_end||rf&&!C.beam_st)rf=!1,Mg(qf,C)}for(Ad=0;Ad<=M;Ad++)for(rc=r[Ad],rc.top||(rc.top=new Float32Array(128),rc.bot=new Float32Array(128)),Nc=0;128>
Nc;Nc++)rc.top[Nc]=0,rc.bot[Nc]=24;for(var Ie=void 0,Pc=void 0,Kf=void 0,dh=void 0,ac=void 0,ua=void 0,tf=void 0,dh=0;dh<x.length;dh++)if(tf=x[dh],ua=tf.sym)if(ua=ua.next){var sb,ne,Je,bc,Qc,ba,va;for(va=ua;va;va=va.next)if(va.ti1)if(0!=va.multi)for(bc=0<va.multi?1:2,ba=0;ba<=va.nhd;ba++)sb=va.notes[ba].ti1,3==(sb&7)&&(va.notes[ba].ti1=sb&8|bc);else{Je=Qc=0;ne=128;for(ba=0;ba<=va.nhd;ba++)va.notes[ba].ti1&&(Qc++,128>ne&&va.notes[ba].pit<=ne+1&&Je++,ne=va.notes[ba].pit);if(1>=Qc)for(bc=0>va.stem?1:
2,ba=0;ba<=va.nhd;ba++){if(sb=va.notes[ba].ti1){3==(sb&7)&&(va.notes[ba].ti1=sb&8|bc);break}}else if(0==Je)if(Qc&1)for(Qc=(Qc-1)/2,bc=2,ba=0;ba<=va.nhd;ba++)sb=va.notes[ba].ti1,0!=sb&&(0==Qc&&22<=va.notes[ba].pit&&(bc=1),3==(sb&7)&&(va.notes[ba].ti1=sb&8|bc),0==Qc--&&(bc=1));else for(Qc/=2,bc=2,ba=0;ba<=va.nhd;ba++)sb=va.notes[ba].ti1,0!=sb&&(3==(sb&7)&&(va.notes[ba].ti1=sb&8|bc),0==--Qc&&(bc=1));else{ne=128;for(ba=0;ba<=va.nhd;ba++)if(va.notes[ba].ti1){if(128>ne&&va.notes[ba].pit<=ne+1){Qc=ba;break}ne=
va.notes[ba].pit}bc=2;for(ba=0;ba<=va.nhd;ba++)sb=va.notes[ba].ti1,0!=sb&&(Qc==ba&&(bc=1),3==(sb&7)&&(va.notes[ba].ti1=sb&8|bc))}}for(;ua;ua=ua.next)if(ua.ti1&&(20>ua.notes[0].pit&&2==(ua.notes[0].ti1&7)||24<ua.notes[ua.nhd].pit&&1==(ua.notes[ua.nhd].ti1&7))){for(ac=ua.next;ac&&8!=ac.type;)ac=ac.next;if(ac){if(ac.st!=ua.st)continue;Kf=ac.x-ua.x-10}else Kf=Ca-ua.x-10;Ie=100>Kf?9:300>Kf?12:16;24<ua.notes[ua.nhd].pit&&(Pc=3*(ua.notes[ua.nhd].pit-18)+Ie,ua.ymx<Pc&&(ua.ymx=Pc),ac&&ac.ymx<Pc&&(ac.ymx=Pc),
ga(ua.st,!0,ua.x+5,Kf,Pc));20>ua.notes[0].pit&&(Pc=3*(ua.notes[0].pit-18)-Ie,ua.ymn>Pc&&(ua.ymn=Pc),ac&&ac.ymn>Pc&&(ac.ymn=Pc),ga(ua.st,!1,ua.x+5,Kf,Pc))}}mj();for(C=Q;C;C=C.ts_next)if(!C.invis){switch(C.type){case 4:for(Pb=C.extra;Pb;Pb=Pb.next)ga(C.st,!0,Pb.x-2,4,Pb.ymx+1),ga(C.st,!1,Pb.x-2,4,Pb.ymn-1);continue;case 7:ga(C.st,!0,C.x+16,32,C.ymx+2);continue;default:ga(C.st,!0,C.x-C.wl,C.wl+C.wr,C.ymx+2);ga(C.st,!1,C.x-C.wl,C.wl+C.wr,C.ymn-2);continue;case 8:}0<C.stem?(C.beam_st?(If=3,Jf=C.beam_end?
4:10):(If=-8,Jf=C.beam_end?11:16),ga(C.st,!0,C.x+If,Jf,C.ymx+2),ga(C.st,!1,C.x-C.wl,C.wl+C.wr,C.ymn-2)):(ga(C.st,!0,C.x-C.wl,C.wl+C.wr,C.ymx+2),C.beam_st?(If=-6,Jf=C.beam_end?4:10):(If=-8,Jf=C.beam_end?5:16),ga(C.st,!1,C.x+If,Jf,C.ymn-2));C.notes[C.nhd].acc&&(fd=C.y+8,C.ymx<fd&&(C.ymx=fd),ga(C.st,!0,C.x,0,fd));C.notes[0].acc&&(fd=C.y,fd=1==C.notes[0].acc||3==C.notes[0].acc?fd-7:fd-5,C.ymn>fd&&(C.ymn=fd),ga(C.st,!1,C.x,0,fd))}for(Oc=0;Oc<x.length;Oc++)if(Xd=x[Oc],C=Xd.sym){pd(C.color);Ad=Xd.st;for(Oe(Ad);C;C=
C.next)C.tp0&&Eh(C,0);var Xe=void 0,Hb=void 0,Bd=Xd,$a=Bd.sym,Yd=Bd.slur_start,Ye=0;if($a){if(Yd)for(Bd.slur_start=0;0!=Yd;)Ye<<=4,Ye|=Yd&15,Yd>>=4;for(Dh($a,void 0);$a;$a=$a.next)if(8==$a.type||10==$a.type||11==$a.type)for(;$a.slur_end||$a.sl2;){if($a.slur_end)$a.slur_end--,Xe=-1;else{for(Xe=0;Xe<=$a.nhd&&!$a.notes[Xe].sl2;Xe++);$a.notes[Xe].sl2--;$a.sl2--}Yd=Ye&15;Hb=bi($a);Og(Hb,$a,-1,Xe,Yd);0==Hb.type&&(":"==Hb.bar_type[0]||"|]"==Hb.bar_type||"[|"==Hb.bar_type||Hb.text&&"1"!=Hb.text[0])||(Ye>>=
4)}for($a=Bd.sym;0!=Ye;)Yd=Ye&15,Ye>>=4,Hb=ei($a),Og($a,Hb,-1,-1,Yd),0==Hb.type&&(":"==Hb.bar_type[0]||"|]"==Hb.bar_type||"[|"==Hb.bar_type||Hb.text&&"1"!=Hb.text[0])||(Bd.slur_start||(Bd.slur_start=0),Bd.slur_start<<=4,Bd.slur_start+=Yd)}for(C=Xd.sym;C;C=C.next)C.tp0&&Eh(C,0)}for(Ad=0;Ad<=M;Ad++)for(rc=r[Ad],Ge=rc.topbar+2,Fe=rc.botbar-2,Nc=0;128>Nc;Nc++)Ge>rc.top[Nc]&&(rc.top[Nc]=Ge),Fe<rc.bot[Nc]&&(rc.bot[Nc]=Fe);pd(void 0);for(var Ke=void 0,uf=void 0,eh=void 0,fh=void 0,kg=xa.length,fh=0;fh<kg;fh++)if(eh=
xa[fh],uf=eh.dd,Ke=uf.func,Xj[Ke]&&void 0==eh.m)Ah[Ke](eh);for(var Le=void 0,Me=void 0,gh=void 0,ug=void 0,hh=void 0,oe=void 0,Qa=void 0,ih=void 0,Fa=void 0,Ne=void 0,gd=void 0,vg=void 0,jh=void 0,kh=void 0,Wa=void 0,Za=Array(M),vf=xa.length,Fa=0;Fa<=M;Fa++)Za[Fa]={ymin:0,ymax:24};for(Wa=Q;Wa;Wa=Wa.ts_next)if(Wa.a_gch){kh||(kh=Wa);ug=null;for(gh=0;gh<Wa.a_gch.length&&!(hh=Wa.a_gch[gh],"g"==hh.type&&(ug=hh,0>hh.y));gh++);ug&&(Ne=ug.w,0<=ug.y?(gd=wa(Wa.st,!0,Wa.x,Ne),gd>Za[Wa.st].ymax&&(Za[Wa.st].ymax=
gd)):(gd=wa(Wa.st,!1,Wa.x,Ne),gd<Za[Wa.st].ymin&&(Za[Wa.st].ymin=gd)))}if(kh){for(Fa=0;Fa<=M;Fa++)Le=r[Fa].botbar,Za[Fa].ymin-=3,Za[Fa].ymin>Le-10&&(Za[Fa].ymin=Le-10),Me=r[Fa].topbar,Za[Fa].ymax+=3,Za[Fa].ymax<Me+10&&(Za[Fa].ymax=Me+10);hc(-1);for(Wa=kh;Wa;Wa=Wa.ts_next)if(Wa.a_gch){for(var tb=void 0,Pe=void 0,pe=void 0,Cd=void 0,Lf=void 0,Ra=void 0,fb=void 0,qe=void 0,re=void 0,Qe=void 0,Aa=void 0,ma=Wa,Uf=Za[Wa.st].ymin,Vf=Za[Wa.st].ymax,hd=ma.a_gch[0].w,lh=wa(ma.st,1,ma.x-2,hd),mh=wa(ma.st,0,
ma.x-2,hd),Ph=ma.yav||0,qe=0;qe<ma.a_gch.length&&!(Aa=ma.a_gch[qe],"g"==Aa.type&&(Qe=Aa,0>Aa.y));qe++);Qe&&(0<=Qe.y?lh<Vf&&(lh=Vf):mh>Uf&&(mh=Uf));Oe(ma.st,!0);for(qe=0;qe<ma.a_gch.length;qe++){Aa=ma.a_gch[qe];mi(Aa.font);D.curfont=D.deffont=Aa.font;tb=Aa.font.size;hd=Aa.w;fb=ma.x+Aa.x;re=Aa.text;switch(Aa.type){case "_":Ra=Aa.y+mh;ga(ma.st,0,fb,hd,Ra-.2*tb-2);break;case "^":Ra=Aa.y+lh;ga(ma.st,1,fb,hd,Ra+.8*tb+2);break;case "<":ma.notes[0].acc&&(fb-=ma.notes[0].shac);Ra=Aa.y+Ph;break;case ">":fb+=
ma.xmx;0<ma.dots&&(fb+=1.5+3.5*ma.dots);Ra=Aa.y+Ph;break;default:Pe=Aa.box?3:2;0<=Aa.y?(Ra=Aa.y+lh,ga(ma.st,!0,fb,hd,Ra+tb+Pe)):(Ra=Aa.y+mh,ga(ma.st,!1,fb,hd,Ra-Pe));Cd=re.indexOf("\t");if(0<=Cd){for(var fb=Ca,wg=ma.next;wg;wg=wg.next){switch(wg.type){default:continue;case 8:case 10:case 0:fb=wg.x}break}for(pe=2;;){Cd=re.indexOf("\t",Cd+1);if(0>Cd)break;pe++}var Hg=(fb-ma.x)/pe,fb=ma.x,Ra=Ra/r[ma.st].staffscale;R.anno_start&&R.anno_start("gchord",Aa.istart,Aa.iend,fb-2,Ra+tb+2,hd+4,tb+4,ma);for(pe=
Cd=0;;){Cd=re.indexOf("\t",pe);if(0>Cd)break;ja(fb,Ra+.2*tb,re.slice(pe,Cd),"c");fb+=Hg;pe=Cd+1}ja(fb,Ra+.2*tb,re.slice(pe),"c");R.anno_stop&&R.anno_stop("gchord",Aa.istart,Aa.iend,ma.x-2,Ra+tb+2,hd+4,tb+4,ma);continue}break;case "@":Ra=Aa.y+Ph,0<Ra?(Lf=Ra+.8*tb+3,Lf>r[ma.st].ann_top&&(r[ma.st].ann_top=Lf)):(Lf=Ra-.2*tb,Lf<r[ma.st].ann_bot&&(r[ma.st].ann_bot=Lf))}Ra*=r[ma.st].staffscale;R.anno_start&&R.anno_start("annot",Aa.istart,Aa.iend,fb-2,Ra+tb+2,hd+4,tb+4,ma);Aa.box?Pg(fb,Ra+.2*tb,re):ja(fb,
Ra+.2*tb,re);R.anno_stop&&R.anno_stop("annot",Aa.istart,Aa.iend,fb-2,Ra+tb+2,hd+4,tb+4,ma)}}}for(ih=0;ih<x.length;ih++)if(jh=x[ih],!jh.second&&jh.sym){var Qh=void 0,Ze,Dd,$e,Qb,S,Rc=jh;$e=r[Rc.st].topbar+6+20;for(S=Rc.sym;S;S=S.next)if(0==S.type&&S.rbstart&&!S.norepbra){if(!S.next)break;Qh||(Qh=S,Na("repeat"));for(Qb=S;S.next&&(S=S.next,!S.rbstop););Dd=wa(Rc.st,!0,Qb.x,S.x-Qb.x);$e<Dd&&($e=Dd);Qb.text&&(Ze=lb(Qb.text),Dd=wa(Rc.st,!0,Qb.x+4,Ze),Dd+=D.curfont.size+2,$e<Dd&&($e=Dd));S.rbstart&&(S=S.prev)}if(S=
Qh)for(Oe(Rc.st,!0),Dd=$e*r[Rc.st].staffscale;S;S=S.next)if(S.rbstart&&!S.norepbra){for(Qb=S;S.next&&(S=S.next,!S.rbstop););if(Qb==S)break;vg=Qb.x;Ze=0!=S.type?S.rbstop?0:S.x-Ca+4:1<S.bar_type.length&&"[]"!=S.bar_type||"]"==S.bar_type?0<Qb.st&&!(B.staves[Qb.st-1].flags&64)?S.wl:":"==S.bar_type.slice(-1)?12:":"!=S.bar_type[0]?0:8:S.rbstop?0:8;Ze=S.x-vg-Ze;S.next||S.rbstop||Rc.bar_start||(Rc.bar_start=T(S),Rc.bar_start.bar_type="[",delete Rc.bar_start.text,Rc.bar_start.rbstart=1,delete Rc.bar_start.a_gch);
Qb.text&&ja(vg+4,Dd-.9*D.curfont.size,Qb.text);xe(vg,Dd);2==Qb.rbstart&&A.push("m0 20v-20");A.push("h");A.push(Ze.toFixed(2));2==S.rbstop&&A.push("v20");A.push('"/>\n');ga(Qb.st,!0,vg,Ze,$e+2);S.rbstart&&(S=S.prev)}}for(Fa=0;Fa<=M;Fa++)Za[Fa]={ymin:0,ymax:0};for(Fa=0;Fa<vf;Fa++)Qa=xa[Fa],(oe=Qa.dd)&&af[oe.func]&&void 0==Qa.m&&(Ah[oe.func](Qa),!oe.dd_en&&k.dynalign&&(Qa.up?Qa.y>Za[Qa.st].ymax&&(Za[Qa.st].ymax=Qa.y):Qa.y<Za[Qa.st].ymin&&(Za[Qa.st].ymin=Qa.y)));for(Fa=0;Fa<vf;Fa++)Qa=xa[Fa],(oe=Qa.dd)&&
!oe.dd_en&&af[oe.func]&&(k.dynalign?(gd=Qa.up?Za[Qa.st].ymax:Za[Qa.st].ymin,Qa.y=gd):gd=Qa.y,Qa.up&&(gd+=oe.h),ga(Qa.st,Qa.up,Qa.x,Qa.val,gd));hc(-1);Oe(-1);for(Oc=0;Oc<x.length;Oc++)if(Xd=x[Oc],Xd.have_ly){for(var bf=void 0,Mf=void 0,nh=void 0,Sc=void 0,oh=void 0,Rb=void 0,xg=void 0,ra=void 0,ub=void 0,La=void 0,cc=Array(M),cf=x.length,se=Array(cf),yg=Array(cf),Rh=Array(cf),Wf=Array(cf),te=0,Zd=0,Sa=-1,ra=0;ra<cf;ra++)if(La=x[ra],La.sym){La.st!=Sa&&(Zd=te=0,Sa=La.st);xg=0;if(La.have_ly)for(se[ra]||
(se[ra]=[]),ub=La.sym;ub;ub=ub.next){if(Mf=ub.a_ly){oh=ub.x;nh=10;for(Rb=0;Rb<Mf.length;Rb++)if((bf=Mf[Rb])&&0!=bf.w){oh-=bf.shift;nh=bf.w;break}Sc=wa(La.st,1,oh,nh);te<Sc&&(te=Sc);Sc=wa(La.st,0,oh,nh);for(Zd>Sc&&(Zd=Sc);xg<Mf.length;)se[ra][xg++]=0;for(Rb=0;Rb<Mf.length;Rb++)(bf=Mf[Rb])&&(!se[ra][Rb]||bf.font.size>se[ra][Rb])&&(se[ra][Rb]=bf.font.size)}}else Sc=wa(La.st,1,0,Ca),te<Sc&&(te=Sc),Sc=wa(La.st,0,0,Ca),Zd>Sc&&(Zd=Sc);cc[Sa]||(cc[Sa]={});cc[Sa].top=te;cc[Sa].bot=Zd;yg[ra]=xg;0!=xg&&(Rh[ra]=
La.pos.voc?1==La.pos.voc:x[ra+1]&&x[ra+1].st==Sa&&x[ra+1].have_ly?!0:!1,Rh[ra]?cc[Sa].a=!0:cc[Sa].b=!0)}for(ra=Rb=0;ra<cf;ra++)La=x[ra],La.sym&&La.have_ly&&(Rh[ra]?Wf[Rb++]=ra:(Sa=La.st,Oe(Sa,!0),0<yg[ra]&&(cc[Sa].bot=aj(La,yg[ra],se[ra],cc[Sa].bot,1))));for(;0<=--Rb;)ra=Wf[Rb],La=x[ra],Sa=La.st,Oe(Sa,!0),cc[Sa].top=aj(La,yg[ra],se[ra],cc[Sa].top,-1);for(ra=0;ra<cf;ra++)if(La=x[ra],La.sym){Sa=La.st;if(cc[Sa].a)for(te=cc[Sa].top+2,ub=La.sym.next;ub;ub=ub.next)ub.a_ly&&ga(Sa,1,ub.x-2,10,te);if(cc[Sa].b)if(Zd=
cc[Sa].bot-2,0<yg[La.v])for(ub=La.sym.next;ub;ub=ub.next)ub.a_ly&&ga(Sa,0,ub.x-2,10,Zd);else ga(Sa,0,0,Ca,Zd)}break}if(0<=k.measurenb){for(var ph=void 0,qh=void 0,sc=void 0,Ha=void 0,Ed=void 0,Sb=void 0,Ma=void 0,Ba=void 0,Sh=B,Ma=0;Ma<=M&&!Sh.st_print[Ma];Ma++);if(!(Ma>M)){Oe(Ma);1!=r[Ma].staffscale&&(ph=Xc("measure").size,ab("measurefont","* "+(ph/r[Ma].staffscale).toString()));Na("measure");Ba=Q;Sb=D.nbar;if(1<Sb)if(0==k.measurenb)qh=!0,Ha=wa(Ma,!0,0,20),Ha<r[Ma].topbar+14&&(Ha=r[Ma].topbar+14),
ja(0,Ha,Sb.toString()),ga(Ma,!0,0,20,Ha+D.curfont.size+2);else if(0==Sb%k.measurenb){for(;;Ba=Ba.ts_next){switch(Ba.type){case 6:case 1:case 5:case 13:continue}break}for(;Ba.st!=Ma;)Ba=Ba.ts_next;Ba.prev&&1!=Ba.prev.type&&(Ba=Ba.prev);Ed=Ba.x-Ba.wl;qh=!0;sc=uc("0")*D.curfont.swfac;10<=Sb&&(sc*=100<=Sb?3:2);k.measurebox&&(sc+=4);Ha=wa(Ma,!0,Ed,sc);Ha<r[Ma].topbar+6&&(Ha=r[Ma].topbar+6);Ha+=2;k.measurebox?(Pg(Ed,Ha,Sb.toString()),sc+=3):ja(Ed,Ha,Sb.toString());Ha+=D.curfont.size;ga(Ma,!0,Ed,sc,Ha);
Ba.ymx=Ha}for(;Ba;Ba=Ba.ts_next){switch(Ba.type){case 12:Sh=Ba.sy;for(Ma=0;Ma<M&&!Sh.st_print[Ma];Ma++);hc(Ma);continue;default:continue;case 0:if(!Ba.bar_num)continue}Sb=Ba.bar_num;0!=k.measurenb&&0==Sb%k.measurenb&&Ba.next&&(qh||(qh=!0),sc=uc("0")*D.curfont.swfac,10<=Sb&&(sc*=100<=Sb?3:2),k.measurebox&&(sc+=4),Ed=Ba.x-.4*sc,Ha=wa(Ma,!0,Ed,sc),Ha<r[Ma].topbar+6&&(Ha=r[Ma].topbar+6),8==Ba.next.type&&(0<Ba.next.stem?Ha<Ba.next.ys-D.curfont.size&&(Ha=Ba.next.ys-D.curfont.size):Ha<Ba.next.y&&(Ha=Ba.next.y)),
Ha+=2,k.measurebox?(Pg(Ed,Ha,Sb.toString()),sc+=3):ja(Ed,Ha,Sb.toString()),Ha+=D.curfont.size,ga(Ma,!0,Ed,sc,Ha),Ba.ymx=Ha)}D.nbar=Sb;ph&&ab("measurefont","* "+ph.toString())}}A=Wc;od=vj();for(var Tc=void 0,Tc=0;Tc<=M;Tc++)0!=r[Tc].sc_out.length&&(A.push('<g transform="translate(0,'+(Da-r[Tc].y).toFixed(2)+") scale("+r[Tc].staffscale.toFixed(2)+')">\n'),A.push(r[Tc].sc_out.join("")),A.push("</g>\n"),r[Tc].sc_out=[]),0!=r[Tc].output.length&&(A.push('<g transform="translate(0,'+(-r[Tc].y).toFixed(2)+
')">\n'),A.push(r[Tc].output.join("")),A.push("</g>\n"),r[Tc].output=[]);wj(yd);for(var rh=void 0,sh=void 0,Ig=x.length,rh=0;rh<Ig;rh++)if(sh=x[rh],sh.sym&&void 0!=sh.sym.x){for(var zg=void 0,$d=void 0,Fd=void 0,G=void 0,Nf=sh,Ag={},G=Nf.sym;G;G=G.next)if(!G.invis||8==G.type)switch(Fd=G.x,pd(G.color),G.type){case 8:de(G);G.beam_st&&!G.beam_end&&Mg(Ag,G)&&ci(Ag);G.invis||(Tb(G),Ch(G,!Ag.s2),Ub(G));G==Ag.s2&&(Ag.s2=null);break;case 10:de(G);Tb(G);var ae=void 0,id=void 0,Ib=void 0,Bg=void 0,be=void 0,
dc=void 0,Ia=G,Of=r[Ia.st];if(Of.topbar){if(Ia.dur==Ia.p_v.meter.wmeasure||Ia.rep_nb&&0<=Ia.rep_nb){for(dc=Ia.ts_next;dc&&dc.time!=Ia.time+Ia.dur;)dc=dc.ts_next;Ib=dc?dc.x:Ca;for(dc=Ia;!dc.seqst;)dc=dc.ts_prev;dc=dc.ts_prev;Ib=(Ib+dc.x)/2;if(Ia.a_dd)for(var th=void 0,uh=void 0,Jg=Ia,Kg=Ib-Ia.x,Lg=xa.length,uh=0;uh<Lg;uh++)th=xa[uh],th.s==Jg&&(th.x+=Kg);Ia.x=Ib}else Ib=Ia.x,Ia.notes[0].shhd&&(Ib+=Ia.notes[0].shhd*z.scale);if(!Ia.invis)if(ae=Of.y,Ia.rep_nb)ae+=12,0>Ia.rep_nb?ia(Ib,ae,"srep"):(ia(Ib,
ae,"mrep"),2<Ia.rep_nb&&Ia.v==B.top_voice&&(Na("annotation"),ja(Ib,ae+Of.topbar-9,Ia.rep_nb.toString(),"c")));else{id=Ia.y;be=5-Ia.nflags;7==be&&12==id&&2>=Of.stafflines.length&&(id-=6);ia(Ib,id+ae,Ia.notes[0].head?Ia.notes[0].head:Yj[be]);if(6<=be){Bg=id/6;switch(be){default:"|"!=Of.stafflines[Bg+1]&&ia(Ib,id+6+ae,"hl1");9==be&&(id-=6,Bg--);break;case 7:id+=6,Bg++;case 6:}"|"!=Of.stafflines[Bg]&&ia(Ib,id+ae,"hl1")}Ib+=8;id+=ae+3;for(be=0;be<Ia.dots;be++)ia(Ib,id,"dot"),Ib+=3.5}}Ub(G);break;case 0:break;
case 1:zg=G.st;G.time>r[zg].clef.time&&(r[zg].clef=G);if(G.second)break;if(!r[G.st].topbar)break;pd(void 0);hc(zg);Tb(G);$d=r[zg].y;G.clef_name?ia(Fd,$d+G.y,G.clef_name):G.clef_small?ia(Fd,$d+G.y,"s"+G.clef_type+"clef"):ia(Fd,$d+G.y,G.clef_type+"clef");G.clef_octave&&(0<G.clef_octave?($d+=G.ymx-10,G.clef_small&&--$d):($d+=G.ymn+2,G.clef_small&&($d+=1)),ia(Fd-2,$d,"oct"));Ub(G);break;case 6:Nf.meter=G;if(G.second||!r[G.st].topbar)break;if(k.alignbars&&0!=G.st)break;pd(void 0);hc(G.st);Tb(G);var vh=
void 0,Pf=void 0,df=Fd,Cg=G;if(Cg.a_meter)for(var wh=r[Cg.st].y,df=df-Cg.wl,vh=0;vh<Cg.a_meter.length;vh++){var Dg,tc=Cg.a_meter[vh],Pf="C|"==tc.top?13:13*tc.top.length;if(tc.bot)tc.bot.length>tc.top.length&&(Pf=13*tc.bot.length),Z('<g style="font:bold 16px serif"\n\ttransform="translate(X,Y) scale(1.2,1)">\n\t<text y="-12" text-anchor="middle">A</text>\n\t<text text-anchor="middle">B</text>\n</g>\n',df+.5*Pf,wh,tc.top,tc.bot);else switch(tc.top[0]){case "C":Dg="|"!=tc.top[1]?"csig":"ctsig";df-=5;
wh+=12;break;case "c":Dg="."!=tc.top[1]?"imsig":"iMsig";break;case "o":Dg="."!=tc.top[1]?"pmsig":"pMsig";break;default:Z('<g style="font:bold 18px serif"\n\ttransform="translate(X,Y) scale(1.2,1)">\n\t<text y="-6" text-anchor="middle">A</text>\n</g>\n',df+.5*Pf,wh,tc.top)}Dg&&ia(df+.5*Pf,wh,Dg);df+=Pf}Ub(G);break;case 5:Nf.key=G;if(G.second||!r[G.st].topbar)break;pd(void 0);hc(G.st);Tb(G);var ef=void 0,Gd=void 0,Ja=void 0,Ga=void 0,gb=Fd,Jb=G;if(!Jb.k_none){var ff=Jb.k_old_sf,Xf=Nf.st,gf=r[Xf].y,
Hd=Jb.k_y_clef;Hd&1&&(Hd+=7);for(Hd/=2;0>Hd;)Hd+=7;Hd%=7;if(Jb.k_a_acc)for(var Yf=Jb.k_a_acc[0].acc,Th=100,Ga=0;Ga<Jb.k_a_acc.length;Ga++)ef=Jb.k_a_acc[Ga],Ja=3*(Jb.k_y_clef+ef.pit-18),0!=Ga&&(Ja>Th+18||Ja<Th-18)?gb-=5.5:ef.acc!=Yf&&(gb+=3),Yf=ef.acc,di(gb,Ja,Ja,Xf,"hl"),Th=Ja,Bh(gb,gf+Ja,ef.acc,ef.micro_n,ef.micro_d),gb+=5.5;else{if(k.cancelkey||0==Jb.k_sf)if(0==Jb.k_sf||0>ff*Jb.k_sf){Ja=bj[Hd];Gd=9<Ja?cj:dj;for(Ga=0;Ga<ff;Ga++)ia(gb,gf+Ja,"acc3"),Ja+=Gd[Ga],gb+=5.5;Ja=ej[Hd];Gd=18>Ja?fj:gj;for(Ga=
0;Ga>ff;Ga--)ia(gb,gf+Ja,"acc3"),Ja+=Gd[-Ga],gb+=5.5;0!=Jb.k_sf&&(gb+=3)}if(0<Jb.k_sf){Ja=bj[Hd];Gd=9<Ja?cj:dj;for(Ga=0;Ga<Jb.k_sf;Ga++)ia(gb,gf+Ja,"acc1"),Ja+=Gd[Ga],gb+=5.5;if(k.cancelkey&&Ga<ff)for(gb+=2;Ga<ff;Ga++)ia(gb,gf+Ja,"acc3"),Ja+=Gd[Ga],gb+=5.5}if(0>Jb.k_sf){Ja=ej[Hd];Gd=18>Ja?fj:gj;for(Ga=0;Ga>Jb.k_sf;Ga--)ia(gb,gf+Ja,"acc-1"),Ja+=Gd[-Ga],gb+=5.5;if(k.cancelkey&&Ga>ff)for(gb+=2;Ga>ff;Ga--)ia(gb,gf+Ja,"acc3"),Ja+=Gd[-Ga],gb+=5.5}}}Ub(G);break;case 7:de(G);Fd+=32;Tb(G);ia(Fd,r[G.st].y+
12,"mrest");Z('<text style="font:bold 15px serif"\n\tx ="X" y="Y" text-anchor="middle">A</text>\n',Fd,r[G.st].y+28,G.nmes);Ub(G);break;case 4:de(G);for(var Uh=void 0,Kb=void 0,Y=void 0,Eg=void 0,jd=void 0,Qf=void 0,ue=void 0,zb=void 0,kd=void 0,Zf=void 0,$f=void 0,ve=void 0,Fg=void 0,Xa=void 0,Lb=void 0,Rf=void 0,Ka=G,Gg={},Y=Ka.extra;Y&&(Y.beam_st&&!Y.beam_end&&Mg(Gg,Y)&&ci(Gg),Tb(Y),Ch(Y,!Gg.s2),Y==Gg.s2&&(Gg.s2=null),Ub(Y),Y.next);Y=Y.next);if(Ka.sappo){Y=Ka.extra;Y.next?(Fg=.5*(Y.next.x-Y.x)+
4,ve=.5*(Y.ys+Y.next.ys)-Y.y,ve=0<Y.stem?ve-1:ve+1):(Fg=9,ve=0<Y.stem?5:-5);var Uh=Y.notes[0>Y.stem?0:Y.nhd],Vh=Y.x+Uh.shhd,Wh=r[Y.st].y+3*(Uh.pit-18);0<Y.stem?(--Vh,Wh+=4):(Vh-=5,Wh-=4);Z('<path class="stroke" d="mX YlF G"/>\n',Vh,Wh,Fg,-ve)}if(!Ka.p_v.key.k_bagpipe&&k.graceslurs&&!Ka.slur_start&&Ka.next&&8==Ka.next.type){Kb=Y;if(0<=Kb.stem){Rf=127;for(Y=Ka.extra;Y;Y=Y.next)Y.y<Rf&&(Rf=Y.y,Kb=Y);Lb=Kb.x;Xa=Kb.y-5;Ka.extra!=Kb&&(Lb-=4,Xa+=1);Ka=Ka.next;kd=Ka.x-1;0>Ka.stem&&(kd-=4);zb=3*(Ka.notes[0].pit-
18)-5;jd=.4*(kd-Lb);3<jd&&(jd=3);Eg=jd;ue=.2;Qf=.8;Xa>zb+7?(Lb=Kb.x-1,Xa+=.5,zb+=6.5,kd=Ka.x-5.5,jd=.8*(Xa-zb),Eg=.2*(Xa-zb),ue=0):zb>Xa+4&&(zb=Xa+4,Lb=Kb.x+2,Xa=Kb.y-4)}else{Rf=-127;for(Y=Ka.extra;Y;Y=Y.next)Y.y>Rf&&(Rf=Y.y,Kb=Y);Lb=Kb.x;Xa=Kb.y+5;Ka.extra!=Kb&&(Lb-=4,--Xa);Ka=Ka.next;kd=Ka.x-1;0<=Ka.stem&&(kd-=2);zb=3*(Ka.notes[Ka.nhd].pit-18)+5;jd=.4*(Lb-kd);-3>jd&&(jd=-3);Eg=jd;ue=.2;Qf=.8;Xa<zb-7?(Lb=Kb.x-1,Xa-=.5,zb-=6.5,kd=Ka.x-5.5,jd=.8*(Xa-zb),Eg=.2*(Xa-zb),ue=0):zb<Xa-4&&(zb=Xa-4,Lb=Kb.x+
2,Xa=Kb.y+4)}Fg=ue*kd+(1-ue)*Lb-Lb;ve=ue*zb+(1-ue)*Xa-jd-Xa;$f=Qf*kd+(1-Qf)*Lb-Lb;Zf=Qf*zb+(1-Qf)*Xa-Eg-Xa;Tb(Ka,"slur");xe(Lb,Xa+r[Ka.st].y);A.push("c"+Fg.toFixed(2)+" "+(-ve).toFixed(2)+" "+$f.toFixed(2)+" "+(-Zf).toFixed(2)+" "+(kd-Lb).toFixed(2)+" "+(-zb+Xa).toFixed(2)+'"/>\n');Ub(Ka,"slur")}break;case 11:case 13:break;case 2:de(G);Ch(G,0);break;case 16:case 9:case 17:case 12:case 14:break;default:X(2,G,"draw_symbols - Cannot draw symbol "+G.type)}de(Nf.sym);tj(Nf);pd(void 0)}var xh=void 0,Sf=
void 0,yh=void 0,Xh=void 0,hf=void 0,jf=void 0,Ab=void 0,Uc=void 0,ec=void 0,ld=void 0,ag=void 0,Tf=void 0,md=void 0,sa=void 0;if(0!=xa.length){var bg=[],Yh=[];if(!k.dynalign)for(ec=M,Ab=r[ec].y;0<=--ec;)jf=r[ec].y,Yh[ec]=.5*(Ab+24+jf),Ab=jf;for(;;){sa=xa.shift();if(!sa)break;if((md=sa.dd)&&!md.dd_en&&(Tf=sa.s,ld=md.glyph,yh=ld.indexOf("/"),0<yh&&(ld=0<=Tf.stem?ld.slice(0,yh):ld.slice(yh+1)),af[md.func]?hc(-1):de(Tf),ec=sa.st,r[ec].topbar))if(Uc=sa.x,Ab=sa.y+r[ec].y,void 0!=sa.m?(ag=Tf.notes[sa.m],
Uc+=ag.shhd*z.scale):af[md.func]&&!k.dynalign&&(sa.up&&0<ec||!sa.up&&ec<M)&&(hf=sa.up?Yh[--ec]:Yh[ec++],hf-=.5*md.h,sa.up&&Ab<hf||!sa.up&&Ab>hf)&&(jf=wa(ec,!sa.up,sa.x,sa.val)+r[ec].y,sa.up&&(jf-=md.h),sa.up&&jf>hf||!sa.up&&jf<hf)&&(Ab=hf),(Xh=R[ld])&&"function"==typeof Xh)Xh(Uc,Ab,sa);else if(!hj(ld,Uc,Ab,sa)){Tb(Tf,"deco");sa.inv&&(cg(Uc,Ab,0,1,-1),Uc=Ab=0);if(sa.has_val)2!=md.func||0>z.st?Mh(Uc,Ab,ld,sa.val/z.scale,sa.defl):Mh(Uc,Ab,ld,sa.val,sa.defl),sa.defl.noen&&bg.push(sa.start);else if(void 0!=
md.str&&"sfz"!=md.str)Sf=md.str,"@"==Sf[0]&&(xh=Sf.match(/^@([0-9.-]+),([0-9.-]+);?/),Uc+=Number(xh[1]),Ab+=Number(xh[2]),Sf=Sf.replace(xh[0],"")),Si(Uc,Ab,ld,Sf);else if(sa.lden){var Zh=sa.dd.glyph;if(ij[Zh])ij[Zh](Uc,Ab,sa);else X(1,null,"No function for decoration '$1'",Zh)}else ia(Uc,Ab,ld);z.g&&dg();Ub(Tf,"deco")}}xa=bg}hc(-1);la(od);0!=yd&&(fc-=yd,De&=-3)}Q=ic;if(!ic)break;Cb();Di();if(!Q)break;Q.ts_prev=null;for(var zh=void 0,$h=void 0,ai=void 0,Ng=x.length,zh=0;zh<Ng;zh++)if(ai=x[zh],$h=ai.s_next,
ai.sym=$h)$h.prev=null;Wb=sf()}}for(a=0;a<x.length;a++)d=x[a],d.time=0,d.sym=d.last_sym=null,d.st=B.voices[a].st,d.second=B.voices[a].second,delete d.have_ly,d.hy_st=0,delete d.bar_start,delete d.slur_st,delete d.s_tie,delete d.s_rtie;Ac=0}}}}function tf(a){var d=h.vtransp/3|0,d=(d&-2)+7*(d&1)+a.k_sf;switch((h.vtransp+210)%3){case 1:d=(d+4+48)%12-4;break;case 2:d=(d+7+48)%12-7;break;default:d=(d+5+48)%12-5}a.k_sf=d}function Pj(a){var d,b,c=h.last_sym.prev;if(c)for(b=c.time;c;c=c.prev)switch(c.type){case 0:if(c.time<
b)return;for(;;){c=c.prev;if(!c)return;if(8==c.type){if(c.time+c.dur==b)break;return}if(c.time<b)return}for(d=0;d<=c.nhd;d++)if(c.notes[d].pit==a&&c.notes[d].ti1)return c.notes[d].acc;return;case 8:for(d=0;d<=c.nhd;d++)if(c.notes[d].pit==a)return c.notes[d].acc}}function Od(a){function d(a){var b,c;for(b=0;b<x.length;b++)if(c=x[b],c.id==a)return c;c=T(h);c.v=x.length;c.id=a;c.sym=c.last_sym=null;delete c.nm;delete c.snm;delete c.new_name;delete c.lyric_restart;delete c.lyric_cont;delete c.ly_a_h;
delete c.sym_restart;delete c.sym_cont;x.push(c);return c}var b,c,e;if(!h.ignore)if("|"==a||")"==a)h.last_note?(h.last_note.beam_end=!0,ib?(h.time!=ib.mxtime&&y(1,"Wrong duration in voice overlay"),h=ib.p_voice,ib=null):y(1,"Erroneous end of voice overlap")):y(1,jj);else if("("==a)ib?y(1,"Voice overlay already started"):ib={time:h.time};else if(h.last_note){h.last_note.beam_end=!0;a=h.voice_down;if(!a){a=d(h.id+"o");h.voice_down=a;a.time=0;a.second=!0;e=a.v;E.voices[e]={st:h.st,second:!0};var f=void 0!=
h.clone?1:0;c=E.voices[h.v].range;for(b=0;b<E.voices.length;b++)E.voices[b].range>c&&(E.voices[b].range+=f+1);E.voices[e].range=c+1;f&&(b=d(a.id+"c"),b.second=!0,e=b.v,E.voices[e]={second:!0,range:c+2},a.clone=b)}a.ulen=h.ulen;a.dur_fact=h.dur_fact;h.uscale&&(a.uscale=h.uscale);if(ib)ib.p_voice?h.time!=ib.mxtime&&y(1,"Wrong duration in voice overlay"):(ib.mxtime=h.time,ib.p_voice=h);else{ib={bar:!0,mxtime:h.time,p_voice:h};b=a.time;for(c=h.last_sym;!(0==c.type||c.time<=b);c=c.prev);ib.time=c.time}a.time=
ib.time;h=a}else y(1,jj)}function qf(){var a;if(!h.sym)return!0;if(0!=h.time)return!1;for(a=h.sym;a;a=a.next)switch(a.type){case 14:case 9:break;default:return!1}return!0}function Hi(a){var d,b;if(qf())h.clef=a;else{if((d=h.last_sym)&&d.prev&&d.time==h.time&&(5==d.type&&!d.k_none||0==d.type)){for(b=d;b.prev;b=b.prev){switch(b.prev.type){case 5:case 0:continue}break}h.last_sym=b.prev;ya(a);a.next=b;b.prev=a;h.last_sym=d}else ya(a);a.clef_small=!0}}function He(a){var d,b,c=x.length;if(1==c&&x[0]["default"]&&
(x[0]["default"]=!1,!x[0].last_sym))return d=x[0],d.id=a,k.transp&&2<=v.state&&(a=h,h=d,Ie(),h=a),d;for(b=0;b<c;b++)if(d=x[b],d.id==a)return d;d={v:b,id:a,pos:{dyn:0,gch:0,gst:0,orn:0,stm:0,voc:0,vol:0},scale:1,combine:0,ulen:oa.ulen,dur_fact:1,key:T(v.ckey),ckey:T(v.ckey),okey:T(v.okey),meter:T(oa.meter),wmeasure:oa.meter.wmeasure,clef:{type:1,clef_auto:!0,clef_type:"a",time:0},hy_st:0,instr:oa.instr||0};x.push(d);E.voices[b]={range:-1};return d}function pi(){M=-1;x=[];h=null;Zi(!0);Ac=-1;D={};xa=
[];Bb={}}function nb(a){var d,b={type:12,dur:0,sy:E};v.state=3;0==x.length?(h=He("1"),h.clef.istart=h.key.istart,h.clef.iend=h.key.iend,h["default"]=!0):h||(h=x[0>Ac?0:E.top_voice]);h.init||a||(Ge([]),Ie());for(a=0;a<x.length;a++)d=x[a],d.ulen=oa.ulen,d.key.k_bagpipe&&!d.pos.stm&&(d.pos=T(d.pos),d.pos.stm=2);if(0>Ac){M=x.length-1;for(a=0;a<=M;a++)d=x[a],d.time=0,d.clef.time=0,d.st=d.cst=E.voices[a].st=E.voices[a].range=a,E.staves[a]={stafflines:"|||||",staffscale:1};E.nstaff=M}d=h;h=x[E.top_voice];
ya(b);0>Ac&&(b["default"]=!0);h=d}function Cj(a,d){var b,c,e,f,g;if(!h.ignore){if(d){if(b=h.sym_cont,!b){y(1,"+: symbol line without music");return}}else if(h.sym_restart?(h.sym_start=b=h.sym_restart,h.sym_restart=null):b=h.sym_start,b||(b=h.sym),!b){y(1,"s: without music");return}for(e=0;;){for(;" "==a[e]||"\t"==a[e];)e++;c=a[e];if(!c)break;switch(c){case "|":for(;b&&0!=b.type;)b=b.next;if(!b){y(1,"Not enough measure bars for symbol line");return}b=b.next;e++;continue;case "!":case '"':f=++e;e=a.indexOf(c,
f);if(0>e){y(1,"!"==c?"No end of decoration":"No end of guitar chord");e=a.length;continue}g=a.slice(f-1,e+1);break;case "*":break;default:g=c.charCodeAt(0);if(128>g&&(g=wb[g],1<g.length&&("!"==g[0]||'"'==g[0]))){c=g[0];break}y(1,"Bad character '$1'",c)}for(;b&&(8!=b.type||b.grace);)b=b.next;if(!b){y(1,"Too many elements in symbol line");return}switch(c){case "!":lf([g.slice(1,-1)],b,b.prev);break;case '"':Bc=b.a_gch,Li(g),Bc&&Je(b)}b=b.next;e++}h.lyric_cont=b}}function Dj(a,d){var b,c,e,f;if(!h.ignore){4!=
h.pos.voc&&(h.have_ly=!0);if(d){if(b=h.lyric_cont,!b){y(1,"+: lyric without music");return}}else if(Na("vocal"),h.lyric_restart?(h.lyric_start=b=h.lyric_restart,h.lyric_restart=null,h.lyric_line=0):(h.lyric_line++,b=h.lyric_start),b||(b=h.sym),!b){y(1,"w: without music");return}for(e=0;;){for(;" "==a[e]||"\t"==a[e];)e++;if(!a[e])break;f=v.istart+e+2;switch(a[e]){case "|":for(;b&&0!=b.type;)b=b.next;if(!b){y(1,"Not enough measure bars for lyric line");return}b=b.next;e++;continue;case "-":c="-\n";
break;case "_":c="_\n";break;case "*":c="";break;default:if("\\"==a[e]&&e==a.length-1){h.lyric_cont=b;return}for(c="";a[e];){switch(a[e]){case "_":case "*":case "|":e--;case " ":case "\t":break;case "~":c+=" ";e++;continue;case "-":c+="\n";break;case "\\":c+=a[++e];e++;continue;default:c+=a[e++];continue}break}}for(;b&&(8!=b.type||b.grace);)b=b.next;if(!b){y(1,"Too many words in lyric line");return}c&&4!=b.pos.voc&&(c.match(/^\$\d/)&&("0"==c[1]?Na("vocal"):Na("u"+c[1]),c=c.slice(2)),c={t:c,font:D.curfont,
w:lb(c),istart:f,iend:f+c.length},b.a_ly||(b.a_ly=[]),b.a_ly[h.lyric_line]=c);b=b.next;e++}h.lyric_cont=b}}function wi(a,d){var b,c,e,f,g,h,k,n,m=a.a_ly;for(k=f=0;k<m.length;k++)if(b=m[k]){n=b.t;h=b.w;e=b.font.swfac;g=h+2*uc(" ")*e;4==a.type?h=a.wl:"0"<=n[0]&&"9">=n[0]&&2<n.length||":"==n[1]||"("==n[0]||")"==n[0]?("("==n[0]?c=uc("(")*e:(c=n.indexOf(" "),D.curfont=D.deffont=b.font,c=0<c?lb(n.slice(0,c)):h),h=.4*(h-c+2*uc(" ")*e),20<h&&(h=20),h+=c,"0"<=b.t[0]&&"9">=b.t[0]&&h>f&&(f=h)):"-\n"==n||"_\n"==
n?h=0:(h=.4*g,20<h&&(h=20));b.shift=h;d<h&&(d=h);g-=h;h=2*uc(" ")*e;for(b=a.next;b;b=b.next){switch(b.type){case 8:case 10:if(b.a_ly&&b.a_ly[k]&&0!=b.a_ly[k].w)if("-\n"==b.a_ly[k].t||"_\n"==b.a_ly[k].t)g-=h;else break;else g-=9;if(0>=g)break;continue;case 1:case 6:case 5:g-=10;continue;default:g-=5}break}g>a.wr&&(a.wr=g)}if(0<f)for(k=0;k<m.length;k++)(b=m[k])&&"0"<=b.t[0]&&"9">=b.t[0]&&(b.shift=f);return d}function kj(a,d,b){var c,e,f,g,h,q,n,m,r,p;a.hy_st&1<<d&&(n=!0,a.hy_st&=~(1<<d));for(g=a.sym;1==
g.type||5==g.type||6==g.type;g=g.next);e=g.prev?g.prev.x:Q.x;for(r=0;g;g=g.next)if(q=g.a_ly?g.a_ly[d]:null)if(q.font!=D.curfont&&(D.curfont=q.font),c=q.t,f=q.w,p=q.shift,n&&("_\n"==c?c="-\n":"-\n"!=c&&(Ri(e,b,g.x-p-e),n=!1,e=g.x+g.wr)),m&&"_\n"!=c&&(Qe(e+3,b,r-e+3),m=!1,e=g.x+g.wr),"-\n"==c||"_\n"==c)0==r&&e>g.x-18&&(e=g.x-18),"-"==c[0]?n=!0:m=!0,r=g.x-p;else{r=g.x-p;"\n"==c.slice(-1)&&(c=c.slice(0,-1),n=!0);if(R.anno_start||R.anno_stop)h={st:g.st,istart:q.istart,iend:q.iend,x:r,y:b,ymn:b,ymx:b+D.curfont.size,
wl:0,wr:f},Tb(h,"lyrics");ja(r,b,c);Ub(h,"lyrics");e=r+f}else switch(g.type){case 10:case 7:m&&(Qe(e+3,b,r-e),m=!1,e=g.x+g.wr)}n&&(r=Ca-10,r<e+10&&(r=e+10),Ri(e,b,r-e),k.hyphencont&&(a.hy_st|=1<<d));for(a.s_next;g;g=g.next)if(8==g.type){if(!g.a_ly)break;(q=g.a_ly[d])&&"_\n"==q.t&&(m=!0,r=Ca-15,r<e+12&&(r=e+12));break}m&&Qe(e+3,b,r-e+3)}function aj(a,d,b,c,e){var f=r[a.st].staffscale;Na("vocal");if(0<e){c>-k.vocalspace&&(c=-k.vocalspace);c+=b[0]/6;c*=f;for(e=0;e<d;e++)c-=1.1*b[e],kj(a,e,c);return(c-
b[e-1]/6)/f}e=r[a.st].topbar+k.vocalspace;c<e&&(c=e);c+=b[d-1]/6;c*=f;for(e=d;0<=--e;)kj(a,e,c),c+=1.1*b[e];return c/f}function Li(a){function d(){for(var a="";;){b=c[l++];if(0>"1234567890.-".indexOf(b))return parseFloat(a);a+=b}}var b,c,e,f,g,l,k,n,m=Xc("annotation").size;e=v.line;k=v.bol+e.index;if(1<a.length)c=a.slice(1,-1),n=k+1;else{for(c="";;){b=e.next_char();if(!b){y(1,"No end of guitar chord");return}if('"'==b)break;"\\"==b&&(c+=b,b=e.next_char());c+=b}n=v.bol+e.index+1}if(4!=h.pos.gch)for(l=
0,a="g";;){b=c[l];if(!b)break;e={text:"",istart:k,iend:n};switch(b){case "@":a=b;l++;f=d();","!=b?(y(1,"',' lacking in annotation '@x,y'"),g=0):(g=d()," "!=b&&l--);break;case "^":case "_":case "<":case ">":l++,a=b}e.type=a;"@"==a&&(e.x=f,e.y=g,g-=m);for(;;){b=c[l];if(!b)break;switch(b){case "\\":b=c[++l];if(!b||"n"==b)break;e.text+="\\";default:e.text+=b;l++;continue;case "&":for(;;){e.text+=b;b=c[++l];switch(b){default:continue;case ";":case void 0:case "\\":}break}if(";"==b){e.text+=b;continue}case ";":}l++;
break}Bc||(Bc=[]);Bc.push(e)}}function Zj(a){function d(a){var b,c,d,f,h;b=0;switch(a[0]){case "A":c=5;break;case "B":c=6;break;case "C":c=0;break;case "D":if("o"==a[1]){b++;c=0;break}c=1;break;case "E":c=2;break;case "F":"a"==a[1]&&b++;c=3;break;case "G":c=4;break;case "L":b++;c=5;break;case "M":b++;c=2;break;case "R":b++;"e"!=a[1]&&b++;c=1;break;case "S":b++;"o"==a[1]?(b++,c=4):c=6;break;case "/":b--;break;default:return a}f=0;h=b+1;0<=b?("#"==a[h]?(f++,h++,"#"==a[h]&&(f++,h++)):"b"==a[h]?(f--,
h++,"b"==a[h]&&(f--,h++)):"="==a[h]&&h++,f=kg[c]+e+7*f,c=ud[(f+112)%7],d=(((f+22)/7|0)+159)%5,b=0==b?Uf[c]+Vf[d]:ak[c]+Vf[d]):b="";d=a.indexOf("/",h);if(0>d)return b+a.slice(h);c=Uf.indexOf(a[++d]);if(0>c)return b+a.slice(h);b+=a.slice(h,d);f=0;"#"==a[++d]?(f++,"#"==a[++d]&&(f++,d++)):"b"==a[d]&&(f--,"b"==a[++d]&&(f--,d++));f=kg[c]+e+7*f;c=ud[(f+112)%7];return b+Uf[c]+Vf[(((f+1+21)/7|0)+2-3+160)%5]+a.slice(d)}for(var b,c=0,e=h.ckey.k_sf-h.okey.k_sf;;){b=a.a_gch[c++];if(!b)return;if("g"==b.type)break}a=
b.text;c=a.indexOf("\t");0<=c&&(c++,a=a.slice(0,c)+d(a.slice(c)));b.text=d(a)}function Je(a){var d,b,c,e=2==h.pos.gch?-1:1,f=Xc("gchord"),g=Xc("annotation"),l=0,q=0,n=0,m=0,r=f.size,p=g.size,u=k.gchordbox;a.a_gch=Bc;Bc=null;h.vtransp&&Zj(a);for(c=0;c<a.a_gch.length;c++){d=a.a_gch[c];if("g"==d.type)d.text=d.text.replace(/##|#|=|bb|b/g,function(a){switch(a){case "##":return"&#x1d12a;";case "#":return"\u266f";case "=":return"\u266e";case "b":return"\u266d"}return"&#x1d12b;"}),d.font=f;else if(d.text=
zc(d.text),d.font=g,"@"==d.type&&!R.anno_start)continue;D.curfont=d.font;b=lb(d.text);d.w=b;switch(d.type){case "@":break;case "^":b*=.4;8<b&&(b=8);d.x=-b;l-=p;d.y=l;break;case "_":b*=.4;8<b&&(b=8);d.x=-b;q-=p;d.y=q;break;case "<":d.x=-(b+6);n-=p;d.y=n;break;case ">":d.x=6;m-=p;d.y=m;break;default:d.box=u,b*=.4,8<b&&(b=8),d.x=-b,0>e?(q-=r,d.y=q,u&&(q-=2,--d.y)):(l-=r,d.y=l,u&&(l-=2,--d.y))}}n/=2;m/=2;for(c=0;c<a.a_gch.length;c++)switch(d=a.a_gch[c],d.type){case "^":d.y-=l;break;case "<":d.y-=n;break;
case ">":d.y-=m;break;case "g":0<e&&(d.y-=l)}}function lj(a){function d(a,c,d,f,g){var b=Wb.getorig();Wb.ps_flush();a((c+b[0])*z.scale,d-b[1],f,g)}Wb||"function"!=typeof Psvg||(Abc.prototype.arpps=function(a,c,e){d(Ti,c,e,a)},Abc.prototype.ltrps=function(a,c,e){d(Ui,c,e,a)},Abc.prototype.xyglsps=function(a,c,e,f){d(Si,c,e,f,a)},Abc.prototype.xyglvps=function(a,c,e,f){d(Mh,c,e,f,a)},Abc.prototype.xyglps=function(a,c,e){d(ia,a,c,e)},Abc.prototype.get_y=function(a,c){return c+r[a].y},Abc.prototype.set_ps=
function(a,c){hj=a;Ng=c},Abc.prototype.stv_g=z,Abc.prototype.psget_x=function(){return fc/z.scale},Abc.prototype.psget_y=function(){return z.started?z.dy:Da},Wb=new Psvg(a))}this.user=R;var oa={meter:{type:6,wmeasure:1,a_meter:[]}},L={},Zc={},$c=new Int8Array(128),v={ctx:{},prefix:"%",state:0,line:new hb},Wb,nd={},xa,Bb,Lg={dot:"0 stc 5 1 1",tenuto:"0 emb 5 2 2",slide:"1 sld 3 7 0",arpeggio:"2 arp 12 10 0",roll:"3 roll 7 6 6",fermata:"3 hld 12 7 7",emphasis:"3 accent 7 4 4",lowermordent:"3 lmrd 10 2 2",
coda:"3 coda 24 10 10",uppermordent:"3 umrd 10 2 2",segno:"3 sgno 20 8 8",trill:"3 trl 14 4 4",upbow:"3 upb 10 5 5",downbow:"3 dnb 9 5 5",gmark:"3 grm 6 5 5",wedge:"3 wedge 8 1 1",turnx:"3 turnx 10 0 5",breath:"3 brth 0 1 20",longphrase:"3 lphr 0 1 1",mediumphrase:"3 mphr 0 1 1",shortphrase:"3 sphr 0 1 1",invertedfermata:"3 hld 12 7 7",invertedturn:"3 turn 10 0 5",invertedturnx:"3 turnx 10 0 5",0:"3 fng 8 3 3 0",1:"3 fng 8 3 3 1",2:"3 fng 8 3 3 2",3:"3 fng 8 3 3 3",4:"3 fng 8 3 3 4",5:"3 fng 8 3 3 5",
plus:"3 dplus 7 3 3","+":"3 dplus 7 3 3",accent:"3 accent 6 4 4",">":"3 accent 6 4 4",marcato:"3 marcato 9 3 3","^":"3 marcato 9 3 3",mordent:"3 lmrd 10 2 2",open:"3 opend 10 2 2",snap:"3 snap 14 3 3",thumb:"3 thumb 14 2 2","D.C.":"3 dacs 16 10 10 D.C.","D.S.":"3 dacs 16 10 10 D.S.",fine:"3 dacs 16 10 10 FINE",turn:"3 turn 10 0 5","trill(":"3 ltr 8 0 0","trill)":"3 ltr 8 0 0",f:"6 pf 18 1 7",ff:"6 pf 18 2 10",fff:"6 pf 18 4 13",ffff:"6 pf 18 6 16",mf:"6 pf 18 6 13",mp:"6 pf 18 6 16",p:"6 pf 18 2 8",
pp:"6 pf 18 5 14",ppp:"6 pf 18 8 20",pppp:"6 pf 18 10 25",pralltriller:"3 umrd 10 2 2",sfz:'6 sfz 18 4 10 ""',ped:"4 ped 20 0 0","ped-up":"4 pedoff 20 0 0","crescendo(":"7 cresc 18 0 0","crescendo)":"7 cresc 18 0 0","<(":"7 cresc 18 0 0","<)":"7 cresc 18 0 0","diminuendo(":"7 dim 18 0 0","diminuendo)":"7 dim 18 0 0",">(":"7 dim 18 0 0",">)":"7 dim 18 0 0","-(":"8 gliss 0 0 0","-)":"8 gliss 0 0 0","~(":"8 glisq 0 0 0","~)":"8 glisq 0 0 0","8va(":"3 8va 10 0 0","8va)":"3 8va 10 0 0","8vb(":"4 8vb 10 0 0",
"8vb)":"4 8vb 10 0 0","15ma(":"3 15ma 10 0 0","15ma)":"3 15ma 10 0 0","15mb(":"4 15mb 10 0 0","15mb)":"4 15mb 10 0 0",invisible:"32 0 0 0 0",beamon:"33 0 0 0 0",trem1:"34 0 0 0 0",trem2:"34 0 0 0 0",trem3:"34 0 0 0 0",trem4:"34 0 0 0 0",xstem:"35 0 0 0 0",beambr1:"36 0 0 0 0",beambr2:"36 0 0 0 0",rbstop:"37 0 0 0 0","/":"38 0 0 6 6","//":"38 0 0 6 6","///":"38 0 0 6 6","beam-accel":"39 0 0 0 0","beam-rall":"39 0 0 0 0",stemless:"40 0 0 0 0",rbend:"41 0 0 0 0"},nj=[!0,!0,!0],Xj=[!1,!1,!1,!0,!0,!0,
!1,!1,!0],af=[!1,!1,!1,!1,!1,!1,!0,!0],we={},Ah=[function(a){var d,b,c=a.s,e=a.dd;e.str||(d=(b=c.multi?0<c.multi:0>c.stem)?c.ymx|0:c.ymn-e.h|0,-6<d&&24>d&&(b&&(d+=3),d=6*((d+6)/6|0)-6),b?c.ymx=d+e.h:c.ymn=d,a.y=d,8==c.type&&(a.x+=c.notes[0<=c.stem?0:c.nhd].shhd),"d"==e.name[0]&&-1<=c.nflags&&(b?0<c.stem&&(a.x+=3.5):0>c.stem&&(a.x-=3.5)))},function(a){var d,b,c=a.s,e=c.notes[0].pit,f=5;for(d=0;d<=c.nhd;d++){if(c.notes[d].acc)b=4+c.notes[d].shac;else switch(b=5-c.notes[d].shhd,c.head){case 4:b+=3.5;
break;case 3:case 2:b+=2}c.notes[d].pit<=e+3&&b>f&&(f=b)}a.x-=f;a.y=3*(e-18)},function(a){var d,b,c=a.s,e=a.dd,f=5;if(8==c.type)for(d=0;d<=c.nhd;d++){if(c.notes[d].acc)b=5+c.notes[d].shac;else switch(b=6-c.notes[d].shhd,c.head){case 4:b+=3.5;break;case 3:case 2:b+=2}b>f&&(f=b)}b=3*(c.notes[c.nhd].pit-c.notes[0].pit)+4;d=e.h;b<d&&(b=d);a.has_val=!0;a.val=b;a.x-=f;a.y=3*(c.notes[0].pit-18)-3},Jg,Jg,Ig,function(a){var d,b,c,e=a.s,f=a.dd,g;a.val=f.wl+f.wr;if(c=Wf(e,e.pos.vol))a.up=!0;b=e.x-f.wl;0<a.ix&&
(g=xa[a.ix-1],g.s==e&&(a.up&&!g.up||!a.up&&g.up)&&(d=g.dd,af[d.func]&&(d=g.x+g.val+4,d>b&&(b=d))));a.x=b;a.y=wa(e.st,c,b,a.val);c||(a.y-=f.h)},function(a){if(!a.ldst){var d,b,c,e,f,g=a.s;e=a.start;d=e.s;b=d.x+3;e=e.ix;0<e&&(f=xa[e-1]);a.st=g.st;a.lden=!1;a.has_val=!0;if(e=Wf(g,g.pos.dyn))a.up=!0;f&&f.s==d&&(a.up&&!f.up||!a.up&&f.up)&&(c=f.dd,af[c.func]&&(f=f.x+f.val+4,f>b&&(b=f)));a.defl.noen?(d=a.x-b,20>d&&(b=a.x-20-3,d=20)):(f=g.x,(g=xa[a.ix+1])&&g.s==d&&(a.up&&!g.up||!a.up&&g.up)&&(c=g.dd,af[c.func]&&
(f-=5)),d=f-b-4,20>d&&(b-=.5*(20-d),d=20));a.val=d;a.x=b;a.y=wa(a.st,e,b,d);e||(b=a.dd,a.y-=b.h)}}],Xf={"8va(":1,"8va)":1,"15ma(":1,"15ma)":1,"8vb(":1,"8vb)":1,"15mb(":1,"15mb)":1},Id=2.3,pj=[[16,16,14,12,10,10],[14,14,10,9,9,9]],bj=new Int8Array([24,9,15,21,6,12,18]),ej=new Int8Array([12,18,24,9,15,21,6]),cj=new Int8Array([-9,12,-9,-9,12,-9]),dj=new Int8Array([12,-9,12,-9,12,-9]),fj=new Int8Array([9,-12,9,-12,9,-12]),gj=new Int8Array([-12,9,-12,9,-12,9]),Yj="r128 r64 r32 r16 r8 r4 r2 r1 r0 r00".split(" "),
xd='url("data:application/font-woff;base64,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")',
hg={},wc={},xj=1,hi={serif:1.05,serifBold:1.05,"sans-serif":1.1,"sans-serifBold":1.15,Palatino:1.1,Mono:1.35},ki={},k={aligncomposer:1,breaklimit:.7,breakoneoln:!0,cancelkey:!0,composerspace:6,dblrepbar:":][:",decoerr:!0,dynalign:!0,fullsvg:"",gracespace:[6.5,8,12],graceslurs:!0,hyphencont:!0,indent:0,infoname:'R "Rhythm: "\nB "Book: "\nS "Source: "\nD "Discography: "\nN "Notes: "\nZ "Transcription: "\nH "History: "',infospace:0,keywarn:!0,leftmargin:1.4*37.8,lineskipfac:1.1,linewarn:!0,maxshrink:.65,
maxstaffsep:2E3,maxsysstaffsep:2E3,measurefirst:1,measurenb:-1,musicspace:6,parskipfac:.4,partsspace:8,pagewidth:793.8,"print-leftmargin":0,rightmargin:1.4*37.8,rbdbstop:!0,rbmax:4,rbmin:2,scale:1,slurheight:1,staffnonote:1,staffsep:46,stemheight:21,stretchlast:.25,stretchstaff:!0,subtitlespace:3,sysstaffsep:34,textspace:14,titlespace:6,titletrim:!0,topspace:22,tuplets:[0,0,0,0],vocalspace:10,writefields:"CMOPQsTWw",wordsspace:5};Abc.prototype.get_fmt=function(a){return k[a]};var gg={align:"j",center:"c",
fill:"f",justify:"j",ragged:"f",right:"r",skip:"s"},qd={above:1,auto:0,below:2,down:2,hidden:4,opposite:4,up:1};Abc.prototype.style_font=li;var yj={"`A":"\u00c0","`E":"\u00c8","`I":"\u00cc","`O":"\u00d2","`U":"\u00d9","`a":"\u00e0","`e":"\u00e8","`i":"\u00ec","`o":"\u00f2","`u":"\u00f9","'A":"\u00c1","'E":"\u00c9","'I":"\u00cd","'O":"\u00d3","'U":"\u00da","'Y":"\u00dd","'a":"\u00e1","'e":"\u00e9","'i":"\u00ed","'o":"\u00f3","'u":"\u00fa","'y":"\u00fd","'S":"\u015a","'Z":"\u0179","'s":"\u015b","'z":"\u017a",
"'R":"\u0154","'L":"\u0139","'C":"\u0106","'N":"\u0143","'r":"\u0155","'l":"\u013a","'c":"\u0107","'n":"\u0144","^A":"\u00c2","^E":"\u00ca","^I":"\u00ce","^O":"\u00d4","^U":"\u00db","^a":"\u00e2","^e":"\u00ea","^i":"\u00ee","^o":"\u00f4","^u":"\u00fb","^H":"\u0124","^J":"\u0134","^h":"\u0125","^j":"\u0135","^C":"\u0108","^G":"\u011c","^S":"\u015c","^c":"\u0109","^g":"\u011d","^s":"\u015d",",C":"\u00c7",",c":"\u00e7",",S":"\u015e",",s":"\u015f",",T":"\u0162",",t":"\u0163",",R":"\u0156",",L":"\u013b",
",G":"\u0122",",r":"\u0157",",l":"\u013c",",g":"\u0123",",N":"\u0145",",K":"\u0136",",n":"\u0146",",k":"\u0137",'"A':"\u00c4",'"E':"\u00cb",'"I':"\u00cf",'"O':"\u00d6",'"U':"\u00dc",'"Y':"\u0178",'"a':"\u00e4",'"e':"\u00eb",'"i':"\u00ef",'"o':"\u00f6",'"u':"\u00fc",'"y':"\u00ff","~A":"\u00c3","~N":"\u00d1","~O":"\u00d5","~a":"\u00e3","~n":"\u00f1","~o":"\u00f5","~I":"\u0128","~i":"\u0129","~U":"\u0168","~u":"\u0169",oA:"\u00c5",oa:"\u00e5",oU:"\u016e",ou:"\u016f","=A":"\u0100","=D":"\u0110","=E":"\u0112",
"=H":"\u0126","=I":"\u012a","=O":"\u014c","=T":"\u0166","=U":"\u016a","=a":"\u0101","=d":"\u0111","=e":"\u0113","=h":"\u0127","=i":"\u012b","=o":"\u014d","=t":"\u0167","=u":"\u016b","/O":"\u00d8","/o":"\u00f8","/D":"\u0110","/d":"\u0111","/L":"\u0141","/l":"\u0142",";A":"\u0104",";E":"\u0118",";I":"\u012e",";U":"\u0172",";a":"\u0105",";e":"\u0119",";i":"\u012f",";u":"\u0173",vL:"\u013d",vS:"\u0160",vT:"\u0164",vZ:"\u017d",vl:"\u013e",vs:"\u0161",vt:"\u0165",vz:"\u017e",vC:"\u010c",vE:"\u011a",vD:"\u010e",
vN:"\u0147",vR:"\u0158",vc:"\u010d",ve:"\u011b",vd:"\u010f",vn:"\u0148",vr:"\u0159",uA:"\u0102",ua:"\u0103",uE:"\u0114",ue:"\u0115",uG:"\u011e",ug:"\u011f",uI:"\u012c",ui:"\u012d",uO:"\u014e",uo:"\u014f",uU:"\u016c",uu:"\u016d",":O":"\u0150",":U":"\u0170",":o":"\u0151",":u":"\u0171",".Z":"\u017b",".z":"\u017c",".I":"\u0130",".i":"\u0131",".C":"\u010a",".c":"\u010b",".G":"\u0120",".g":"\u0121",".E":"\u0116",".e":"\u0117",AA:"\u00c5",aa:"\u00e5",AE:"\u00c6",ae:"\u00e6",cc:"\u00e7",cC:"\u00c7",DH:"\u00d0",
dh:"\u00f0",ng:"\u014b",OE:"\u0152",oe:"\u0153",ss:"\u00df",TH:"\u00de",th:"\u00fe"},Ae=0,nf="$1: inside tune - ignored",xc="Bad value in $1";Abc.prototype.tosvg=ni;var D,r,M,ic,Ca,De,le,jc=new Float32Array([7,10,14.15,20,28.3,40,56.6,80,113,150]),pf,si=new Float32Array([10,10,11,13,13]),Ej=new Float32Array([4.5,5,6,7,8]),Tg=new Float32Array([3.5,3.7,5,6,7]),$i="Not enough notes/rests for %%repeat",Oh="Not enough measures for %%repeat",Ai={t:-4,c:0,b:4,p:-6},Bi=[[18,18],[12,18],[12,12],[0,12],[6,
8],[10,10],[6,4],[10,0],[10,4],[10,10]],bb=96,Bc,za,Ya,kc={},Fe="Not an ASCII character",Mi="Cannot have a bar in grace notes",Qj=new Int8Array([0,1,3,2,3,0,2,0,3,0]),uf="CDEFGABcdefgab",Kj=new Int8Array([0,2,4,5,7,9,11]),bd="Misplaced '$1' in %%staves",Ke=/(\d*)(\/*)(\d*)/g,kg=new Int8Array([0,2,4,-1,1,3,5]),ud=new Int8Array([0,4,1,5,2,6,3]),Oj=new Int8Array([-2,-1,3,1,2]),I=["0"],wb=[I,I,I,I,I,I,I,I,I," ","\n",I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I,I," ","!",'"',I,"\n",I,"&",I,"(",")",I,I,I,"-",
"!dot!",I,I,I,I,I,I,I,I,I,I,I,"|",I,"<","n","<",I,I,"n","n","n","n","n","n","n","!fermata!","d","d","d","!emphasis!","!lowermordent!","d","!coda!","!uppermordent!","d","d","!segno!","!trill!","d","d","d","n","d","n","[","\\","|","n","n","i","n","n","n","n","n","n","n","d","d","d","d","d","d","d","d","d","d","d","d","d","!upbow!","!downbow!","d","n","n","n","{","|","}","!roll!",I],Rj=new Float32Array([.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.25,
.333,.408,.5,.5,.833,.778,.333,.333,.333,.5,.564,.25,.564,.25,.278,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.278,.278,.564,.564,.564,.444,.921,.722,.667,.667,.722,.611,.556,.722,.722,.333,.389,.722,.611,.889,.722,.722,.556,.722,.667,.556,.611,.722,.722,.944,.722,.722,.611,.333,.278,.333,.469,.5,.333,.444,.5,.444,.5,.444,.333,.5,.5,.278,.278,.5,.278,.778,.5,.5,.5,.5,.333,.389,.278,.5,.5,.722,.5,.5,.444,.48,.2,.48,.541,.5]),Mj={A:"info",C:"composer",O:"composer",P:"parts",Q:"tempo",R:"info",T:"title",X:"title"};
Abc.prototype.header_footer=function(a){var d,b,c=0,e=["","",""];'"'==a[0]&&(a=a.slice(1,-1));0>a.indexOf("\t")&&(a="\t"+a);for(b=0;b<a.length;b++){d=a[b];switch(d){case "\t":2>c&&c++;continue;case "\\":for(c=0;3>c;c++)e[c]&&(e[c]+="\n");c=0;b++;continue;default:e[c]+=d;continue;case "$":}d=a[++b];switch(d){case "D":e[c]+=(new Date).toUTCString();break;case "F":e[c]+=v.ctx.fname;break;case "I":d=a[++b];case "T":L[d]&&(e[c]+=L[d]);break;case "P":e[c]+="\f";break;case "V":e[c]+="abc2svg-"+abc2svg.version}}return e};
var A=[],wd="\n.fill {fill: currentColor}\n.stroke {stroke: currentColor; fill: none}\ntext {white-space: pre}\n.music {font-family: music; font-size: 24px; fill: currentColor}\n.music text, .music tspan {fill:currentColor}",ze="",fc=k.leftmargin/k.scale,Da=0,Me={},Rd="",z={scale:1,dy:0,st:-1,v:0,g:0},lc={},Vj={sgno:{x:-6,y:4,c:"\ue047"},coda:{x:-12,y:6,c:"\ue048"},tclef:{x:-8,y:0,c:"\ue050"},cclef:{x:-8,y:0,c:"\ue05c"},bclef:{x:-8,y:0,c:"\ue062"},pclef:{x:-6,y:0,c:"\ue069"},stclef:{x:-8,y:0,c:"\ue07a"},
scclef:{x:-8,y:0,c:"\ue07b"},sbclef:{x:-7,y:0,c:"\ue07c"},csig:{x:0,y:0,c:"\ue08a"},ctsig:{x:0,y:0,c:"\ue08b"},HDD:{x:-7,y:0,c:"\ue0a0"},breve:{x:-6,y:0,c:"\ue0a1"},HD:{x:-5.2,y:0,c:"\ue0a2"},Hd:{x:-3.8,y:0,c:"\ue0a3"},hd:{x:-3.7,y:0,c:"\ue0a4"},srep:{x:-5,y:0,c:"\ue101"},dot:{x:-2,y:0,c:"\ue1e7"},"acc-1":{x:-3,y:0,c:"\ue260"},acc3:{x:-2,y:0,c:"\ue261"},acc1:{x:-3,y:0,c:"\ue262"},acc2:{x:-3,y:0,c:"\ue263"},pshhd:{x:-3,y:0,c:"\ue263"},"acc-2":{x:-3,y:0,c:"\ue264"},accent:{x:-3,y:0,c:"\ue4a0"},marcato:{x:-3,
y:0,c:"\ue4ac"},hld:{x:-7,y:0,c:"\ue4c0"},r00:{x:-1.5,y:0,c:"\ue4e1"},r0:{x:-1.5,y:0,c:"\ue4e2"},r1:{x:-3.5,y:6,c:"\ue4e3"},r2:{x:-3.2,y:0,c:"\ue4e4"},r4:{x:-3,y:0,c:"\ue4e5"},r8:{x:-3,y:0,c:"\ue4e6"},r16:{x:-4,y:0,c:"\ue4e7"},r32:{x:-4,y:0,c:"\ue4e8"},r64:{x:-4,y:0,c:"\ue4e9"},r128:{x:-4,y:0,c:"\ue4ea"},mrest:{x:-10,y:0,c:"\ue4ee"},mrep:{x:-6,y:0,c:"\ue500"},mrep2:{x:-9,y:0,c:"\ue501"},turn:{x:-5,y:4,c:"\ue567"},umrd:{x:-7,y:2,c:"\ue56c"},lmrd:{x:-7,y:2,c:"\ue56d"},ped:{x:-10,y:0,c:"\ue650"},pedoff:{x:-5,
y:0,c:"\ue655"},longa:{x:-6,y:0,c:"\ue95c"}},Qd={brace:'<text id="brace">\ue000</text>',ghd:'<g id="ghd" transform="translate(4.5,0) scale(0.66)">\n\t<text x="-3.7">\ue0a4</text>\n</g>',acc1_1_4:'<g id="acc1_1_4">\n\t<path d="m0 7.8v-15.4" class="stroke"/>\n\t<path class="fill" d="M-1.8 2.7l3.6 -1.1v2.2l-3.6 1.1v-2.2z\n\t\tM-1.8 -3.7l3.6 -1.1v2.2l-3.6 1.1v-2.2"/>\n</g>',acc1_3_4:'<g id="acc1_3_4">\n\t<path d="m-2.5 8.7v-15.4M0 7.8v-15.4M2.5 6.9v-15.4" class="stroke"/>\n\t<path class="fill" d="m-3.7 3.1l7.4 -2.2v2.2l-7.4 2.2v-2.2z\n\t\tM-3.7 -3.2l7.4 -2.2v2.2l-7.4 2.2v-2.2"/>\n</g>',
"acc-1_1_4":'<g id="acc-1_1_4" transform="scale(-1,1)">\n\t<text x="-3">\ue260</text>\n</g>',"acc-1_3_4":'<g id="acc-1_3_4">\n    <path class="fill" d="m0.6 -2.7\n\tc-5.7 -3.1 -5.7 3.6 0 6.7c-3.9 -4 -4 -7.6 0 -5.8\n\tM1 -2.7c5.7 -3.1 5.7 3.6 0 6.7c3.9 -4 4 -7.6 0 -5.8"/>\n    <path d="m1.6 3.5v-13M0 3.5v-13" class="stroke" stroke-width=".6"/>\n</g>',turnx:'<g id="turnx">\n\t<text x="-5" y="-4">\ue567</text>\n\t<path class="stroke" d="m0 -1.5v-9"/>\n</g>',pfthd:'<g id="pfthd">\n\t<text x="-3">\ue263</text>\n\t<circle r="4" class="stroke"/>\n</g>',
pmsig:'<path id="pmsig" class="stroke" stroke-width="0.8"\n\td="m0 -7a5 5 0 0 1 0 -10a5 5 0 0 1 0 10"/>',pMsig:'<g id="pMsig">\n\t<use xlink:href="#pmsig"/>\n\t<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',imsig:'<path id="imsig" class="stroke" stroke-width="0.8"\n\td="m3 -8a5 5 0 1 1 0 -8"/>',iMsig:'<g id="iMsig">\n\t<use xlink:href="#imsig"/>\n\t<path class="fill" d="m0 -10a2 2 0 0 1 0 -4a2 2 0 0 1 0 4"/>\n</g>',hl:'<path id="hl" class="stroke" stroke-width="1" d="m-6 0h12"/>',
hl1:'<path id="hl1" class="stroke" stroke-width="1" d="m-7 0h14"/>',hl2:'<path id="hl2" class="stroke" stroke-width="1" d="m-9 0h18"/>',ghl:'<path id="ghl" class="stroke" d="m-3.5 0h7"/>',rdots:'<g id="rdots" class="fill">\n\t<circle cx="0" cy="-9" r="1.2"/>\n\t<circle cx="0" cy="-15" r="1.2"/>\n</g>',grm:'<path id="grm" class="fill" d="m-5 -2.5\n\tc5 -8.5 5.5 4.5 10 -2\n\t-5 8.5 -5.5 -4.5 -10 2"/>',stc:'<circle id="stc" class="fill" cx="0" cy="-3" r="1.2"/>',sld:'<path id="sld" class="fill" d="m-7.2 4.8\n\tc1.8 .7 4.5 -.2 7.2 -4.8\n\t-2.1 5 -5.4 6.8 -7.6 6"/>',
emb:'<path id="emb" class="stroke" stroke-width="1.2" stroke-linecap="round"\n\td="m-2.5 -3h5"/>',brth:'<text id="brth" y="-6" style="font:bold italic 30px serif">,</text>',roll:'<path id="roll" class="fill" d="m-6 0\n\tc0.4 -7.3 11.3 -7.3 11.7 0\n\t-1.3 -6 -10.4 -6 -11.7 0"/>',upb:'<path id="upb" class="stroke" d="m-2.6 -9.4\n\tl2.6 8.8\n\tl2.6 -8.8"/>',dnb:'<g id="dnb">\n\t<path d="M-3.2 -2v-7.2m6.4 0v7.2" class="stroke"/>\n\t<path d="M-3.2 -6.8v-2.4l6.4 0v2.4" class="fill"/>\n</g>',dplus:'<path id="dplus" class="stroke" stroke-width="1.7"\n\td="m0 -.5v-6m-3 3h6"/>',
lphr:'<path id="lphr" class="stroke" stroke-width="1.2"\n\td="m0 0v18"/>',mphr:'<path id="mphr" class="stroke" stroke-width="1.2"\n\td="m0 0v12"/>',sphr:'<path id="sphr" class="stroke" stroke-width="1.2"\n\td="m0 0v6"/>',sfz:'<text id="sfz" x="-5" y="-7" style="font:italic 14px serif">\n\ts<tspan font-size="16" font-weight="bold">f</tspan>z</text>',trl:'<text id="trl" x="-2" y="-4"\n\tstyle="font:bold italic 16px serif">tr</text>',opend:'<circle id="opend" class="stroke"\n\tcx="0" cy="-3" r="2.5"/>',
snap:'<path id="snap" class="stroke" d="m-3 -6\n\tc0 -5 6 -5 6 0\n\t0 5 -6 5 -6 0\n\tM0 -5v6"/>',thumb:'<path id="thumb" class="stroke" d="m-2.5 -7\n\tc0 -6 5 -6 5 0\n\t0 6 -5 6 -5 0\n\tM-2.5 -9v4"/>',wedge:'<path id="wedge" class="fill" d="m0 -1l-1.5 -5h3l-1.5 5"/>',ltr:'<path id="ltr" class="fill"\n\td="m0 -.4c2 -1.5 3.4 -1.9 3.9 .4\n\t0.2 .8 .7 .7 2.1 -.4\n\tv0.8c-2 1.5 -3.4 1.9 -3.9 -.4\n\t-.2 -.8 -.7 -.7 -2.1 .4z"/>',custos:'<g id="custos">\n\t<path class="fill" d="m-4 0l2 2.5 2 -2.5 2 2.5 2 -2.5\n\t\t-2 -2.5 -2 2.5 -2 -2.5 -2 2.5"/>\n\t<path class="stroke" d="m3.5 0l5 -7"/>\n</g>',
oct:'<text id="oct" style="font:12px serif">8</text>',clearbg:'<filter id="clearbg">\n\t<feComposite in="SourceGraphic" result="comp"/>\n\t<feFlood flood-color="white" result="flood"/>\n\t<feMerge><feMergeNode in="flood"/><feMergeNode in="comp"/></feMerge>\n</filter>'},Pi="bar clef custos  grace key meter Zrest note part rest yspace staves Break tempo  block remark".split(" "),Tb=R.anno_start?Tj:Qi,Ub=R.anno_stop?Uj:Qi;Abc.prototype.out_svg=function(a){A.push(a)};Abc.prototype.sx=vf;Abc.prototype.sy=
Pe;Abc.prototype.out_sxsy=vc;Abc.prototype.xypath=xe;var Wj={crdc:{dx:0,dy:5,style:"font:italic 14px serif"},dacs:{dx:0,dy:3,style:"font:16px serif",anchor:' text-anchor="middle"'},fng:{dx:0,dy:1,style:"font:8px Bookman",anchor:' text-anchor="middle"'},pf:{dx:0,dy:5,style:"font:bold italic 16px serif"},"@":{dx:0,dy:5,style:"font:12px sans-serif"}},Vi={arp:Ti,cresc:function(a,d,b,c){a+=b;b=-b;Z('<path class="stroke"\n\td="mX YlA ',a,d+5,b);c.nost?A.push("-2.2m0 -3.6l"+(-b).toFixed(2)+' -2.2"/>\n'):
A.push("-4l"+(-b).toFixed(2)+' -4"/>\n')},dim:function(a,d,b,c){Z('<path class="stroke"\n\td="mX YlA ',a,d+5,b);c.noen?A.push("-2.2m0 -3.6l"+(-b).toFixed(2)+' -2.2"/>\n'):A.push("-4l"+(-b).toFixed(2)+' -4"/>\n')},ltr:Ui,"8va":function(a,d,b,c){c.nost?b-=5:(Z('<text x="X" y="Y" style="font:italic bold 12px serif">8<tspan dy="-4" style="font-size:10px">va</tspan></text>\n',a-8,d),a+=12,b-=12);d+=6;Z('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',a,d,b);c.noen||Z('<path class="stroke" d="mX Yv6"/>\n',
a+b,d)},"8vb":function(a,d,b,c){c.nost?b-=5:(Z('<text x="X" y="Y" style="font:italic bold 12px serif">8<tspan dy="-4" style="font-size:10px">vb</tspan></text>\n',a-8,d),a+=4,b-=4);Z('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',a,d,b);c.noen||Z('<path class="stroke" d="mX Yv-6"/>\n',a+b,d)},"15ma":function(a,d,b,c){c.nost?b-=5:(Z('<text x="X" y="Y" style="font:italic bold 12px serif">15<tspan dy="-4" style="font-size:10px">ma</tspan></text>\n',a-10,d),a+=20,b-=20);d+=6;Z('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',
a,d,b);c.noen||Z('<path class="stroke" d="mX Yv6"/>\n',a+b,d)},"15mb":function(a,d,b,c){c.nost?b-=5:(Z('<text x="X" y="Y" style="font:italic bold 12px serif">15<tspan dy="-4" style="font-size:10px">mb</tspan></text>\n',a-10,d),a+=7,b-=7);Z('<path class="stroke" stroke-dasharray="6,6" d="mX YhA"/>\n',a,d,b);c.noen||Z('<path class="stroke" d="mX Yv-6"/>\n',a+b,d)}},ij={glisq:function(a,d,b){b=b.start;var c=b.x,e=b.y+r[b.st].y;d=-Math.atan2(d-e,a-c);a=(a-c)/Math.cos(d);cg(c,e,d/Math.PI*180);c=b.s.dots?
13+b.s.xmx:8;a=(a-c-6)/6|0;for(1>a&&(a=1);0<=--a;)ia(c,0,"ltr"),c+=6;dg()},gliss:function(a,d,b){b=b.start;var c=b.x,e=b.y+r[b.st].y;d=-Math.atan2(d-e,a-c);a=(a-c)/Math.cos(d);cg(c,e,d/Math.PI*180);c=b.s.dots?13+b.s.xmx:8;a-=c+8;xe(c,0);A.push("l"+a.toFixed(2)+' 0" stroke-width="1"/>\n');dg()}};Abc.prototype.blk_out=Cb;Abc.prototype.blk_flush=Yc;var E,B,x,h,Ac,ib,Q,Nh=new Uint8Array([2,1,8,0,3,5,6,9,9,0,9,3,0,7,0,0,0,0]),jj="No note in voice overlay",Uf="CDEFGAB",ak="Do R\u00e9 Mi Fa Sol La Si".split(" "),
Vf=["bb","b","","#","##"],hj=function(a,d,b,c){return!1},Ng=function(a,d,b){return!1};Abc.prototype.ps_def=lj;lj(this);ab("annotationfont","sans-serif 12");ab("composerfont","serifItalic 14");ab("footerfont","serif 16");ab("gchordfont","sans-serif 12");ab("headerfont","serif 16");ab("historyfont","serif 16");ab("infofont","serifItalic 14");ab("measurefont","serifItalic 14");ab("partsfont","serif 15");ab("repeatfont","serif 13");ab("subtitlefont","serif 16");ab("tempofont","serifBold 15");ab("textfont",
"serif 16");ab("titlefont","serif 20");ab("vocalfont","serifBold 13");ab("voicefont","serifBold 13");ab("wordsfont","serif 16");pi();for(var vd=0;128>vd;vd++)$c[vd]=0}"object"==typeof module&&"object"==typeof exports&&(exports.abc2svg=abc2svg,exports.Abc=Abc);
